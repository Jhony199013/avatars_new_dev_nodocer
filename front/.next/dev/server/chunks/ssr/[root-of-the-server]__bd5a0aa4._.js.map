{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/servers/UploadAvatar.ts"],"sourcesContent":["\"use server\";\n\nimport { Buffer } from \"buffer\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport interface PhotoAvatarRow {\n  id?: string;\n  uid: string;\n  name: string;\n  photo: string;\n  image_key: string;\n  hey_gen_id: string | null;\n  group_id: string | null;\n  status: \"done\" | \"error\";\n  created_at?: string;\n}\n\ninterface UploadAvatarSuccess {\n  success: true;\n  avatar: PhotoAvatarRow;\n}\n\ninterface UploadAvatarFailure {\n  success: false;\n  error: string;\n}\n\ntype UploadAvatarResult = UploadAvatarSuccess | UploadAvatarFailure;\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\nconst heygenApiKey = process.env.HEYGEN_API_KEY;\n\nif (!supabaseUrl) {\n  throw new Error(\"NEXT_PUBLIC_SUPABASE_URL не задан\");\n}\n\nif (!supabaseServiceRoleKey) {\n  throw new Error(\"SUPABASE_SERVICE_ROLE_KEY не задан\");\n}\n\nconst supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey);\n\nasync function uploadPhotoToHeygen(file: File) {\n  if (!heygenApiKey) {\n    throw new Error(\"HEYGEN_API_KEY не задан\");\n  }\n\n  const buffer = Buffer.from(await file.arrayBuffer());\n  const response = await fetch(\"https://upload.heygen.com/v1/asset\", {\n    method: \"POST\",\n    headers: {\n      \"X-Api-Key\": heygenApiKey,\n      \"Content-Type\": file.type || \"application/octet-stream\",\n    },\n    body: buffer,\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Ошибка загрузки фото: ${errorText || response.statusText}`\n    );\n  }\n\n  const json = await response.json();\n  const payload = Array.isArray(json) ? json[0] : json;\n  const data = payload?.data;\n\n  if (!data?.image_key || !data?.url) {\n    throw new Error(\"Некорректный ответ Heygen при загрузке фото\");\n  }\n\n  return {\n    imageKey: data.image_key as string,\n    photoUrl: data.url as string,\n  };\n}\n\nasync function createPhotoAvatarInHeygen(name: string, imageKey: string) {\n  if (!heygenApiKey) {\n    throw new Error(\"HEYGEN_API_KEY не задан\");\n  }\n\n  const response = await fetch(\n    \"https://api.heygen.com/v2/photo_avatar/avatar_group/create\",\n    {\n      method: \"POST\",\n      headers: {\n        \"X-Api-Key\": heygenApiKey,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        name,\n        image_key: imageKey,\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Ошибка создания фото-аватара: ${errorText || response.statusText}`\n    );\n  }\n\n  const json = await response.json();\n  const payload = Array.isArray(json) ? json[0] : json;\n\n  return {\n    error: payload?.error ?? null,\n    data: payload?.data ?? null,\n  };\n}\n\nexport async function UploadAvatar(formData: FormData): Promise<UploadAvatarResult> {\n  try {\n    const uid = formData.get(\"uid\");\n    const name = formData.get(\"avatar_name\");\n    const file = formData.get(\"photo\");\n\n    if (typeof uid !== \"string\" || !uid) {\n      return { success: false, error: \"Не удалось определить пользователя\" };\n    }\n\n    if (typeof name !== \"string\" || !name.trim()) {\n      return { success: false, error: \"Введите имя аватара\" };\n    }\n\n    if (!(file instanceof File)) {\n      return { success: false, error: \"Файл не найден\" };\n    }\n\n    const trimmedName = name.trim();\n\n    const { imageKey, photoUrl } = await uploadPhotoToHeygen(file);\n    const createResult = await createPhotoAvatarInHeygen(\n      trimmedName,\n      imageKey\n    );\n\n    const status: \"done\" | \"error\" = createResult.error ? \"error\" : \"done\";\n    const record: PhotoAvatarRow = {\n      uid,\n      name: trimmedName,\n      photo: photoUrl,\n      image_key: imageKey,\n      hey_gen_id: createResult.data?.id ?? null,\n      group_id:\n        createResult.data?.group_id ??\n        createResult.data?.id ??\n        createResult.data?.group ??\n        null,\n      status,\n    };\n\n    const { data, error } = await supabaseAdmin\n      .from(\"photo_avatars\")\n      .insert(record)\n      .select()\n      .single();\n\n    if (error) {\n      throw new Error(error.message);\n    }\n\n    return { success: true, avatar: data as PhotoAvatarRow };\n  } catch (error) {\n    const message =\n      error instanceof Error ? error.message : \"Неизвестная ошибка сервера\";\n    console.error(\"[UploadAvatar]\", message);\n    return { success: false, error: message };\n  }\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 146, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/.next-internal/server/app/material/editor/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {UploadAvatar as '40cd6299375834d156b90e590d5d7df8fc8ed2c79b'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}
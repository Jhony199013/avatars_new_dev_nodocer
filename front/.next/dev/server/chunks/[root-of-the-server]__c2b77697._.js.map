{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/api/tts-audio/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\n\r\nconst FALLBACK_AUDIO_BASE =\r\n  \"https://s3.twcstorage.ru/da2ac12a-41cc63a3-3ad9-4eee-a33a-7776f7973de7/temp/TTS\";\r\n\r\nconst AUDIO_BASE_URL = process.env.TTS_AUDIO_BASE_URL ?? FALLBACK_AUDIO_BASE;\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nconst hopByHopHeaders = new Set([\r\n  \"connection\",\r\n  \"keep-alive\",\r\n  \"proxy-authenticate\",\r\n  \"proxy-authorization\",\r\n  \"te\",\r\n  \"trailers\",\r\n  \"transfer-encoding\",\r\n  \"upgrade\",\r\n]);\r\n\r\nconst buildUpstreamUrl = ({\r\n  userUuid,\r\n  slideNumber,\r\n  voiceId,\r\n  cacheBuster,\r\n}: {\r\n  userUuid: string;\r\n  slideNumber: string;\r\n  voiceId: string;\r\n  cacheBuster?: string | null;\r\n}) => {\r\n  const normalizedBase = AUDIO_BASE_URL.replace(/\\/+$/, \"\");\r\n  const userSegment = encodeURIComponent(userUuid);\r\n  const slideSegment = encodeURIComponent(slideNumber);\r\n  const voiceSegment = encodeURIComponent(voiceId);\r\n  const base = `${normalizedBase}/${userSegment}/${slideSegment}_${voiceSegment}`;\r\n  if (!cacheBuster) {\r\n    return base;\r\n  }\r\n  return `${base}?t=${encodeURIComponent(cacheBuster)}`;\r\n};\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const searchParams = request.nextUrl.searchParams;\r\n  const userUuid = searchParams.get(\"user\");\r\n  const slideNumber = searchParams.get(\"slide\");\r\n  const voiceId = searchParams.get(\"voice\");\r\n  const cacheBuster = searchParams.get(\"bust\");\r\n\r\n  if (!userUuid || !slideNumber || !voiceId) {\r\n    return NextResponse.json(\r\n      { error: \"Требуются параметры user, slide и voice\" },\r\n      { status: 400 },\r\n    );\r\n  }\r\n\r\n  const upstreamUrl = buildUpstreamUrl({\r\n    userUuid,\r\n    slideNumber,\r\n    voiceId,\r\n    cacheBuster,\r\n  });\r\n\r\n  let upstreamResponse: Response;\r\n  try {\r\n    upstreamResponse = await fetch(upstreamUrl, {\r\n      cache: \"no-store\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Не удалось запросить аудио у S3:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Не удалось загрузить аудио\" },\r\n      { status: 502 },\r\n    );\r\n  }\r\n\r\n  if (!upstreamResponse.ok || !upstreamResponse.body) {\r\n    return NextResponse.json(\r\n      { error: \"Сервис аудио вернул ошибку\" },\r\n      { status: upstreamResponse.status || 502 },\r\n    );\r\n  }\r\n\r\n  const headers = new Headers(upstreamResponse.headers);\r\n  // Удаляем hop-by-hop заголовки и принудительно отключаем кэширование\r\n  hopByHopHeaders.forEach((header) => headers.delete(header));\r\n  headers.set(\"Cache-Control\", \"no-store\");\r\n\r\n  return new NextResponse(upstreamResponse.body, {\r\n    status: upstreamResponse.status,\r\n    headers,\r\n  });\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,sBACJ;AAEF,MAAM,iBAAiB,QAAQ,GAAG,CAAC,kBAAkB,IAAI;AAElD,MAAM,UAAU;AAChB,MAAM,UAAU;AAEvB,MAAM,kBAAkB,IAAI,IAAI;IAC9B;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,MAAM,mBAAmB,CAAC,EACxB,QAAQ,EACR,WAAW,EACX,OAAO,EACP,WAAW,EAMZ;IACC,MAAM,iBAAiB,eAAe,OAAO,CAAC,QAAQ;IACtD,MAAM,cAAc,mBAAmB;IACvC,MAAM,eAAe,mBAAmB;IACxC,MAAM,eAAe,mBAAmB;IACxC,MAAM,OAAO,GAAG,eAAe,CAAC,EAAE,YAAY,CAAC,EAAE,aAAa,CAAC,EAAE,cAAc;IAC/E,IAAI,CAAC,aAAa;QAChB,OAAO;IACT;IACA,OAAO,GAAG,KAAK,GAAG,EAAE,mBAAmB,cAAc;AACvD;AAEO,eAAe,IAAI,OAAoB;IAC5C,MAAM,eAAe,QAAQ,OAAO,CAAC,YAAY;IACjD,MAAM,WAAW,aAAa,GAAG,CAAC;IAClC,MAAM,cAAc,aAAa,GAAG,CAAC;IACrC,MAAM,UAAU,aAAa,GAAG,CAAC;IACjC,MAAM,cAAc,aAAa,GAAG,CAAC;IAErC,IAAI,CAAC,YAAY,CAAC,eAAe,CAAC,SAAS;QACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA0C,GACnD;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,cAAc,iBAAiB;QACnC;QACA;QACA;QACA;IACF;IAEA,IAAI;IACJ,IAAI;QACF,mBAAmB,MAAM,MAAM,aAAa;YAC1C,OAAO;QACT;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA6B,GACtC;YAAE,QAAQ;QAAI;IAElB;IAEA,IAAI,CAAC,iBAAiB,EAAE,IAAI,CAAC,iBAAiB,IAAI,EAAE;QAClD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA6B,GACtC;YAAE,QAAQ,iBAAiB,MAAM,IAAI;QAAI;IAE7C;IAEA,MAAM,UAAU,IAAI,QAAQ,iBAAiB,OAAO;IACpD,qEAAqE;IACrE,gBAAgB,OAAO,CAAC,CAAC,SAAW,QAAQ,MAAM,CAAC;IACnD,QAAQ,GAAG,CAAC,iBAAiB;IAE7B,OAAO,IAAI,gJAAY,CAAC,iBAAiB,IAAI,EAAE;QAC7C,QAAQ,iBAAiB,MAAM;QAC/B;IACF;AACF"}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/lib/supabaseClient.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || \"\";\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || \"\";\n\n// Создаем клиент только если переменные окружения установлены\n// Во время сборки может не быть переменных окружения\nexport const supabase = supabaseUrl && supabaseAnonKey\n  ? createClient(supabaseUrl, supabaseAnonKey)\n  : createClient(\"https://placeholder.supabase.co\", \"placeholder-key\");\n\n"],"names":[],"mappings":";;;;AAEoB;AAFpB;;AAEA,MAAM,cAAc,gEAAwC;AAC5D,MAAM,kBAAkB,iNAA6C;AAI9D,MAAM,WAAW,uCACpB,IAAA,0MAAY,EAAC,aAAa,mBAC1B"}},
    {"offset": {"line": 21, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/lib/prefetchAvatars.ts"],"sourcesContent":["import { supabase } from \"./supabaseClient\";\nimport type { PhotoAvatarRow } from \"@/app/avatars/servers/UploadAvatar\";\n\n// Кеш для prefetch данных\nlet prefetchCache: {\n  data: PhotoAvatarRow[] | null;\n  timestamp: number;\n  userId: string | null;\n} = {\n  data: null,\n  timestamp: 0,\n  userId: null,\n};\n\nconst CACHE_DURATION = 30000; // 30 секунд\n\nexport async function prefetchAvatarsData(): Promise<void> {\n  try {\n    // Проверяем кеш\n    const now = Date.now();\n    if (\n      prefetchCache.data &&\n      prefetchCache.userId &&\n      now - prefetchCache.timestamp < CACHE_DURATION\n    ) {\n      return; // Данные уже в кеше и свежие\n    }\n\n    // Получаем пользователя\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n      return;\n    }\n\n    // Проверяем, не загружаем ли мы те же данные\n    if (prefetchCache.userId === user.id && now - prefetchCache.timestamp < CACHE_DURATION) {\n      return;\n    }\n\n    // Загружаем данные в фоне\n    const { data, error } = await supabase\n      .from(\"photo_avatars\")\n      .select(\"*\")\n      .eq(\"uid\", user.id)\n      .order(\"created_at\", { ascending: false });\n\n    if (!error && data) {\n      prefetchCache = {\n        data,\n        timestamp: now,\n        userId: user.id,\n      };\n    }\n  } catch (error) {\n    // Игнорируем ошибки prefetch - это не критично\n    console.debug(\"[prefetch] Ошибка prefetch аватаров:\", error);\n  }\n}\n\nexport function getPrefetchedAvatars(): PhotoAvatarRow[] | null {\n  const now = Date.now();\n  if (\n    prefetchCache.data &&\n    now - prefetchCache.timestamp < CACHE_DURATION\n  ) {\n    return prefetchCache.data;\n  }\n  return null;\n}\n\nexport function clearPrefetchCache(): void {\n  prefetchCache = {\n    data: null,\n    timestamp: 0,\n    userId: null,\n  };\n}\n\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAGA,0BAA0B;AAC1B,IAAI,gBAIA;IACF,MAAM;IACN,WAAW;IACX,QAAQ;AACV;AAEA,MAAM,iBAAiB,OAAO,YAAY;AAEnC,eAAe;IACpB,IAAI;QACF,gBAAgB;QAChB,MAAM,MAAM,KAAK,GAAG;QACpB,IACE,cAAc,IAAI,IAClB,cAAc,MAAM,IACpB,MAAM,cAAc,SAAS,GAAG,gBAChC;YACA,QAAQ,6BAA6B;QACvC;QAEA,wBAAwB;QACxB,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,oIAAQ,CAAC,IAAI,CAAC,OAAO;QAE/B,IAAI,CAAC,MAAM;YACT;QACF;QAEA,6CAA6C;QAC7C,IAAI,cAAc,MAAM,KAAK,KAAK,EAAE,IAAI,MAAM,cAAc,SAAS,GAAG,gBAAgB;YACtF;QACF;QAEA,0BAA0B;QAC1B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,oIAAQ,CACnC,IAAI,CAAC,iBACL,MAAM,CAAC,KACP,EAAE,CAAC,OAAO,KAAK,EAAE,EACjB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAE1C,IAAI,CAAC,SAAS,MAAM;YAClB,gBAAgB;gBACd;gBACA,WAAW;gBACX,QAAQ,KAAK,EAAE;YACjB;QACF;IACF,EAAE,OAAO,OAAO;QACd,+CAA+C;QAC/C,QAAQ,KAAK,CAAC,wCAAwC;IACxD;AACF;AAEO,SAAS;IACd,MAAM,MAAM,KAAK,GAAG;IACpB,IACE,cAAc,IAAI,IAClB,MAAM,cAAc,SAAS,GAAG,gBAChC;QACA,OAAO,cAAc,IAAI;IAC3B;IACA,OAAO;AACT;AAEO,SAAS;IACd,gBAAgB;QACd,MAAM;QACN,WAAW;QACX,QAAQ;IACV;AACF"}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/components/EmptyState.tsx"],"sourcesContent":["import type { ReactNode } from \"react\";\nimport Image from \"next/image\";\n\ntype EmptyStateProps = {\n  title?: string;\n  description?: string;\n  imageSrc?: string;\n  children?: ReactNode;\n};\n\nconst defaultTitleText = \"Ничего нет…\";\nconst defaultDescriptionText = \"Будто в открытом космосе...\";\nconst defaultImageSrc = \"/Cosmo.png\";\n\nexport function EmptyState({\n  title = defaultTitleText,\n  description = defaultDescriptionText,\n  imageSrc = defaultImageSrc,\n  children,\n}: EmptyStateProps) {\n  return (\n    <div className=\"flex w-full max-w-[1350px] min-h-[350px] flex-col items-center gap-6 rounded-3xl px-16 pt-6 pb-10 text-center\">\n      <div className=\"relative h-48 w-48 max-w-full\">\n        <Image\n          src={imageSrc}\n          alt={title || defaultTitleText}\n          fill\n          sizes=\"(max-width: 768px) 60vw, 224px\"\n          className=\"object-contain drop-shadow-xl\"\n          priority\n        />\n      </div>\n      {(title || description) && (\n      <div className=\"space-y-2\">\n          {title && <p className=\"text-2xl font-semibold text-gray-900\">{title}</p>}\n          {description && <p className=\"text-gray-600\">{description}</p>}\n      </div>\n      )}\n      {children}\n    </div>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AACA;;;AASA,MAAM,mBAAmB;AACzB,MAAM,yBAAyB;AAC/B,MAAM,kBAAkB;AAEjB,SAAS,WAAW,EACzB,QAAQ,gBAAgB,EACxB,cAAc,sBAAsB,EACpC,WAAW,eAAe,EAC1B,QAAQ,EACQ;IAChB,qBACE,6LAAC;QAAI,WAAU;;0BACb,6LAAC;gBAAI,WAAU;0BACb,cAAA,6LAAC,2IAAK;oBACJ,KAAK;oBACL,KAAK,SAAS;oBACd,IAAI;oBACJ,OAAM;oBACN,WAAU;oBACV,QAAQ;;;;;;;;;;;YAGX,CAAC,SAAS,WAAW,mBACtB,6LAAC;gBAAI,WAAU;;oBACV,uBAAS,6LAAC;wBAAE,WAAU;kCAAwC;;;;;;oBAC9D,6BAAe,6LAAC;wBAAE,WAAU;kCAAiB;;;;;;;;;;;;YAGjD;;;;;;;AAGP;KA3BgB"}},
    {"offset": {"line": 168, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/components/ui/LogoutModal.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { supabase } from \"@/lib/supabaseClient\";\n\ninterface LogoutModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport function LogoutModal({ isOpen, onClose }: LogoutModalProps) {\n  const router = useRouter();\n  const [isLoggingOut, setIsLoggingOut] = useState(false);\n\n  const handleLogout = async () => {\n    setIsLoggingOut(true);\n    try {\n      await supabase.auth.signOut();\n      document.cookie =\n        \"app-auth=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT\";\n      router.push(\"/login\");\n      onClose();\n    } catch (error) {\n      console.error(\"Ошибка при выходе:\", error);\n    } finally {\n      setIsLoggingOut(false);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\">\n      <div className=\"mx-4 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl\">\n        <h2 className=\"mb-4 text-xl font-semibold text-gray-900\">Выход</h2>\n        <p className=\"mb-6 text-gray-600\">Вы действительно хотите выйти из аккаунта?</p>\n        <div className=\"flex gap-3\">\n          <button\n            type=\"button\"\n            onClick={onClose}\n            disabled={isLoggingOut}\n            className=\"flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50\"\n          >\n            Отмена\n          </button>\n          <button\n            type=\"button\"\n            onClick={handleLogout}\n            disabled={isLoggingOut}\n            className=\"flex-1 rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-gray-800 disabled:opacity-50\"\n          >\n            {isLoggingOut ? \"Выходим...\" : \"Выйти\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;;;AAJA;;;;AAWO,SAAS,YAAY,EAAE,MAAM,EAAE,OAAO,EAAoB;;IAC/D,MAAM,SAAS,IAAA,kJAAS;IACxB,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,yKAAQ,EAAC;IAEjD,MAAM,eAAe;QACnB,gBAAgB;QAChB,IAAI;YACF,MAAM,oIAAQ,CAAC,IAAI,CAAC,OAAO;YAC3B,SAAS,MAAM,GACb;YACF,OAAO,IAAI,CAAC;YACZ;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sBAAsB;QACtC,SAAU;YACR,gBAAgB;QAClB;IACF;IAEA,IAAI,CAAC,QAAQ,OAAO;IAEpB,qBACE,6LAAC;QAAI,WAAU;kBACb,cAAA,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAG,WAAU;8BAA2C;;;;;;8BACzD,6LAAC;oBAAE,WAAU;8BAAqB;;;;;;8BAClC,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BACC,MAAK;4BACL,SAAS;4BACT,UAAU;4BACV,WAAU;sCACX;;;;;;sCAGD,6LAAC;4BACC,MAAK;4BACL,SAAS;4BACT,UAAU;4BACV,WAAU;sCAET,eAAe,eAAe;;;;;;;;;;;;;;;;;;;;;;;AAM3C;GA/CgB;;QACC,kJAAS;;;KADV"}},
    {"offset": {"line": 279, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/components/ui/Header.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport { LogoutModal } from \"./LogoutModal\";\nimport { prefetchAvatarsData } from \"@/lib/prefetchAvatars\";\n\nconst navLinks = [\n  { href: \"/\", label: \"Главная\" },\n  { href: \"/avatars\", label: \"Аватары\" },\n  { href: \"/voices\", label: \"Голоса\" },\n  { href: \"/material\", label: \"Материал\" },\n];\n\nexport function Header() {\n  const pathname = usePathname();\n  const [isLogoutModalOpen, setIsLogoutModalOpen] = useState(false);\n\n  return (\n    <>\n      <header className=\"fixed top-0 left-0 right-0 z-50 h-16 w-full bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/80 shadow-lg border-b border-gray-100\">\n        <div className=\"mx-auto flex h-full w-full max-w-[1350px] items-center px-6\">\n          <nav className=\"flex flex-1 items-center gap-8\">\n            {navLinks.map(({ href, label }) => {\n              const isActive = pathname === href;\n              const handleMouseEnter = () => {\n                // Prefetch данные для страницы аватаров при наведении\n                if ((href === \"/avatars\" || href === \"/\") && !isActive) {\n                  prefetchAvatarsData();\n                }\n              };\n              \n              return (\n                <Link\n                  key={href}\n                  href={href}\n                  onMouseEnter={handleMouseEnter}\n                  prefetch={true}\n                  className={`text-lg font-semibold transition ${\n                    isActive\n                      ? \"text-gray-900\"\n                      : \"text-gray-500 hover:text-gray-800\"\n                  }`}\n                >\n                  {label}\n                </Link>\n              );\n            })}\n          </nav>\n          <div className=\"flex flex-none justify-end\">\n            <button\n              type=\"button\"\n              onClick={() => setIsLogoutModalOpen(true)}\n              className=\"rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-gray-800\"\n            >\n              Выйти\n            </button>\n          </div>\n        </div>\n      </header>\n      <div className=\"h-16\" aria-hidden />\n      <LogoutModal\n        isOpen={isLogoutModalOpen}\n        onClose={() => setIsLogoutModalOpen(false)}\n      />\n    </>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;;;AANA;;;;;;AAQA,MAAM,WAAW;IACf;QAAE,MAAM;QAAK,OAAO;IAAU;IAC9B;QAAE,MAAM;QAAY,OAAO;IAAU;IACrC;QAAE,MAAM;QAAW,OAAO;IAAS;IACnC;QAAE,MAAM;QAAa,OAAO;IAAW;CACxC;AAEM,SAAS;;IACd,MAAM,WAAW,IAAA,oJAAW;IAC5B,MAAM,CAAC,mBAAmB,qBAAqB,GAAG,IAAA,yKAAQ,EAAC;IAE3D,qBACE;;0BACE,6LAAC;gBAAO,WAAU;0BAChB,cAAA,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BAAI,WAAU;sCACZ,SAAS,GAAG,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE;gCAC5B,MAAM,WAAW,aAAa;gCAC9B,MAAM,mBAAmB;oCACvB,sDAAsD;oCACtD,IAAI,CAAC,SAAS,cAAc,SAAS,GAAG,KAAK,CAAC,UAAU;wCACtD,IAAA,gJAAmB;oCACrB;gCACF;gCAEA,qBACE,6LAAC,0KAAI;oCAEH,MAAM;oCACN,cAAc;oCACd,UAAU;oCACV,WAAW,CAAC,iCAAiC,EAC3C,WACI,kBACA,qCACJ;8CAED;mCAVI;;;;;4BAaX;;;;;;sCAEF,6LAAC;4BAAI,WAAU;sCACb,cAAA,6LAAC;gCACC,MAAK;gCACL,SAAS,IAAM,qBAAqB;gCACpC,WAAU;0CACX;;;;;;;;;;;;;;;;;;;;;;0BAMP,6LAAC;gBAAI,WAAU;gBAAO,aAAW;;;;;;0BACjC,6LAAC,kJAAW;gBACV,QAAQ;gBACR,SAAS,IAAM,qBAAqB;;;;;;;;AAI5C;GArDgB;;QACG,oJAAW;;;KADd"}},
    {"offset": {"line": 415, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/components/ui/CosmoLoader.tsx"],"sourcesContent":["type CosmoLoaderProps = {\r\n  ariaLabel?: string;\r\n};\r\n\r\nexport function CosmoLoader({ ariaLabel = \"Загрузка...\" }: CosmoLoaderProps) {\r\n  return (\r\n    <div className=\"flex flex-col items-center\" role=\"status\" aria-live=\"polite\">\r\n      <div className=\"relative flex items-center justify-center\">\r\n        <div\r\n          className=\"h-10 w-10 animate-spin rounded-full border-[3px] border-transparent shadow-[0_0_18px_rgba(255,192,76,0.55)]\"\r\n          style={{\r\n            borderTopColor: \"#FFB347\",\r\n            borderRightColor: \"#FFC94C\",\r\n          }}\r\n        />\r\n        <div className=\"absolute h-3 w-3 rounded-full bg-[#FFB347] opacity-70 blur-sm\" />\r\n      </div>\r\n      <span className=\"sr-only\">{ariaLabel}</span>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AAIO,SAAS,YAAY,EAAE,YAAY,aAAa,EAAoB;IACzE,qBACE,6LAAC;QAAI,WAAU;QAA6B,MAAK;QAAS,aAAU;;0BAClE,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBACC,WAAU;wBACV,OAAO;4BACL,gBAAgB;4BAChB,kBAAkB;wBACpB;;;;;;kCAEF,6LAAC;wBAAI,WAAU;;;;;;;;;;;;0BAEjB,6LAAC;gBAAK,WAAU;0BAAW;;;;;;;;;;;;AAGjC;KAhBgB"}},
    {"offset": {"line": 479, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/servers/UploadAvatar.ts"],"sourcesContent":["\"use server\";\n\nimport { Buffer } from \"buffer\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport interface PhotoAvatarRow {\n  id?: string;\n  uid: string;\n  name: string;\n  photo: string;\n  image_key: string;\n  hey_gen_id: string | null;\n  group_id: string | null;\n  status: \"done\" | \"error\";\n  created_at?: string;\n}\n\ninterface UploadAvatarSuccess {\n  success: true;\n  avatar: PhotoAvatarRow;\n}\n\ninterface UploadAvatarFailure {\n  success: false;\n  error: string;\n}\n\ntype UploadAvatarResult = UploadAvatarSuccess | UploadAvatarFailure;\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\nconst heygenApiKey = process.env.HEYGEN_API_KEY;\n\nif (!supabaseUrl) {\n  throw new Error(\"NEXT_PUBLIC_SUPABASE_URL не задан\");\n}\n\nif (!supabaseServiceRoleKey) {\n  throw new Error(\"SUPABASE_SERVICE_ROLE_KEY не задан\");\n}\n\nconst supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey);\n\nasync function uploadPhotoToHeygen(file: File) {\n  if (!heygenApiKey) {\n    throw new Error(\"HEYGEN_API_KEY не задан\");\n  }\n\n  const buffer = Buffer.from(await file.arrayBuffer());\n  const response = await fetch(\"https://upload.heygen.com/v1/asset\", {\n    method: \"POST\",\n    headers: {\n      \"X-Api-Key\": heygenApiKey,\n      \"Content-Type\": file.type || \"application/octet-stream\",\n    },\n    body: buffer,\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Ошибка загрузки фото: ${errorText || response.statusText}`\n    );\n  }\n\n  const json = await response.json();\n  const payload = Array.isArray(json) ? json[0] : json;\n  const data = payload?.data;\n\n  if (!data?.image_key || !data?.url) {\n    throw new Error(\"Некорректный ответ Heygen при загрузке фото\");\n  }\n\n  return {\n    imageKey: data.image_key as string,\n    photoUrl: data.url as string,\n  };\n}\n\nasync function createPhotoAvatarInHeygen(name: string, imageKey: string) {\n  if (!heygenApiKey) {\n    throw new Error(\"HEYGEN_API_KEY не задан\");\n  }\n\n  const response = await fetch(\n    \"https://api.heygen.com/v2/photo_avatar/avatar_group/create\",\n    {\n      method: \"POST\",\n      headers: {\n        \"X-Api-Key\": heygenApiKey,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        name,\n        image_key: imageKey,\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Ошибка создания фото-аватара: ${errorText || response.statusText}`\n    );\n  }\n\n  const json = await response.json();\n  const payload = Array.isArray(json) ? json[0] : json;\n\n  return {\n    error: payload?.error ?? null,\n    data: payload?.data ?? null,\n  };\n}\n\nexport async function UploadAvatar(formData: FormData): Promise<UploadAvatarResult> {\n  try {\n    const uid = formData.get(\"uid\");\n    const name = formData.get(\"avatar_name\");\n    const file = formData.get(\"photo\");\n\n    if (typeof uid !== \"string\" || !uid) {\n      return { success: false, error: \"Не удалось определить пользователя\" };\n    }\n\n    if (typeof name !== \"string\" || !name.trim()) {\n      return { success: false, error: \"Введите имя аватара\" };\n    }\n\n    if (!(file instanceof File)) {\n      return { success: false, error: \"Файл не найден\" };\n    }\n\n    const trimmedName = name.trim();\n\n    const { imageKey, photoUrl } = await uploadPhotoToHeygen(file);\n    const createResult = await createPhotoAvatarInHeygen(\n      trimmedName,\n      imageKey\n    );\n\n    const status: \"done\" | \"error\" = createResult.error ? \"error\" : \"done\";\n    const record: PhotoAvatarRow = {\n      uid,\n      name: trimmedName,\n      photo: photoUrl,\n      image_key: imageKey,\n      hey_gen_id: createResult.data?.id ?? null,\n      group_id:\n        createResult.data?.group_id ??\n        createResult.data?.id ??\n        createResult.data?.group ??\n        null,\n      status,\n    };\n\n    const { data, error } = await supabaseAdmin\n      .from(\"photo_avatars\")\n      .insert(record)\n      .select()\n      .single();\n\n    if (error) {\n      throw new Error(error.message);\n    }\n\n    return { success: true, avatar: data as PhotoAvatarRow };\n  } catch (error) {\n    const message =\n      error instanceof Error ? error.message : \"Неизвестная ошибка сервера\";\n    console.error(\"[UploadAvatar]\", message);\n    return { success: false, error: message };\n  }\n}\n\n"],"names":[],"mappings":";;;;;;;IAmHsB,eAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 494, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/components/AvatarUploadModal.tsx"],"sourcesContent":["\"use client\";\n\nimport Image from \"next/image\";\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { supabase } from \"@/lib/supabaseClient\";\nimport { UploadAvatar } from \"../servers/UploadAvatar\";\n\ninterface AvatarUploadModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onAvatarUploaded?: () => void | Promise<void>;\n}\n\nconst MAX_FILE_SIZE = 10 * 1024 * 1024;\nconst ALLOWED_TYPES = [\"image/jpeg\", \"image/jpg\", \"image/png\"];\n\nconst sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\n\nexport function AvatarUploadModal({\n  isOpen,\n  onClose,\n  onAvatarUploaded,\n}: AvatarUploadModalProps) {\n  const [avatarName, setAvatarName] = useState(\"\");\n  const [dragActive, setDragActive] = useState(false);\n  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);\n  const [previewUrls, setPreviewUrls] = useState<string[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const progressIntervalRef = useRef<ReturnType<typeof setInterval> | null>(\n    null\n  );\n  const isMountedRef = useRef(true);\n\n  const stopProgressLoop = useCallback(() => {\n    if (progressIntervalRef.current) {\n      clearInterval(progressIntervalRef.current);\n      progressIntervalRef.current = null;\n    }\n  }, []);\n\n  const startProgressLoop = useCallback(() => {\n    stopProgressLoop();\n    const startTime = Date.now();\n    progressIntervalRef.current = setInterval(() => {\n      setProgress((prev) => {\n        const elapsed = Date.now() - startTime;\n        const nextValue = Math.min(90, (elapsed / 20000) * 90);\n        return nextValue > prev ? nextValue : prev;\n      });\n    }, 200);\n  }, [stopProgressLoop]);\n\n  useEffect(() => {\n    return () => {\n      previewUrls.forEach((url) => URL.revokeObjectURL(url));\n    };\n  }, [previewUrls]);\n\n  useEffect(() => {\n    return () => {\n      isMountedRef.current = false;\n      stopProgressLoop();\n    };\n  }, [stopProgressLoop]);\n\n  const resetState = useCallback(() => {\n    setAvatarName(\"\");\n    setSelectedFiles([]);\n    previewUrls.forEach((url) => URL.revokeObjectURL(url));\n    setPreviewUrls([]);\n    setProgress(0);\n    stopProgressLoop();\n  }, [previewUrls, stopProgressLoop]);\n\n  const closeModal = useCallback(() => {\n    resetState();\n    onClose();\n  }, [onClose, resetState]);\n\n  const validateFileTypes = (files: File[]): File[] => {\n    const validFiles: File[] = [];\n    const invalidFormat: string[] = [];\n    const tooLarge: string[] = [];\n\n    files.forEach((file) => {\n      if (!ALLOWED_TYPES.includes(file.type.toLowerCase())) {\n        invalidFormat.push(file.name);\n      } else if (file.size > MAX_FILE_SIZE) {\n        tooLarge.push(\n          `${file.name} (${(file.size / 1024 / 1024).toFixed(1)} МБ)`\n        );\n      } else {\n        validFiles.push(file);\n      }\n    });\n\n    if (invalidFormat.length || tooLarge.length) {\n      let message = \"\";\n      if (invalidFormat.length) {\n        message += `Файлы с неподдерживаемым форматом:\\n${invalidFormat.join(\n          \"\\n\"\n        )}\\n\\nДопустимы только PNG или JPG.\\n\\n`;\n      }\n      if (tooLarge.length) {\n        message += `Файлы превышают лимит 10 МБ:\\n${tooLarge.join(\"\\n\")}`;\n      }\n      alert(message.trim());\n    }\n\n    return validFiles;\n  };\n\n  const createPreviews = useCallback(\n    (files: File[]) => {\n      previewUrls.forEach((url) => URL.revokeObjectURL(url));\n      const limitedFiles = files.slice(0, 1);\n      setSelectedFiles(limitedFiles);\n      setPreviewUrls(limitedFiles.map((file) => URL.createObjectURL(file)));\n    },\n    [previewUrls]\n  );\n\n  const handleDrag = useCallback((event: React.DragEvent) => {\n    event.preventDefault();\n    event.stopPropagation();\n    if (event.type === \"dragenter\" || event.type === \"dragover\") {\n      setDragActive(true);\n    } else if (event.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  }, []);\n\n  const handleDrop = useCallback(\n    (event: React.DragEvent) => {\n      event.preventDefault();\n      event.stopPropagation();\n      setDragActive(false);\n      if (event.dataTransfer.files?.[0]) {\n        const validFiles = validateFileTypes([event.dataTransfer.files[0]]);\n        if (validFiles.length) {\n          createPreviews(validFiles);\n        }\n      }\n    },\n    [createPreviews]\n  );\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    if (event.target.files?.[0]) {\n      const validFiles = validateFileTypes([event.target.files[0]]);\n      if (validFiles.length) {\n        createPreviews(validFiles);\n      }\n    }\n  };\n\n  const removeFile = (index: number) => {\n    const newPreviews = previewUrls.filter((_, i) => i !== index);\n    const revokedUrl = previewUrls[index];\n    if (revokedUrl) {\n      URL.revokeObjectURL(revokedUrl);\n    }\n    setPreviewUrls(newPreviews);\n    setSelectedFiles(selectedFiles.filter((_, i) => i !== index));\n  };\n\n  const waitForAvatarCompletion = useCallback(\n    async (recordId?: string | null, initialStatus?: \"done\" | \"error\") => {\n      if (!recordId) {\n        console.warn(\"[avatars] Нет ID записи для проверки статуса\");\n        return true;\n      }\n\n      // Если статус уже done сразу после создания, не ждём\n      if (initialStatus === \"done\") {\n        console.log(\"[avatars] Статус уже 'done', не требуется ожидание\");\n        return true;\n      }\n\n      if (initialStatus === \"error\") {\n        console.error(\"[avatars] Статус 'error' при создании записи\");\n        return false;\n      }\n\n      const timeoutMs = 2 * 60 * 1000;\n      const pollDelayMs = 2000;\n      const deadline = Date.now() + timeoutMs;\n      let attemptCount = 0;\n\n      console.log(`[avatars] Начинаем проверку статуса для записи ${recordId}`);\n\n      while (isMountedRef.current && Date.now() < deadline) {\n        attemptCount++;\n        const { data, error } = await supabase\n          .from(\"photo_avatars\")\n          .select(\"status\")\n          .eq(\"id\", recordId)\n          .single();\n\n        if (error) {\n          console.error(\n            `[avatars] Ошибка проверки статуса (попытка ${attemptCount}):`,\n            error\n          );\n          // Если запись не найдена, продолжаем попытки\n          if (error.code === \"PGRST116\") {\n            await sleep(pollDelayMs);\n            continue;\n          }\n        } else if (data?.status === \"done\") {\n          console.log(\n            `[avatars] Статус 'done' получен после ${attemptCount} попыток`\n          );\n          return true;\n        } else if (data?.status === \"error\") {\n          console.error(\n            `[avatars] Статус 'error' получен после ${attemptCount} попыток`\n          );\n          return false;\n        } else {\n          console.log(\n            `[avatars] Попытка ${attemptCount}: статус = ${data?.status || \"неизвестен\"}`\n          );\n        }\n\n        await sleep(pollDelayMs);\n      }\n\n      console.warn(\n        `[avatars] Таймаут ожидания статуса после ${attemptCount} попыток`\n      );\n      return false;\n    },\n    []\n  );\n\n  const handleUpload = async () => {\n    if (isUploading || !avatarName.trim() || selectedFiles.length === 0) {\n      return;\n    }\n\n    // Проверка лимита в демо-режиме\n    try {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n\n      if (user) {\n        const { data: avatarsData } = await supabase\n          .from(\"photo_avatars\")\n          .select(\"id\")\n          .eq(\"uid\", user.id);\n\n        if (avatarsData && avatarsData.length >= 3) {\n          alert(\"В демо-режиме можно создать максимум 3 аватара\");\n          return;\n        }\n      }\n    } catch (error) {\n      console.error(\"[AvatarUploadModal] Ошибка проверки лимита:\", error);\n    }\n\n    setIsUploading(true);\n    setProgress(0);\n    startProgressLoop();\n\n    try {\n      const {\n        data: { user },\n        error: authError,\n      } = await supabase.auth.getUser();\n\n      if (authError) {\n        throw new Error(authError.message);\n      }\n\n      if (!user) {\n        throw new Error(\"Пользователь не найден\");\n      }\n\n      const formData = new FormData();\n      formData.append(\"avatar_name\", avatarName.trim());\n      formData.append(\"uid\", user.id);\n      formData.append(\"photo\", selectedFiles[0]);\n\n      const result = await UploadAvatar(formData);\n\n      if (!result.success) {\n        throw new Error(result.error);\n      }\n\n      // Проверяем статус сразу после создания\n      const initialStatus = result.avatar.status;\n      console.log(\n        `[avatars] Аватар создан с ID ${result.avatar.id}, начальный статус: ${initialStatus}`\n      );\n\n      // Если статус уже done, сразу устанавливаем прогресс в 100%\n      if (initialStatus === \"done\") {\n        stopProgressLoop();\n        setProgress(100);\n        await onAvatarUploaded?.();\n        await sleep(400);\n        closeModal();\n        return;\n      }\n\n      const isReady = await waitForAvatarCompletion(\n        result.avatar.id ?? null,\n        initialStatus\n      );\n\n      if (!isReady) {\n        throw new Error(\n          \"Не удалось дождаться завершения обработки аватара. Попробуйте позже.\"\n        );\n      }\n\n      stopProgressLoop();\n      setProgress(100);\n      await onAvatarUploaded?.();\n      await sleep(400);\n      closeModal();\n    } catch (error) {\n      console.error(\"[avatars] Ошибка при загрузке:\", error);\n      alert(\n        `Ошибка при загрузке: ${\n          error instanceof Error ? error.message : \"Неизвестная ошибка\"\n        }`\n      );\n      setProgress(0);\n    } finally {\n      stopProgressLoop();\n      setIsUploading(false);\n    }\n  };\n\n  const dropZoneClasses = useMemo(() => {\n    const base =\n      \"rounded-2xl border border-dashed border-blue-400/50 bg-blue-50/30 p-6 text-center transition-all duration-200\";\n    if (dragActive) {\n      return `${base} shadow-lg -translate-y-0.5`;\n    }\n    return `${base} hover:shadow-md hover:-translate-y-0.5`;\n  }, [dragActive]);\n\n  if (!isOpen) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-8\">\n      <div className=\"w-full max-w-lg rounded-[32px] bg-white shadow-2xl\">\n        <div className=\"relative flex items-center justify-center border-b px-6 py-4\">\n          <h2 className=\"text-lg font-semibold text-gray-900\">\n            Загрузите фото для аватара\n          </h2>\n          <button\n            type=\"button\"\n            onClick={closeModal}\n            className=\"absolute right-6 rounded-full p-1 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600\"\n          >\n            <span className=\"sr-only\">Закрыть</span>✕\n          </button>\n        </div>\n\n        <div className=\"max-h-[70vh] overflow-y-auto px-6 py-6 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 [&::-webkit-scrollbar-thumb]:rounded-full\">\n          <div className=\"space-y-6 text-sm text-gray-600\">\n            <div>\n              <label\n                htmlFor=\"avatar-name\"\n                className=\"mb-2 block text-xs font-semibold uppercase tracking-wide text-gray-500\"\n              >\n                Имя аватара\n              </label>\n              <input\n                id=\"avatar-name\"\n                value={avatarName}\n                onChange={(event) => setAvatarName(event.target.value)}\n                placeholder=\"Придумайте любое имя\"\n                className=\"w-full rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-base text-gray-900 outline-none transition focus:border-gray-400\"\n              />\n            </div>\n\n            <div\n              className={dropZoneClasses}\n              onDragEnter={handleDrag}\n              onDragLeave={handleDrag}\n              onDragOver={handleDrag}\n              onDrop={handleDrop}\n            >\n              <div className=\"mx-auto flex max-w-sm flex-col items-center gap-3 text-gray-700\">\n                <div className=\"rounded-2xl border border-blue-200 bg-white p-3 text-blue-500\">\n                  ↑\n                </div>\n                <p className=\"text-base font-semibold\">\n                  Перетащите фотографию сюда\n                </p>\n                <p className=\"text-xs text-gray-500\">PNG или JPG до 10 МБ</p>\n                <button\n                  type=\"button\"\n                  className=\"rounded-lg bg-blue-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-blue-500\"\n                  onClick={() => fileInputRef.current?.click()}\n                >\n                  Выбрать файл\n                </button>\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  accept=\"image/jpeg,image/jpg,image/png\"\n                  className=\"hidden\"\n                  onChange={handleFileSelect}\n                />\n              </div>\n            </div>\n\n            {selectedFiles.length > 0 && (\n              <div className=\"rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-700\">\n                {selectedFiles.map((file, index) => (\n                  <div\n                    key={`${file.name}-${index}`}\n                    className=\"flex items-center justify-between gap-3\"\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      {previewUrls[index] && (\n                        <Image\n                          src={previewUrls[index]}\n                          alt={file.name}\n                          width={40}\n                          height={40}\n                          className=\"h-10 w-10 rounded-lg object-cover\"\n                          unoptimized\n                        />\n                      )}\n                      <div className=\"truncate\">{file.name}</div>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => removeFile(index)}\n                      className=\"text-gray-400 transition hover:text-red-500\"\n                    >\n                      Удалить\n                    </button>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            <div className=\"rounded-2xl border border-gray-100 bg-gray-50 p-4 text-xs text-gray-600\">\n              <p className=\"mb-3 text-sm font-semibold text-gray-800\">\n                Требования к фото\n              </p>\n              <ul className=\"space-y-2\">\n                <li>Фото в анфас (лицо прямо в камеру)</li>\n                <li>Хорошее качество изображения, чёткое и резкое</li>\n                <li>Без теней на лице, равномерное освещение</li>\n                <li>Без других людей на фото, только вы</li>\n                <li>Без открытой улыбки, нейтральное выражение лица</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex flex-col gap-3 border-t border-gray-200 px-6 py-4 text-sm text-gray-500 sm:flex-row sm:items-center sm:justify-between sm:gap-4\">\n          <div className=\"flex flex-1 items-center gap-4\">\n            <button\n              type=\"button\"\n              onClick={closeModal}\n              className=\"rounded-lg border border-gray-200 px-5 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50\"\n              disabled={isUploading}\n            >\n              Отмена\n            </button>\n            {(isUploading || progress > 0) && (\n              <div className=\"relative h-1 flex-1 overflow-hidden rounded-full bg-gray-200\">\n                <div\n                  className=\"absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-[#FFB347] via-[#FFC94C] to-[#FFB347] transition-[width] duration-500 ease-out\"\n                  style={{ width: `${progress}%` }}\n                  aria-hidden=\"true\"\n                />\n              </div>\n            )}\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleUpload}\n            disabled={\n              isUploading || !avatarName.trim() || selectedFiles.length === 0\n            }\n            className=\"rounded-lg bg-blue-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-blue-500 disabled:cursor-not-allowed disabled:bg-gray-300 sm:ml-auto\"\n          >\n            {isUploading ? \"Создаем...\" : \"Создать\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1163, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/servers/DeletePhotoAvatar.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\nconst heygenApiKey = process.env.HEYGEN_API_KEY;\r\n\r\nif (!supabaseUrl) {\r\n  throw new Error(\"NEXT_PUBLIC_SUPABASE_URL не задан\");\r\n}\r\n\r\nif (!supabaseServiceRoleKey) {\r\n  throw new Error(\"SUPABASE_SERVICE_ROLE_KEY не задан\");\r\n}\r\n\r\nconst supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey);\r\n\r\ninterface DeletePhotoAvatarInput {\r\n  uid: string;\r\n  recordId?: string | null;\r\n  groupId?: string | null;\r\n  imageKey?: string | null;\r\n}\r\n\r\ninterface DeletePhotoAvatarResult {\r\n  success: boolean;\r\n  error?: string;\r\n}\r\n\r\nasync function deleteFromHeygen(groupId?: string | null) {\r\n  if (!groupId) {\r\n    return;\r\n  }\r\n\r\n  if (!heygenApiKey) {\r\n    throw new Error(\"HEYGEN_API_KEY не задан\");\r\n  }\r\n\r\n  const response = await fetch(\r\n    `https://api.heygen.com/v2/photo_avatar_group/${groupId}`,\r\n    {\r\n      method: \"DELETE\",\r\n      headers: {\r\n        \"X-Api-Key\": heygenApiKey,\r\n      },\r\n    }\r\n  );\r\n\r\n  if (!response.ok && response.status !== 404) {\r\n    const message = await response.text();\r\n    throw new Error(\r\n      `Не удалось удалить аватар в HeyGen: ${message || response.statusText}`\r\n    );\r\n  }\r\n}\r\n\r\nexport async function DeletePhotoAvatar({\r\n  uid,\r\n  recordId,\r\n  groupId,\r\n  imageKey,\r\n}: DeletePhotoAvatarInput): Promise<DeletePhotoAvatarResult> {\r\n  try {\r\n    if (!uid) {\r\n      return { success: false, error: \"Пользователь не найден\" };\r\n    }\r\n\r\n    if (!recordId && !groupId && !imageKey) {\r\n      return { success: false, error: \"Нет идентификатора записи\" };\r\n    }\r\n\r\n    await deleteFromHeygen(groupId);\r\n\r\n    let query = supabaseAdmin.from(\"photo_avatars\").delete().eq(\"uid\", uid);\r\n\r\n    if (recordId) {\r\n      query = query.eq(\"id\", recordId);\r\n    } else if (groupId) {\r\n      query = query.eq(\"group_id\", groupId);\r\n    } else if (imageKey) {\r\n      query = query.eq(\"image_key\", imageKey);\r\n    }\r\n\r\n    const { error } = await query;\r\n\r\n    if (error) {\r\n      throw new Error(error.message);\r\n    }\r\n\r\n    return { success: true };\r\n  } catch (error) {\r\n    const message =\r\n      error instanceof Error ? error.message : \"Неизвестная ошибка\";\r\n    console.error(\"[DeletePhotoAvatar]\", message);\r\n    return { success: false, error: message };\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;IAyDsB,oBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 1178, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/servers/UpdateAvatarName.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\nif (!supabaseUrl) {\r\n  throw new Error(\"NEXT_PUBLIC_SUPABASE_URL не задан\");\r\n}\r\n\r\nif (!supabaseServiceRoleKey) {\r\n  throw new Error(\"SUPABASE_SERVICE_ROLE_KEY не задан\");\r\n}\r\n\r\nconst supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey);\r\n\r\ninterface UpdateAvatarNameInput {\r\n  uid: string;\r\n  recordId: string;\r\n  newName: string;\r\n}\r\n\r\ninterface UpdateAvatarNameResult {\r\n  success: boolean;\r\n  error?: string;\r\n}\r\n\r\nexport async function UpdateAvatarName({\r\n  uid,\r\n  recordId,\r\n  newName,\r\n}: UpdateAvatarNameInput): Promise<UpdateAvatarNameResult> {\r\n  try {\r\n    if (!uid) {\r\n      return { success: false, error: \"Пользователь не найден\" };\r\n    }\r\n\r\n    if (!recordId) {\r\n      return { success: false, error: \"ID записи не указан\" };\r\n    }\r\n\r\n    if (!newName || !newName.trim()) {\r\n      return { success: false, error: \"Имя не может быть пустым\" };\r\n    }\r\n\r\n    const trimmedName = newName.trim();\r\n\r\n    const { error } = await supabaseAdmin\r\n      .from(\"photo_avatars\")\r\n      .update({ name: trimmedName })\r\n      .eq(\"id\", recordId)\r\n      .eq(\"uid\", uid);\r\n\r\n    if (error) {\r\n      throw new Error(error.message);\r\n    }\r\n\r\n    return { success: true };\r\n  } catch (error) {\r\n    const message =\r\n      error instanceof Error ? error.message : \"Неизвестная ошибка\";\r\n    console.error(\"[UpdateAvatarName]\", message);\r\n    return { success: false, error: message };\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;IA4BsB,mBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 1193, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/components/DeleteAvatarModal.tsx"],"sourcesContent":["\"use client\";\r\n\r\ninterface DeleteAvatarModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onConfirm: () => void | Promise<void>;\r\n  avatarName: string;\r\n  isDeleting?: boolean;\r\n}\r\n\r\nexport function DeleteAvatarModal({\r\n  isOpen,\r\n  onClose,\r\n  onConfirm,\r\n  avatarName,\r\n  isDeleting = false,\r\n}: DeleteAvatarModalProps) {\r\n  if (!isOpen) return null;\r\n\r\n  const handleConfirm = async () => {\r\n    await onConfirm();\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\">\r\n      <div className=\"mx-4 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl\">\r\n        <h2 className=\"mb-4 text-xl font-semibold text-gray-900\">\r\n          Удаление аватара\r\n        </h2>\r\n        <p className=\"mb-6 text-gray-600\">\r\n          Вы действительно хотите удалить аватар «{avatarName}»?\r\n        </p>\r\n        <div className=\"flex gap-3\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={onClose}\r\n            disabled={isDeleting}\r\n            className=\"flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50\"\r\n          >\r\n            Отмена\r\n          </button>\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleConfirm}\r\n            disabled={isDeleting}\r\n            className=\"flex-1 rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700 disabled:opacity-50\"\r\n          >\r\n            {isDeleting ? \"Удаляем...\" : \"Удалить\"}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;AAAA;;AAUO,SAAS,kBAAkB,EAChC,MAAM,EACN,OAAO,EACP,SAAS,EACT,UAAU,EACV,aAAa,KAAK,EACK;IACvB,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,gBAAgB;QACpB,MAAM;IACR;IAEA,qBACE,6LAAC;QAAI,WAAU;kBACb,cAAA,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAG,WAAU;8BAA2C;;;;;;8BAGzD,6LAAC;oBAAE,WAAU;;wBAAqB;wBACS;wBAAW;;;;;;;8BAEtD,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BACC,MAAK;4BACL,SAAS;4BACT,UAAU;4BACV,WAAU;sCACX;;;;;;sCAGD,6LAAC;4BACC,MAAK;4BACL,SAAS;4BACT,UAAU;4BACV,WAAU;sCAET,aAAa,eAAe;;;;;;;;;;;;;;;;;;;;;;;AAMzC;KA3CgB"}},
    {"offset": {"line": 1283, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/components/EditAvatarModal.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState } from \"react\";\n\ninterface EditAvatarModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (newName: string) => void | Promise<void>;\n  currentName: string;\n  isSaving?: boolean;\n}\n\nexport function EditAvatarModal({\n  isOpen,\n  onClose,\n  onConfirm,\n  currentName,\n  isSaving = false,\n}: EditAvatarModalProps) {\n  const [newName, setNewName] = useState(currentName);\n\n  useEffect(() => {\n    if (isOpen) {\n      setNewName(currentName);\n    }\n  }, [isOpen, currentName]);\n\n  if (!isOpen) return null;\n\n  const handleConfirm = async () => {\n    if (!newName.trim()) {\n      return;\n    }\n    await onConfirm(newName.trim());\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    if (e.key === \"Enter\" && !isSaving && newName.trim()) {\n      handleConfirm();\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\">\n      <div className=\"mx-4 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl\">\n        <h2 className=\"mb-4 text-xl font-semibold text-gray-900\">\n          Редактировать имя\n        </h2>\n        <input\n          type=\"text\"\n          value={newName}\n          onChange={(e) => setNewName(e.target.value)}\n          onKeyDown={handleKeyDown}\n          disabled={isSaving}\n          placeholder=\"Введите новое имя\"\n          className=\"mb-6 w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-base text-gray-900 outline-none transition focus:border-gray-400 disabled:opacity-50\"\n          autoFocus\n        />\n        <div className=\"flex gap-3\">\n          <button\n            type=\"button\"\n            onClick={onClose}\n            disabled={isSaving}\n            className=\"flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50 disabled:opacity-50\"\n          >\n            Отмена\n          </button>\n          <button\n            type=\"button\"\n            onClick={handleConfirm}\n            disabled={isSaving || !newName.trim()}\n            className=\"flex-1 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700 disabled:opacity-50\"\n          >\n            {isSaving ? \"Сохраняем...\" : \"Сохранить\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AAEA;;;AAFA;;AAYO,SAAS,gBAAgB,EAC9B,MAAM,EACN,OAAO,EACP,SAAS,EACT,WAAW,EACX,WAAW,KAAK,EACK;;IACrB,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAC;IAEvC,IAAA,0KAAS;qCAAC;YACR,IAAI,QAAQ;gBACV,WAAW;YACb;QACF;oCAAG;QAAC;QAAQ;KAAY;IAExB,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,gBAAgB;QACpB,IAAI,CAAC,QAAQ,IAAI,IAAI;YACnB;QACF;QACA,MAAM,UAAU,QAAQ,IAAI;IAC9B;IAEA,MAAM,gBAAgB,CAAC;QACrB,IAAI,EAAE,GAAG,KAAK,WAAW,CAAC,YAAY,QAAQ,IAAI,IAAI;YACpD;QACF;IACF;IAEA,qBACE,6LAAC;QAAI,WAAU;kBACb,cAAA,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAG,WAAU;8BAA2C;;;;;;8BAGzD,6LAAC;oBACC,MAAK;oBACL,OAAO;oBACP,UAAU,CAAC,IAAM,WAAW,EAAE,MAAM,CAAC,KAAK;oBAC1C,WAAW;oBACX,UAAU;oBACV,aAAY;oBACZ,WAAU;oBACV,SAAS;;;;;;8BAEX,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BACC,MAAK;4BACL,SAAS;4BACT,UAAU;4BACV,WAAU;sCACX;;;;;;sCAGD,6LAAC;4BACC,MAAK;4BACL,SAAS;4BACT,UAAU,YAAY,CAAC,QAAQ,IAAI;4BACnC,WAAU;sCAET,WAAW,iBAAiB;;;;;;;;;;;;;;;;;;;;;;;AAMzC;GAnEgB;KAAA"}},
    {"offset": {"line": 1399, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/components/PhotoAvatarGrid.tsx"],"sourcesContent":["\"use client\";\n\nimport Image from \"next/image\";\nimport { useState, useRef, useEffect } from \"react\";\nimport type { PhotoAvatarRow } from \"../servers/UploadAvatar\";\nimport { DeletePhotoAvatar } from \"../servers/DeletePhotoAvatar\";\nimport { UpdateAvatarName } from \"../servers/UpdateAvatarName\";\nimport { DeleteAvatarModal } from \"./DeleteAvatarModal\";\nimport { EditAvatarModal } from \"./EditAvatarModal\";\n\ninterface PhotoAvatarGridProps {\n  avatars: PhotoAvatarRow[];\n  currentUserId?: string | null;\n  onAvatarDeleted?: () => void | Promise<void>;\n}\n\nexport function PhotoAvatarGrid({\n  avatars,\n  currentUserId,\n  onAvatarDeleted,\n}: PhotoAvatarGridProps) {\n  const [deletingId, setDeletingId] = useState<string | null>(null);\n  const [editingId, setEditingId] = useState<string | null>(null);\n  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\n  const [isEditModalOpen, setIsEditModalOpen] = useState(false);\n  const [openMenuId, setOpenMenuId] = useState<string | null>(null);\n  const [hoveredCardId, setHoveredCardId] = useState<string | null>(null);\n  const [avatarToDelete, setAvatarToDelete] = useState<{\n    avatar: PhotoAvatarRow;\n    key: string;\n  } | null>(null);\n  const [avatarToEdit, setAvatarToEdit] = useState<{\n    avatar: PhotoAvatarRow;\n    key: string;\n  } | null>(null);\n  const menuRefs = useRef<{ [key: string]: HTMLDivElement | null }>({});\n  const closeMenuTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  // Закрываем меню при клике вне его\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (openMenuId) {\n        const menuElement = menuRefs.current[openMenuId];\n        if (menuElement && !menuElement.contains(event.target as Node)) {\n          setOpenMenuId(null);\n        }\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, [openMenuId]);\n\n  // Очищаем таймер при размонтировании\n  useEffect(() => {\n    return () => {\n      if (closeMenuTimeoutRef.current) {\n        clearTimeout(closeMenuTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  const handleMenuClick = (key: string, event: React.MouseEvent) => {\n    event.stopPropagation();\n    setOpenMenuId(openMenuId === key ? null : key);\n  };\n\n  const handleEditClick = (avatar: PhotoAvatarRow, key: string) => {\n    setOpenMenuId(null);\n    setAvatarToEdit({ avatar, key });\n    setIsEditModalOpen(true);\n  };\n\n  const handleDeleteClick = (avatar: PhotoAvatarRow, key: string) => {\n    setOpenMenuId(null);\n    if (!currentUserId) {\n      alert(\"Не удалось определить пользователя\");\n      return;\n    }\n    setAvatarToDelete({ avatar, key });\n    setIsDeleteModalOpen(true);\n  };\n\n  const handleEditConfirm = async (newName: string) => {\n    if (!avatarToEdit || !currentUserId || !avatarToEdit.avatar.id) {\n      return;\n    }\n\n    const { avatar, key } = avatarToEdit;\n    \n    // Проверяем наличие id после деструктуризации\n    if (!avatar.id) {\n      return;\n    }\n\n    try {\n      setEditingId(key);\n      const result = await UpdateAvatarName({\n        uid: currentUserId,\n        recordId: avatar.id,\n        newName,\n      });\n\n      if (!result.success) {\n        throw new Error(result.error || \"Не удалось обновить имя\");\n      }\n\n      setIsEditModalOpen(false);\n      setAvatarToEdit(null);\n      await onAvatarDeleted?.();\n    } catch (error) {\n      console.error(\"[avatars] Ошибка редактирования:\", error);\n      alert(\n        `Ошибка при редактировании: ${\n          error instanceof Error ? error.message : \"Неизвестная ошибка\"\n        }`\n      );\n    } finally {\n      setEditingId(null);\n    }\n  };\n\n  const handleDeleteConfirm = async () => {\n    if (!avatarToDelete || !currentUserId) {\n      return;\n    }\n\n    const { avatar, key } = avatarToDelete;\n\n    try {\n      setDeletingId(key);\n      const result = await DeletePhotoAvatar({\n        uid: currentUserId,\n        recordId: avatar.id ?? null,\n        groupId: avatar.group_id ?? avatar.hey_gen_id ?? null,\n        imageKey: avatar.image_key,\n      });\n\n      if (!result.success) {\n        throw new Error(result.error || \"Не удалось удалить аватар\");\n      }\n\n      setIsDeleteModalOpen(false);\n      setAvatarToDelete(null);\n      await onAvatarDeleted?.();\n    } catch (error) {\n      console.error(\"[avatars] Ошибка удаления:\", error);\n      alert(\n        `Ошибка при удалении: ${\n          error instanceof Error ? error.message : \"Неизвестная ошибка\"\n        }`\n      );\n    } finally {\n      setDeletingId(null);\n    }\n  };\n\n  const handleDeleteCancel = () => {\n    setIsDeleteModalOpen(false);\n    setAvatarToDelete(null);\n  };\n\n  const handleEditCancel = () => {\n    setIsEditModalOpen(false);\n    setAvatarToEdit(null);\n  };\n\n  return (\n    <div className=\"grid w-full gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4\">\n      {avatars.map((avatar) => {\n        const key =\n          avatar.id ??\n          avatar.hey_gen_id ??\n          avatar.group_id ??\n          `${avatar.uid}-${avatar.image_key}`;\n\n        const isHovered = hoveredCardId === key;\n        const showMenuButton = isHovered || openMenuId === key;\n\n        return (\n          <article\n            key={key}\n            className=\"group relative rounded-3xl border border-gray-100 bg-white p-4 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:-translate-y-2 hover:shadow-lg\"\n            onMouseLeave={() => {\n              setHoveredCardId(null);\n              // Закрываем меню через 1 секунду после ухода курсора\n              if (closeMenuTimeoutRef.current) {\n                clearTimeout(closeMenuTimeoutRef.current);\n              }\n              closeMenuTimeoutRef.current = setTimeout(() => {\n                if (openMenuId === key) {\n                  setOpenMenuId(null);\n                }\n              }, 500);\n            }}\n            onMouseEnter={() => {\n              setHoveredCardId(key);\n              // Отменяем закрытие меню если курсор вернулся\n              if (closeMenuTimeoutRef.current) {\n                clearTimeout(closeMenuTimeoutRef.current);\n                closeMenuTimeoutRef.current = null;\n              }\n            }}\n          >\n            <p className=\"mb-3 text-center text-xl font-semibold text-gray-900\">\n              {avatar.name}\n            </p>\n            <div className=\"relative aspect-[3/4] w-full overflow-hidden rounded-2xl\">\n              <Image\n                src={avatar.photo}\n                alt={`Фото аватара ${avatar.name}`}\n                fill\n                sizes=\"(min-width: 1280px) 25vw, (min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw\"\n                className=\"object-contain\"\n                unoptimized\n              />\n              {/* Три точки меню */}\n              <div className=\"absolute right-3 top-3\">\n              <button\n                type=\"button\"\n                  onClick={(e) => handleMenuClick(key, e)}\n                  className={`flex h-8 w-8 items-center justify-center rounded-full bg-white/90 text-gray-600 shadow-md transition-all duration-200 hover:bg-white hover:text-gray-900 ${\n                    showMenuButton ? \"opacity-100\" : \"opacity-0\"\n                  }`}\n                  aria-label=\"Меню\"\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    viewBox=\"0 0 24 24\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth={2.5}\n                    className=\"h-4 w-4\"\n                  >\n                    <circle cx=\"5\" cy=\"12\" r=\"1.5\" />\n                    <circle cx=\"12\" cy=\"12\" r=\"1.5\" />\n                    <circle cx=\"19\" cy=\"12\" r=\"1.5\" />\n                  </svg>\n                </button>\n                {/* Выпадающее меню */}\n                {openMenuId === key && (\n                  <div\n                    ref={(el) => {\n                      menuRefs.current[key] = el;\n                    }}\n                    className=\"absolute right-0 top-10 z-50 min-w-[160px] rounded-lg border border-gray-200 bg-white shadow-lg\"\n                  >\n                    <button\n                      type=\"button\"\n                      onClick={() => handleEditClick(avatar, key)}\n                      disabled={editingId === key || deletingId === key}\n                      className=\"w-full rounded-t-lg px-4 py-2 text-left text-sm text-gray-700 transition hover:bg-gray-50 disabled:opacity-50\"\n                    >\n                      Редактировать\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() => handleDeleteClick(avatar, key)}\n                      disabled={editingId === key || deletingId === key}\n                      className=\"w-full rounded-b-lg px-4 py-2 text-left text-sm text-red-600 transition hover:bg-red-50 disabled:opacity-50\"\n                    >\n                      Удалить\n                    </button>\n                  </div>\n                )}\n              </div>\n            </div>\n            {avatar.created_at && (\n              <p className=\"mt-3 text-center text-xs text-gray-400\">\n                {new Intl.DateTimeFormat(\"ru-RU\", {\n                  dateStyle: \"medium\",\n                  timeStyle: \"short\",\n                }).format(new Date(avatar.created_at))}\n              </p>\n            )}\n          </article>\n        );\n      })}\n      <DeleteAvatarModal\n        isOpen={isDeleteModalOpen}\n        onClose={handleDeleteCancel}\n        onConfirm={handleDeleteConfirm}\n        avatarName={avatarToDelete?.avatar.name ?? \"\"}\n        isDeleting={avatarToDelete !== null && deletingId === avatarToDelete.key}\n      />\n      <EditAvatarModal\n        isOpen={isEditModalOpen}\n        onClose={handleEditCancel}\n        onConfirm={handleEditConfirm}\n        currentName={avatarToEdit?.avatar.name ?? \"\"}\n        isSaving={avatarToEdit !== null && editingId === avatarToEdit.key}\n      />\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1764, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { supabase } from \"@/lib/supabaseClient\";\nimport { getPrefetchedAvatars, clearPrefetchCache } from \"@/lib/prefetchAvatars\";\n\nimport { EmptyState } from \"@/components/EmptyState\";\nimport { Header } from \"@/components/ui/Header\";\nimport { CosmoLoader } from \"@/components/ui/CosmoLoader\";\nimport { AvatarUploadModal } from \"./components/AvatarUploadModal\";\nimport { PhotoAvatarGrid } from \"./components/PhotoAvatarGrid\";\nimport type { PhotoAvatarRow } from \"./servers/UploadAvatar\";\n\nexport default function AvatarsPage() {\n  const router = useRouter();\n  const [isModalOpen, setIsModalOpen] = useState(false);\n  const [isFetchingAvatars, setIsFetchingAvatars] = useState(true);\n  const [photoAvatars, setPhotoAvatars] = useState<PhotoAvatarRow[]>([]);\n  const [currentUserId, setCurrentUserId] = useState<string | null>(null);\n\n  useEffect(() => {\n    let isMounted = true;\n\n    const fetchPhotoAvatars = async () => {\n      // Проверяем prefetch кеш\n      const prefetchedData = getPrefetchedAvatars();\n      if (prefetchedData) {\n        // Используем prefetch данные сразу\n        setPhotoAvatars(prefetchedData);\n        setIsFetchingAvatars(false);\n        clearPrefetchCache(); // Очищаем кеш после использования\n        \n        // Получаем userId для установки\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n        \n        if (!isMounted) return;\n        \n      if (!user) {\n        router.push(\"/login\");\n          setCurrentUserId(null);\n          setPhotoAvatars([]);\n          return;\n        }\n        \n        setCurrentUserId(user.id);\n        return;\n      }\n\n    setIsFetchingAvatars(true);\n\n      // Получаем пользователя\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n      if (!isMounted) return;\n\n    if (!user) {\n        router.push(\"/login\");\n      setCurrentUserId(null);\n      setPhotoAvatars([]);\n      setIsFetchingAvatars(false);\n      return;\n    }\n\n    setCurrentUserId(user.id);\n\n      // Загружаем аватары\n      const { data, error } = await supabase\n        .from(\"photo_avatars\")\n        .select(\"*\")\n        .eq(\"uid\", user.id)\n        .order(\"created_at\", { ascending: false });\n\n      if (!isMounted) return;\n\n      if (error) {\n        console.error(\"[avatars] Ошибка загрузки аватаров:\", error);\n      } else {\n        setPhotoAvatars(data ?? []);\n      }\n      setIsFetchingAvatars(false);\n    };\n\n    fetchPhotoAvatars();\n\n    return () => {\n      isMounted = false;\n    };\n  }, [router]);\n\n  const refetchPhotoAvatars = useCallback(async () => {\n    if (!currentUserId) return;\n\n    // Очищаем prefetch кеш при обновлении\n    clearPrefetchCache();\n\n    const { data, error } = await supabase\n      .from(\"photo_avatars\")\n      .select(\"*\")\n      .eq(\"uid\", currentUserId)\n      .order(\"created_at\", { ascending: false });\n\n    if (error) {\n      console.error(\"[avatars] Ошибка загрузки аватаров:\", error);\n    } else {\n      setPhotoAvatars(data ?? []);\n    }\n  }, [currentUserId]);\n\n  const hasPhotoAvatars = photoAvatars.length > 0;\n\n  const content = (() => {\n    if (isFetchingAvatars) {\n      return (\n        <EmptyState title=\"\" description=\"\">\n          <div className=\"mt-px flex justify-center\">\n            <CosmoLoader ariaLabel=\"Загружаем фото-аватары...\" />\n        </div>\n        </EmptyState>\n      );\n    }\n\n    if (!hasPhotoAvatars) {\n      return <EmptyState />;\n    }\n\n    return (\n      <PhotoAvatarGrid\n        avatars={photoAvatars}\n        currentUserId={currentUserId}\n        onAvatarDeleted={refetchPhotoAvatars}\n      />\n    );\n  })();\n\n  const hasReachedLimit = photoAvatars.length >= 3;\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <Header />\n      <div className=\"mx-auto flex w-full max-w-[1350px] items-center justify-between px-6 pt-8\">\n        <h1 className=\"text-2xl font-bold text-gray-900\">Мои аватары</h1>\n        <button\n          type=\"button\"\n          onClick={() => {\n            if (!hasReachedLimit) {\n              setIsModalOpen(true);\n            }\n          }}\n          disabled={hasReachedLimit}\n          className=\"min-w-[170px] rounded-lg bg-blue-600 px-4 py-3 text-sm font-semibold text-white transition hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:bg-blue-600\"\n          title={hasReachedLimit ? \"Максимальное количество аватаров (3) достигнуто\" : \"Создать аватар\"}\n        >\n          Создать аватар\n        </button>\n      </div>\n      <div className=\"mx-auto flex w-full max-w-[1350px] px-6 pt-4\">\n        <div className=\"w-full rounded-lg border border-amber-200 bg-amber-50/50 px-4 py-3\">\n          <div className=\"flex items-start gap-3\">\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              className=\"h-5 w-5 flex-shrink-0 text-amber-600 mt-0.5\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n              strokeWidth={2}\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n              />\n            </svg>\n            <div className=\"flex-1\">\n              <p className=\"text-sm font-medium text-amber-900\">\n                Демо-режим\n              </p>\n              <p className=\"mt-1 text-xs text-amber-700\">\n                В демо-режиме можно создать максимум 3 аватара\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n      <main className=\"mx-auto flex w-full max-w-[1350px] justify-center px-6 py-12\">\n        {content}\n      </main>\n      <AvatarUploadModal\n        isOpen={isModalOpen}\n        onClose={() => setIsModalOpen(false)}\n        onAvatarUploaded={refetchPhotoAvatars}\n      />\n    </div>\n  );\n}"],"names":[],"mappings":"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"}}]
}
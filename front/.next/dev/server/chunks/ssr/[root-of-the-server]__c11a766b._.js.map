{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/lib/supabaseClient.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || \"\";\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || \"\";\n\n// Создаем клиент только если переменные окружения установлены\n// Во время сборки может не быть переменных окружения\nexport const supabase = supabaseUrl && supabaseAnonKey\n  ? createClient(supabaseUrl, supabaseAnonKey)\n  : createClient(\"https://placeholder.supabase.co\", \"placeholder-key\");\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,gEAAwC;AAC5D,MAAM,kBAAkB,iNAA6C;AAI9D,MAAM,WAAW,uCACpB,IAAA,uMAAY,EAAC,aAAa,mBAC1B"}},
    {"offset": {"line": 41, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/servers/UploadAvatar.ts"],"sourcesContent":["\"use server\";\n\nimport { Buffer } from \"buffer\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport interface PhotoAvatarRow {\n  id?: string;\n  uid: string;\n  name: string;\n  photo: string;\n  image_key: string;\n  hey_gen_id: string | null;\n  group_id: string | null;\n  status: \"done\" | \"error\";\n  created_at?: string;\n}\n\ninterface UploadAvatarSuccess {\n  success: true;\n  avatar: PhotoAvatarRow;\n}\n\ninterface UploadAvatarFailure {\n  success: false;\n  error: string;\n}\n\ntype UploadAvatarResult = UploadAvatarSuccess | UploadAvatarFailure;\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\nconst heygenApiKey = process.env.HEYGEN_API_KEY;\n\nif (!supabaseUrl) {\n  throw new Error(\"NEXT_PUBLIC_SUPABASE_URL не задан\");\n}\n\nif (!supabaseServiceRoleKey) {\n  throw new Error(\"SUPABASE_SERVICE_ROLE_KEY не задан\");\n}\n\nconst supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey);\n\nasync function uploadPhotoToHeygen(file: File) {\n  if (!heygenApiKey) {\n    throw new Error(\"HEYGEN_API_KEY не задан\");\n  }\n\n  const buffer = Buffer.from(await file.arrayBuffer());\n  const response = await fetch(\"https://upload.heygen.com/v1/asset\", {\n    method: \"POST\",\n    headers: {\n      \"X-Api-Key\": heygenApiKey,\n      \"Content-Type\": file.type || \"application/octet-stream\",\n    },\n    body: buffer,\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Ошибка загрузки фото: ${errorText || response.statusText}`\n    );\n  }\n\n  const json = await response.json();\n  const payload = Array.isArray(json) ? json[0] : json;\n  const data = payload?.data;\n\n  if (!data?.image_key || !data?.url) {\n    throw new Error(\"Некорректный ответ Heygen при загрузке фото\");\n  }\n\n  return {\n    imageKey: data.image_key as string,\n    photoUrl: data.url as string,\n  };\n}\n\nasync function createPhotoAvatarInHeygen(name: string, imageKey: string) {\n  if (!heygenApiKey) {\n    throw new Error(\"HEYGEN_API_KEY не задан\");\n  }\n\n  const response = await fetch(\n    \"https://api.heygen.com/v2/photo_avatar/avatar_group/create\",\n    {\n      method: \"POST\",\n      headers: {\n        \"X-Api-Key\": heygenApiKey,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        name,\n        image_key: imageKey,\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(\n      `Ошибка создания фото-аватара: ${errorText || response.statusText}`\n    );\n  }\n\n  const json = await response.json();\n  const payload = Array.isArray(json) ? json[0] : json;\n\n  return {\n    error: payload?.error ?? null,\n    data: payload?.data ?? null,\n  };\n}\n\nexport async function UploadAvatar(formData: FormData): Promise<UploadAvatarResult> {\n  try {\n    const uid = formData.get(\"uid\");\n    const name = formData.get(\"avatar_name\");\n    const file = formData.get(\"photo\");\n\n    if (typeof uid !== \"string\" || !uid) {\n      return { success: false, error: \"Не удалось определить пользователя\" };\n    }\n\n    if (typeof name !== \"string\" || !name.trim()) {\n      return { success: false, error: \"Введите имя аватара\" };\n    }\n\n    if (!(file instanceof File)) {\n      return { success: false, error: \"Файл не найден\" };\n    }\n\n    const trimmedName = name.trim();\n\n    const { imageKey, photoUrl } = await uploadPhotoToHeygen(file);\n    const createResult = await createPhotoAvatarInHeygen(\n      trimmedName,\n      imageKey\n    );\n\n    const status: \"done\" | \"error\" = createResult.error ? \"error\" : \"done\";\n    const record: PhotoAvatarRow = {\n      uid,\n      name: trimmedName,\n      photo: photoUrl,\n      image_key: imageKey,\n      hey_gen_id: createResult.data?.id ?? null,\n      group_id:\n        createResult.data?.group_id ??\n        createResult.data?.id ??\n        createResult.data?.group ??\n        null,\n      status,\n    };\n\n    const { data, error } = await supabaseAdmin\n      .from(\"photo_avatars\")\n      .insert(record)\n      .select()\n      .single();\n\n    if (error) {\n      throw new Error(error.message);\n    }\n\n    return { success: true, avatar: data as PhotoAvatarRow };\n  } catch (error) {\n    const message =\n      error instanceof Error ? error.message : \"Неизвестная ошибка сервера\";\n    console.error(\"[UploadAvatar]\", message);\n    return { success: false, error: message };\n  }\n}\n\n"],"names":[],"mappings":";;;;;;;IAmHsB,eAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/avatars/components/AvatarUploadModal.tsx"],"sourcesContent":["\"use client\";\n\nimport Image from \"next/image\";\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { supabase } from \"@/lib/supabaseClient\";\nimport { UploadAvatar } from \"../servers/UploadAvatar\";\n\ninterface AvatarUploadModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onAvatarUploaded?: () => void | Promise<void>;\n}\n\nconst MAX_FILE_SIZE = 10 * 1024 * 1024;\nconst ALLOWED_TYPES = [\"image/jpeg\", \"image/jpg\", \"image/png\"];\n\nconst sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\n\nexport function AvatarUploadModal({\n  isOpen,\n  onClose,\n  onAvatarUploaded,\n}: AvatarUploadModalProps) {\n  const [avatarName, setAvatarName] = useState(\"\");\n  const [dragActive, setDragActive] = useState(false);\n  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);\n  const [previewUrls, setPreviewUrls] = useState<string[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const progressIntervalRef = useRef<ReturnType<typeof setInterval> | null>(\n    null\n  );\n  const isMountedRef = useRef(true);\n\n  const stopProgressLoop = useCallback(() => {\n    if (progressIntervalRef.current) {\n      clearInterval(progressIntervalRef.current);\n      progressIntervalRef.current = null;\n    }\n  }, []);\n\n  const startProgressLoop = useCallback(() => {\n    stopProgressLoop();\n    const startTime = Date.now();\n    progressIntervalRef.current = setInterval(() => {\n      setProgress((prev) => {\n        const elapsed = Date.now() - startTime;\n        const nextValue = Math.min(90, (elapsed / 20000) * 90);\n        return nextValue > prev ? nextValue : prev;\n      });\n    }, 200);\n  }, [stopProgressLoop]);\n\n  useEffect(() => {\n    return () => {\n      previewUrls.forEach((url) => URL.revokeObjectURL(url));\n    };\n  }, [previewUrls]);\n\n  useEffect(() => {\n    return () => {\n      isMountedRef.current = false;\n      stopProgressLoop();\n    };\n  }, [stopProgressLoop]);\n\n  const resetState = useCallback(() => {\n    setAvatarName(\"\");\n    setSelectedFiles([]);\n    previewUrls.forEach((url) => URL.revokeObjectURL(url));\n    setPreviewUrls([]);\n    setProgress(0);\n    stopProgressLoop();\n  }, [previewUrls, stopProgressLoop]);\n\n  const closeModal = useCallback(() => {\n    resetState();\n    onClose();\n  }, [onClose, resetState]);\n\n  const validateFileTypes = (files: File[]): File[] => {\n    const validFiles: File[] = [];\n    const invalidFormat: string[] = [];\n    const tooLarge: string[] = [];\n\n    files.forEach((file) => {\n      if (!ALLOWED_TYPES.includes(file.type.toLowerCase())) {\n        invalidFormat.push(file.name);\n      } else if (file.size > MAX_FILE_SIZE) {\n        tooLarge.push(\n          `${file.name} (${(file.size / 1024 / 1024).toFixed(1)} МБ)`\n        );\n      } else {\n        validFiles.push(file);\n      }\n    });\n\n    if (invalidFormat.length || tooLarge.length) {\n      let message = \"\";\n      if (invalidFormat.length) {\n        message += `Файлы с неподдерживаемым форматом:\\n${invalidFormat.join(\n          \"\\n\"\n        )}\\n\\nДопустимы только PNG или JPG.\\n\\n`;\n      }\n      if (tooLarge.length) {\n        message += `Файлы превышают лимит 10 МБ:\\n${tooLarge.join(\"\\n\")}`;\n      }\n      alert(message.trim());\n    }\n\n    return validFiles;\n  };\n\n  const createPreviews = useCallback(\n    (files: File[]) => {\n      previewUrls.forEach((url) => URL.revokeObjectURL(url));\n      const limitedFiles = files.slice(0, 1);\n      setSelectedFiles(limitedFiles);\n      setPreviewUrls(limitedFiles.map((file) => URL.createObjectURL(file)));\n    },\n    [previewUrls]\n  );\n\n  const handleDrag = useCallback((event: React.DragEvent) => {\n    event.preventDefault();\n    event.stopPropagation();\n    if (event.type === \"dragenter\" || event.type === \"dragover\") {\n      setDragActive(true);\n    } else if (event.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  }, []);\n\n  const handleDrop = useCallback(\n    (event: React.DragEvent) => {\n      event.preventDefault();\n      event.stopPropagation();\n      setDragActive(false);\n      if (event.dataTransfer.files?.[0]) {\n        const validFiles = validateFileTypes([event.dataTransfer.files[0]]);\n        if (validFiles.length) {\n          createPreviews(validFiles);\n        }\n      }\n    },\n    [createPreviews]\n  );\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    if (event.target.files?.[0]) {\n      const validFiles = validateFileTypes([event.target.files[0]]);\n      if (validFiles.length) {\n        createPreviews(validFiles);\n      }\n    }\n  };\n\n  const removeFile = (index: number) => {\n    const newPreviews = previewUrls.filter((_, i) => i !== index);\n    const revokedUrl = previewUrls[index];\n    if (revokedUrl) {\n      URL.revokeObjectURL(revokedUrl);\n    }\n    setPreviewUrls(newPreviews);\n    setSelectedFiles(selectedFiles.filter((_, i) => i !== index));\n  };\n\n  const waitForAvatarCompletion = useCallback(\n    async (recordId?: string | null, initialStatus?: \"done\" | \"error\") => {\n      if (!recordId) {\n        console.warn(\"[avatars] Нет ID записи для проверки статуса\");\n        return true;\n      }\n\n      // Если статус уже done сразу после создания, не ждём\n      if (initialStatus === \"done\") {\n        console.log(\"[avatars] Статус уже 'done', не требуется ожидание\");\n        return true;\n      }\n\n      if (initialStatus === \"error\") {\n        console.error(\"[avatars] Статус 'error' при создании записи\");\n        return false;\n      }\n\n      const timeoutMs = 2 * 60 * 1000;\n      const pollDelayMs = 2000;\n      const deadline = Date.now() + timeoutMs;\n      let attemptCount = 0;\n\n      console.log(`[avatars] Начинаем проверку статуса для записи ${recordId}`);\n\n      while (isMountedRef.current && Date.now() < deadline) {\n        attemptCount++;\n        const { data, error } = await supabase\n          .from(\"photo_avatars\")\n          .select(\"status\")\n          .eq(\"id\", recordId)\n          .single();\n\n        if (error) {\n          console.error(\n            `[avatars] Ошибка проверки статуса (попытка ${attemptCount}):`,\n            error\n          );\n          // Если запись не найдена, продолжаем попытки\n          if (error.code === \"PGRST116\") {\n            await sleep(pollDelayMs);\n            continue;\n          }\n        } else if (data?.status === \"done\") {\n          console.log(\n            `[avatars] Статус 'done' получен после ${attemptCount} попыток`\n          );\n          return true;\n        } else if (data?.status === \"error\") {\n          console.error(\n            `[avatars] Статус 'error' получен после ${attemptCount} попыток`\n          );\n          return false;\n        } else {\n          console.log(\n            `[avatars] Попытка ${attemptCount}: статус = ${data?.status || \"неизвестен\"}`\n          );\n        }\n\n        await sleep(pollDelayMs);\n      }\n\n      console.warn(\n        `[avatars] Таймаут ожидания статуса после ${attemptCount} попыток`\n      );\n      return false;\n    },\n    []\n  );\n\n  const handleUpload = async () => {\n    if (isUploading || !avatarName.trim() || selectedFiles.length === 0) {\n      return;\n    }\n\n    setIsUploading(true);\n    setProgress(0);\n    startProgressLoop();\n\n    try {\n      const {\n        data: { user },\n        error: authError,\n      } = await supabase.auth.getUser();\n\n      if (authError) {\n        throw new Error(authError.message);\n      }\n\n      if (!user) {\n        throw new Error(\"Пользователь не найден\");\n      }\n\n      const formData = new FormData();\n      formData.append(\"avatar_name\", avatarName.trim());\n      formData.append(\"uid\", user.id);\n      formData.append(\"photo\", selectedFiles[0]);\n\n      const result = await UploadAvatar(formData);\n\n      if (!result.success) {\n        throw new Error(result.error);\n      }\n\n      // Проверяем статус сразу после создания\n      const initialStatus = result.avatar.status;\n      console.log(\n        `[avatars] Аватар создан с ID ${result.avatar.id}, начальный статус: ${initialStatus}`\n      );\n\n      // Если статус уже done, сразу устанавливаем прогресс в 100%\n      if (initialStatus === \"done\") {\n        stopProgressLoop();\n        setProgress(100);\n        await onAvatarUploaded?.();\n        await sleep(400);\n        closeModal();\n        return;\n      }\n\n      const isReady = await waitForAvatarCompletion(\n        result.avatar.id ?? null,\n        initialStatus\n      );\n\n      if (!isReady) {\n        throw new Error(\n          \"Не удалось дождаться завершения обработки аватара. Попробуйте позже.\"\n        );\n      }\n\n      stopProgressLoop();\n      setProgress(100);\n      await onAvatarUploaded?.();\n      await sleep(400);\n      closeModal();\n    } catch (error) {\n      console.error(\"[avatars] Ошибка при загрузке:\", error);\n      alert(\n        `Ошибка при загрузке: ${\n          error instanceof Error ? error.message : \"Неизвестная ошибка\"\n        }`\n      );\n      setProgress(0);\n    } finally {\n      stopProgressLoop();\n      setIsUploading(false);\n    }\n  };\n\n  const dropZoneClasses = useMemo(() => {\n    const base =\n      \"rounded-2xl border border-dashed border-blue-400/50 bg-blue-50/30 p-6 text-center transition-all duration-200\";\n    if (dragActive) {\n      return `${base} shadow-lg -translate-y-0.5`;\n    }\n    return `${base} hover:shadow-md hover:-translate-y-0.5`;\n  }, [dragActive]);\n\n  if (!isOpen) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-8\">\n      <div className=\"w-full max-w-lg rounded-[32px] bg-white shadow-2xl\">\n        <div className=\"relative flex items-center justify-center border-b px-6 py-4\">\n          <h2 className=\"text-lg font-semibold text-gray-900\">\n            Загрузите фото для аватара\n          </h2>\n          <button\n            type=\"button\"\n            onClick={closeModal}\n            className=\"absolute right-6 rounded-full p-1 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600\"\n          >\n            <span className=\"sr-only\">Закрыть</span>✕\n          </button>\n        </div>\n\n        <div className=\"max-h-[70vh] overflow-y-auto px-6 py-6 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 [&::-webkit-scrollbar-thumb]:rounded-full\">\n          <div className=\"space-y-6 text-sm text-gray-600\">\n            <div>\n              <label\n                htmlFor=\"avatar-name\"\n                className=\"mb-2 block text-xs font-semibold uppercase tracking-wide text-gray-500\"\n              >\n                Имя аватара\n              </label>\n              <input\n                id=\"avatar-name\"\n                value={avatarName}\n                onChange={(event) => setAvatarName(event.target.value)}\n                placeholder=\"Придумайте любое имя\"\n                className=\"w-full rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-base text-gray-900 outline-none transition focus:border-gray-400\"\n              />\n            </div>\n\n            <div\n              className={dropZoneClasses}\n              onDragEnter={handleDrag}\n              onDragLeave={handleDrag}\n              onDragOver={handleDrag}\n              onDrop={handleDrop}\n            >\n              <div className=\"mx-auto flex max-w-sm flex-col items-center gap-3 text-gray-700\">\n                <div className=\"rounded-2xl border border-blue-200 bg-white p-3 text-blue-500\">\n                  ↑\n                </div>\n                <p className=\"text-base font-semibold\">\n                  Перетащите фотографию сюда\n                </p>\n                <p className=\"text-xs text-gray-500\">PNG или JPG до 10 МБ</p>\n                <button\n                  type=\"button\"\n                  className=\"rounded-lg bg-blue-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-blue-500\"\n                  onClick={() => fileInputRef.current?.click()}\n                >\n                  Выбрать файл\n                </button>\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  accept=\"image/jpeg,image/jpg,image/png\"\n                  className=\"hidden\"\n                  onChange={handleFileSelect}\n                />\n              </div>\n            </div>\n\n            {selectedFiles.length > 0 && (\n              <div className=\"rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-700\">\n                {selectedFiles.map((file, index) => (\n                  <div\n                    key={`${file.name}-${index}`}\n                    className=\"flex items-center justify-between gap-3\"\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      {previewUrls[index] && (\n                        <Image\n                          src={previewUrls[index]}\n                          alt={file.name}\n                          width={40}\n                          height={40}\n                          className=\"h-10 w-10 rounded-lg object-cover\"\n                          unoptimized\n                        />\n                      )}\n                      <div className=\"truncate\">{file.name}</div>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => removeFile(index)}\n                      className=\"text-gray-400 transition hover:text-red-500\"\n                    >\n                      Удалить\n                    </button>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            <div className=\"rounded-2xl border border-gray-100 bg-gray-50 p-4 text-xs text-gray-600\">\n              <p className=\"mb-3 text-sm font-semibold text-gray-800\">\n                Требования к фото\n              </p>\n              <ul className=\"space-y-2\">\n                <li>Фото в анфас (лицо прямо в камеру)</li>\n                <li>Хорошее качество изображения, чёткое и резкое</li>\n                <li>Без теней на лице, равномерное освещение</li>\n                <li>Без других людей на фото, только вы</li>\n                <li>Без открытой улыбки, нейтральное выражение лица</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex flex-col gap-3 border-t border-gray-200 px-6 py-4 text-sm text-gray-500 sm:flex-row sm:items-center sm:justify-between sm:gap-4\">\n          <div className=\"flex flex-1 items-center gap-4\">\n            <button\n              type=\"button\"\n              onClick={closeModal}\n              className=\"rounded-lg border border-gray-200 px-5 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50\"\n              disabled={isUploading}\n            >\n              Отмена\n            </button>\n            {(isUploading || progress > 0) && (\n              <div className=\"relative h-1 flex-1 overflow-hidden rounded-full bg-gray-200\">\n                <div\n                  className=\"absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-[#FFB347] via-[#FFC94C] to-[#FFB347] transition-[width] duration-500 ease-out\"\n                  style={{ width: `${progress}%` }}\n                  aria-hidden=\"true\"\n                />\n              </div>\n            )}\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleUpload}\n            disabled={\n              isUploading || !avatarName.trim() || selectedFiles.length === 0\n            }\n            className=\"rounded-lg bg-blue-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-blue-500 disabled:cursor-not-allowed disabled:bg-gray-300 sm:ml-auto\"\n          >\n            {isUploading ? \"Создаем...\" : \"Создать\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 662, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/voices/components/VoiceCreateModal.tsx"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { supabase } from \"@/lib/supabaseClient\";\n\ninterface VoiceCreateModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onVoiceCreated?: () => void | Promise<void>;\n}\n\nconst MAX_FILE_SIZE = 50 * 1024 * 1024; // 50 МБ\nconst ALLOWED_TYPES = [\"audio/mpeg\", \"audio/mp3\", \"audio/wav\", \"audio/webm\", \"audio/ogg\"];\nconst MAX_DESCRIPTION_LENGTH = 100;\n\nexport function VoiceCreateModal({\n  isOpen,\n  onClose,\n  onVoiceCreated,\n}: VoiceCreateModalProps) {\n  const [voiceName, setVoiceName] = useState(\"\");\n  const [voiceDescription, setVoiceDescription] = useState(\"\");\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [isRecording, setIsRecording] = useState(false);\n  const [recordedBlob, setRecordedBlob] = useState<Blob | null>(null);\n  const [recordedAudioUrl, setRecordedAudioUrl] = useState<string | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const [isWaiting, setIsWaiting] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [dragActive, setDragActive] = useState(false);\n  const progressIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  \n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const audioChunksRef = useRef<Blob[]>([]);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const audioPlayerRef = useRef<HTMLAudioElement>(null);\n\n  const stopProgressLoop = useCallback(() => {\n    if (progressIntervalRef.current) {\n      clearInterval(progressIntervalRef.current);\n      progressIntervalRef.current = null;\n    }\n  }, []);\n\n  const startProgressLoop = useCallback(() => {\n    stopProgressLoop();\n    setProgress(0);\n    const startTime = Date.now();\n    progressIntervalRef.current = setInterval(() => {\n      const elapsed = Date.now() - startTime;\n      const nextValue = Math.min(100, (elapsed / 15000) * 100);\n      setProgress(nextValue);\n    }, 50);\n  }, [stopProgressLoop]);\n\n  const resetState = useCallback(() => {\n    setVoiceName(\"\");\n    setVoiceDescription(\"\");\n    setSelectedFile(null);\n    setRecordedBlob(null);\n    // Очищаем URL для освобождения памяти\n    if (recordedAudioUrl) {\n      URL.revokeObjectURL(recordedAudioUrl);\n    }\n    setRecordedAudioUrl(null);\n    setIsRecording(false);\n    setIsWaiting(false);\n    setProgress(0);\n    stopProgressLoop();\n    audioChunksRef.current = [];\n    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== \"inactive\") {\n      mediaRecorderRef.current.stop();\n    }\n    if (mediaRecorderRef.current?.stream) {\n      mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());\n    }\n  }, [recordedAudioUrl, stopProgressLoop]);\n\n  const closeModal = useCallback(() => {\n    resetState();\n    onClose();\n  }, [onClose, resetState]);\n\n  useEffect(() => {\n    return () => {\n      if (mediaRecorderRef.current?.stream) {\n        mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());\n      }\n      // Очищаем URL при размонтировании\n      if (recordedAudioUrl) {\n        URL.revokeObjectURL(recordedAudioUrl);\n      }\n      stopProgressLoop();\n    };\n  }, [recordedAudioUrl, stopProgressLoop]);\n\n  const validateFile = (file: File): boolean => {\n    if (!ALLOWED_TYPES.includes(file.type.toLowerCase())) {\n      alert(\"Неподдерживаемый формат файла. Допустимы только MP3, WAV, WebM или OGG.\");\n      return false;\n    }\n    if (file.size > MAX_FILE_SIZE) {\n      alert(`Файл превышает лимит 50 МБ. Размер файла: ${(file.size / 1024 / 1024).toFixed(1)} МБ`);\n      return false;\n    }\n    return true;\n  };\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    if (event.target.files?.[0]) {\n      const file = event.target.files[0];\n      if (validateFile(file)) {\n        setSelectedFile(file);\n        setRecordedBlob(null); // Сбрасываем запись если выбрали файл\n      }\n    }\n  };\n\n  const handleDrag = useCallback((event: React.DragEvent) => {\n    event.preventDefault();\n    event.stopPropagation();\n    if (event.type === \"dragenter\" || event.type === \"dragover\") {\n      setDragActive(true);\n    } else if (event.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  }, []);\n\n  const handleDrop = useCallback((event: React.DragEvent) => {\n    event.preventDefault();\n    event.stopPropagation();\n    setDragActive(false);\n    if (event.dataTransfer.files?.[0]) {\n      const file = event.dataTransfer.files[0];\n      if (validateFile(file)) {\n        setSelectedFile(file);\n        setRecordedBlob(null); // Сбрасываем запись если выбрали файл\n      }\n    }\n  }, []);\n\n  const startRecording = async () => {\n    try {\n      // Проверяем доступность API\n      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\n        alert(\n          \"Ваш браузер не поддерживает запись с микрофона. Пожалуйста, используйте современный браузер (Chrome, Firefox, Edge).\"\n        );\n        return;\n      }\n\n      // Проверяем разрешения перед запросом\n      try {\n        const permissionStatus = await navigator.permissions.query({ name: \"microphone\" as PermissionName });\n        if (permissionStatus.state === \"denied\") {\n          alert(\n            \"Доступ к микрофону запрещен. Пожалуйста, разрешите доступ к микрофону в настройках браузера и обновите страницу.\"\n          );\n          return;\n        }\n      } catch (permError) {\n        // Некоторые браузеры не поддерживают permissions API, продолжаем\n        console.log(\"Permissions API не поддерживается, продолжаем запрос\");\n      }\n\n      const stream = await navigator.mediaDevices.getUserMedia({ \n        audio: {\n          echoCancellation: true,\n          noiseSuppression: true,\n          autoGainControl: true,\n        } \n      });\n      \n      const mediaRecorder = new MediaRecorder(stream, {\n        mimeType: MediaRecorder.isTypeSupported(\"audio/webm\") \n          ? \"audio/webm\" \n          : MediaRecorder.isTypeSupported(\"audio/webm;codecs=opus\")\n          ? \"audio/webm;codecs=opus\"\n          : \"audio/mp4\"\n      });\n      \n      mediaRecorderRef.current = mediaRecorder;\n      audioChunksRef.current = [];\n\n      mediaRecorder.ondataavailable = (event) => {\n        if (event.data.size > 0) {\n          audioChunksRef.current.push(event.data);\n        }\n      };\n\n      mediaRecorder.onstop = () => {\n        const mimeType = mediaRecorder.mimeType || \"audio/webm\";\n        const audioBlob = new Blob(audioChunksRef.current, { type: mimeType });\n        setRecordedBlob(audioBlob);\n        \n        // Создаем URL для воспроизведения\n        const audioUrl = URL.createObjectURL(audioBlob);\n        setRecordedAudioUrl(audioUrl);\n        \n        setSelectedFile(null); // Сбрасываем файл если записали\n        stream.getTracks().forEach(track => track.stop());\n      };\n\n      mediaRecorder.onerror = (event) => {\n        console.error(\"Ошибка записи:\", event);\n        setIsRecording(false);\n        stream.getTracks().forEach(track => track.stop());\n        alert(\"Произошла ошибка при записи. Попробуйте еще раз.\");\n      };\n\n      mediaRecorder.start();\n      setIsRecording(true);\n    } catch (error: unknown) {\n      console.error(\"Ошибка доступа к микрофону:\", error);\n      setIsRecording(false);\n      \n      let errorMessage = \"Не удалось получить доступ к микрофону.\";\n      \n      if (error instanceof Error) {\n        if (error.name === \"NotAllowedError\" || error.name === \"PermissionDeniedError\") {\n          errorMessage = \n            \"Доступ к микрофону запрещен.\\n\\n\" +\n            \"Пожалуйста:\\n\" +\n            \"1. Нажмите на иконку замка в адресной строке браузера\\n\" +\n            \"2. Разрешите доступ к микрофону\\n\" +\n            \"3. Обновите страницу и попробуйте снова\";\n        } else if (error.name === \"NotFoundError\" || error.name === \"DevicesNotFoundError\") {\n          errorMessage = \"Микрофон не найден. Убедитесь, что микрофон подключен и включен.\";\n        } else if (error.name === \"NotReadableError\" || error.name === \"TrackStartError\") {\n          errorMessage = \n            \"Микрофон уже используется другим приложением.\\n\\n\" +\n            \"Закройте другие приложения, использующие микрофон, и попробуйте снова.\";\n        } else {\n          errorMessage = `Ошибка: ${error.message}`;\n        }\n      }\n      \n      alert(errorMessage);\n    }\n  };\n\n  const stopRecording = () => {\n    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== \"inactive\") {\n      mediaRecorderRef.current.stop();\n      setIsRecording(false);\n    }\n  };\n\n  const loadLameJs = (): Promise<any> => {\n    return new Promise((resolve, reject) => {\n      if (typeof window !== \"undefined\" && (window as any).lamejs) {\n        resolve((window as any).lamejs);\n        return;\n      }\n\n      const script = document.createElement(\"script\");\n      script.src = \"https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js\";\n      script.onload = () => resolve((window as any).lamejs);\n      script.onerror = () => reject(new Error(\"Не удалось загрузить библиотеку конвертации\"));\n      document.head.appendChild(script);\n    });\n  };\n\n  const convertWebmToMp3 = async (webmBlob: Blob): Promise<File> => {\n    const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n    const arrayBuffer = await webmBlob.arrayBuffer();\n    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n\n    try {\n      // Пытаемся использовать lamejs для конвертации в MP3\n      const Lame = await loadLameJs();\n      \n      const mp3encoder = new Lame.Mp3Encoder(\n        audioBuffer.numberOfChannels,\n        audioBuffer.sampleRate,\n        128 // bitrate\n      );\n\n      // Конвертируем float32 в int16\n      const samples: Int16Array[] = [];\n      for (let i = 0; i < audioBuffer.numberOfChannels; i++) {\n        const channelData = audioBuffer.getChannelData(i);\n        const int16Array = new Int16Array(channelData.length);\n        for (let j = 0; j < channelData.length; j++) {\n          int16Array[j] = Math.max(-32768, Math.min(32767, channelData[j] * 32768));\n        }\n        samples.push(int16Array);\n      }\n\n      const mp3Data: BlobPart[] = [];\n      const sampleBlockSize = 1152;\n      \n      for (let i = 0; i < samples[0].length; i += sampleBlockSize) {\n        const left = samples[0].subarray(i, i + sampleBlockSize);\n        const right = audioBuffer.numberOfChannels > 1 \n          ? samples[1].subarray(i, i + sampleBlockSize)\n          : left;\n        const mp3buf = mp3encoder.encodeBuffer(left, right);\n        if (mp3buf.length > 0) {\n          mp3Data.push(mp3buf);\n        }\n      }\n\n      const mp3buf = mp3encoder.flush();\n      if (mp3buf.length > 0) {\n        mp3Data.push(mp3buf);\n      }\n\n      const mp3Blob = new Blob(mp3Data, { type: \"audio/mpeg\" });\n      return new File([mp3Blob], \"recording.mp3\", { type: \"audio/mpeg\" });\n    } catch (error) {\n      // Fallback: если lamejs не загрузился, конвертируем в WAV\n      console.warn(\"Не удалось использовать lamejs, используем WAV формат:\", error);\n      const wavBlob = audioBufferToWav(audioBuffer);\n      // Отправляем как WAV с расширением mp3 (сервер может конвертировать)\n      return new File([wavBlob], \"recording.mp3\", { type: \"audio/mpeg\" });\n    }\n  };\n\n  const audioBufferToWav = (buffer: AudioBuffer): Blob => {\n    const length = buffer.length;\n    const numberOfChannels = buffer.numberOfChannels;\n    const sampleRate = buffer.sampleRate;\n    const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);\n    const view = new DataView(arrayBuffer);\n\n    // WAV header\n    const writeString = (offset: number, string: string) => {\n      for (let i = 0; i < string.length; i++) {\n        view.setUint8(offset + i, string.charCodeAt(i));\n      }\n    };\n\n    writeString(0, \"RIFF\");\n    view.setUint32(4, 36 + length * numberOfChannels * 2, true);\n    writeString(8, \"WAVE\");\n    writeString(12, \"fmt \");\n    view.setUint32(16, 16, true);\n    view.setUint16(20, 1, true);\n    view.setUint16(22, numberOfChannels, true);\n    view.setUint32(24, sampleRate, true);\n    view.setUint32(28, sampleRate * numberOfChannels * 2, true);\n    view.setUint16(32, numberOfChannels * 2, true);\n    view.setUint16(34, 16, true);\n    writeString(36, \"data\");\n    view.setUint32(40, length * numberOfChannels * 2, true);\n\n    // Convert float samples to 16-bit PCM\n    let offset = 44;\n    for (let i = 0; i < length; i++) {\n      for (let channel = 0; channel < numberOfChannels; channel++) {\n        const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));\n        view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);\n        offset += 2;\n      }\n    }\n\n    return new Blob([arrayBuffer], { type: \"audio/wav\" });\n  };\n\n  const handleCloneVoice = async () => {\n    if (!voiceName.trim()) {\n      alert(\"Введите название голоса\");\n      return;\n    }\n\n    // Запускаем прогресс-бар сразу при нажатии на кнопку\n    setIsUploading(true);\n    setIsWaiting(true);\n    startProgressLoop();\n\n    let audioFile: File | null = null;\n\n    if (selectedFile) {\n      // Если файл загружен, используем его как есть\n      audioFile = selectedFile;\n    } else if (recordedBlob) {\n      // Если запись с микрофона, конвертируем webm в mp3\n      try {\n        audioFile = await convertWebmToMp3(recordedBlob);\n      } catch (error) {\n        console.error(\"[voices] Ошибка конвертации:\", error);\n        stopProgressLoop();\n        setIsUploading(false);\n        setIsWaiting(false);\n        alert(\"Ошибка при конвертации записи. Попробуйте еще раз.\");\n        return;\n      }\n    } else {\n      stopProgressLoop();\n      setIsUploading(false);\n      setIsWaiting(false);\n      alert(\"Загрузите файл или запишите голос с микрофона\");\n      return;\n    }\n\n    try {\n      // Получаем UUID авторизованного пользователя\n      const {\n        data: { user },\n        error: authError,\n      } = await supabase.auth.getUser();\n\n      if (authError || !user) {\n        throw new Error(\"Не удалось получить данные пользователя\");\n      }\n\n      const formData = new FormData();\n      formData.append(\"name\", voiceName.trim());\n      if (voiceDescription.trim()) {\n        const trimmedDescription = voiceDescription.trim().slice(0, MAX_DESCRIPTION_LENGTH);\n        formData.append(\"description\", trimmedDescription);\n      }\n      formData.append(\"file\", audioFile);\n      formData.append(\"uuid\", user.id);\n\n      const response = await fetch(\n        \"https://rueleven.ru/webhook/053aa1a5-396c-4cff-b9c4-a71ca8910a22\",\n        {\n          method: \"POST\",\n          body: formData,\n        }\n      );\n\n      if (!response.ok) {\n        throw new Error(`Ошибка отправки: ${response.statusText}`);\n      }\n\n      // Отправляем вебхук с UUID пользователя при клонировании голоса\n      try {\n        await fetch(\"https://rueleven.ru/webhook/373bb6fa-8fae-49fd-83b6-b503e7f286c4\", {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n          },\n          body: JSON.stringify({ uuid: user.id }),\n        });\n      } catch (webhookError) {\n        // Логируем ошибку вебхука, но не прерываем процесс клонирования\n        console.error(\"[VoiceCreateModal] Ошибка отправки вебхука UUID:\", webhookError);\n      }\n\n      // Продолжаем ждать появления записи в таблице (прогресс-бар уже запущен)\n      setIsUploading(false);\n\n      // Ждем появления записи в таблице voices\n      const timeoutMs = 30000; // 30 секунд максимум\n      const pollDelayMs = 1000; // Проверяем каждую секунду\n      const deadline = Date.now() + timeoutMs;\n      let found = false;\n\n      while (Date.now() < deadline && !found) {\n        const { data, error } = await supabase\n          .from(\"voices\")\n          .select(\"*\")\n          .eq(\"uid\", user.id)\n          .eq(\"name\", voiceName.trim())\n          .order(\"created_at\", { ascending: false })\n          .limit(1);\n\n        if (!error && data && data.length > 0) {\n          found = true;\n          stopProgressLoop();\n          setProgress(100);\n          await new Promise((resolve) => setTimeout(resolve, 300)); // Небольшая задержка для завершения анимации\n          setIsWaiting(false);\n          await onVoiceCreated?.();\n          closeModal();\n          return;\n        }\n\n        await new Promise((resolve) => setTimeout(resolve, pollDelayMs));\n      }\n\n      // Если не нашли за отведенное время\n      stopProgressLoop();\n      setIsWaiting(false);\n      alert(\"Голос отправлен на обработку. Проверьте список голосов через несколько секунд.\");\n      await onVoiceCreated?.();\n      closeModal();\n    } catch (error) {\n      console.error(\"[voices] Ошибка клонирования голоса:\", error);\n      stopProgressLoop();\n      setIsUploading(false);\n      setIsWaiting(false);\n      alert(\n        `Ошибка при клонировании голоса: ${\n          error instanceof Error ? error.message : \"Неизвестная ошибка\"\n        }`\n      );\n    }\n  };\n\n  const dropZoneClasses = `rounded-2xl border border-dashed border-purple-400/50 bg-purple-50/30 p-6 text-center transition-all duration-200 ${\n    dragActive\n      ? \"shadow-lg -translate-y-0.5 border-purple-500\"\n      : \"hover:shadow-md hover:-translate-y-0.5\"\n  }`;\n\n  if (!isOpen) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-8\">\n      <div className=\"w-full max-w-lg rounded-[32px] bg-white shadow-2xl\">\n        <div className=\"relative flex items-center justify-center border-b px-6 py-4\">\n          <h2 className=\"text-lg font-semibold text-gray-900\">\n            Создать голос\n          </h2>\n          <button\n            type=\"button\"\n            onClick={closeModal}\n            className=\"absolute right-6 rounded-full p-1 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600\"\n            disabled={isUploading || isRecording}\n          >\n            <span className=\"sr-only\">Закрыть</span>✕\n          </button>\n        </div>\n\n        <div className=\"max-h-[70vh] overflow-y-auto px-6 py-6 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 [&::-webkit-scrollbar-thumb]:rounded-full\">\n          <div className=\"space-y-6 text-sm text-gray-600\">\n            <div>\n              <label\n                htmlFor=\"voice-name\"\n                className=\"mb-2 block text-xs font-semibold uppercase tracking-wide text-gray-500\"\n              >\n                Название голоса\n              </label>\n              <input\n                id=\"voice-name\"\n                value={voiceName}\n                onChange={(event) => setVoiceName(event.target.value)}\n                placeholder=\"Придумайте название голоса\"\n                className=\"w-full rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-base text-gray-900 outline-none transition focus:border-gray-400\"\n                disabled={isUploading || isRecording}\n              />\n            </div>\n\n            <div>\n              <div className=\"mb-2 flex items-center justify-between\">\n                <label\n                  htmlFor=\"voice-description\"\n                  className=\"block text-xs font-semibold uppercase tracking-wide text-gray-500\"\n                >\n                  Описание голоса <span className=\"text-gray-400\">(необязательно)</span>\n                </label>\n                <span className={`text-xs ${\n                  voiceDescription.length > MAX_DESCRIPTION_LENGTH \n                    ? \"text-red-500\" \n                    : \"text-gray-400\"\n                }`}>\n                  {voiceDescription.length}/{MAX_DESCRIPTION_LENGTH}\n                </span>\n              </div>\n              <textarea\n                id=\"voice-description\"\n                value={voiceDescription}\n                onChange={(event) => {\n                  const value = event.target.value;\n                  if (value.length <= MAX_DESCRIPTION_LENGTH) {\n                    setVoiceDescription(value);\n                  }\n                }}\n                maxLength={MAX_DESCRIPTION_LENGTH}\n                placeholder=\"Добавьте описание голоса\"\n                className=\"h-28 w-full rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-base text-gray-900 outline-none transition focus:border-gray-400\"\n                disabled={isUploading || isRecording}\n              />\n            </div>\n\n            {/* Загрузка файла */}\n            <div\n              className={dropZoneClasses}\n              onDragEnter={handleDrag}\n              onDragLeave={handleDrag}\n              onDragOver={handleDrag}\n              onDrop={handleDrop}\n            >\n              <div className=\"mx-auto flex max-w-sm flex-col items-center gap-3 text-gray-700\">\n                <div className=\"rounded-2xl border border-purple-200 bg-white p-3 text-purple-500\">\n                  ↑\n                </div>\n                <p className=\"text-base font-semibold\">\n                  Перетащите аудио файл сюда\n                </p>\n                <p className=\"text-xs text-gray-500\">MP3, WAV, WebM или OGG до 50 МБ</p>\n                <button\n                  type=\"button\"\n                  className=\"rounded-lg bg-purple-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-purple-500 disabled:opacity-50\"\n                  onClick={() => fileInputRef.current?.click()}\n                  disabled={isUploading || isRecording}\n                >\n                  Выбрать файл\n                </button>\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  accept=\"audio/*\"\n                  className=\"hidden\"\n                  onChange={handleFileSelect}\n                  disabled={isUploading || isRecording}\n                />\n              </div>\n            </div>\n\n            {/* Выбранный файл */}\n            {selectedFile && (\n              <div className=\"rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-700\">\n                <div className=\"flex items-center justify-between gap-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"rounded-lg bg-purple-100 p-2 text-purple-600\">\n                      🎵\n                    </div>\n                    <div>\n                      <div className=\"font-medium\">{selectedFile.name}</div>\n                      <div className=\"text-xs text-gray-500\">\n                        {(selectedFile.size / 1024 / 1024).toFixed(2)} МБ\n                      </div>\n                    </div>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={() => setSelectedFile(null)}\n                    className=\"text-gray-400 transition hover:text-red-500\"\n                    disabled={isUploading || isRecording}\n                  >\n                    ✕\n                  </button>\n                </div>\n              </div>\n            )}\n\n            {/* Разделитель */}\n            <div className=\"relative\">\n              <div className=\"absolute inset-0 flex items-center\">\n                <div className=\"w-full border-t border-gray-200\"></div>\n              </div>\n              <div className=\"relative flex justify-center text-xs uppercase\">\n                <span className=\"bg-white px-2 text-gray-500\">или</span>\n              </div>\n            </div>\n\n            {/* Запись с микрофона */}\n            <div className=\"rounded-2xl border border-gray-200 bg-gray-50 p-6 text-center\">\n              <div className=\"mx-auto flex max-w-sm flex-col items-center gap-4\">\n                <div className=\"rounded-full border-4 border-purple-200 bg-white p-4\">\n                  {isRecording ? (\n                    <div className=\"h-12 w-12 animate-pulse rounded-full bg-red-500\"></div>\n                  ) : (\n                    <div className=\"h-12 w-12 rounded-full bg-purple-500\"></div>\n                  )}\n                </div>\n                <div>\n                  <p className=\"text-base font-semibold text-gray-900\">\n                    {isRecording ? \"Идет запись...\" : \"Записать с микрофона\"}\n                  </p>\n                  <p className=\"mt-1 text-xs text-gray-500\">\n                    {isRecording\n                      ? \"Нажмите остановить для завершения записи\"\n                      : \"Нажмите начать для записи голоса\"}\n                  </p>\n                </div>\n                {!isRecording ? (\n                  <button\n                    type=\"button\"\n                    onClick={startRecording}\n                    className=\"rounded-lg bg-purple-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-purple-500 disabled:opacity-50\"\n                    disabled={isUploading || !!selectedFile}\n                  >\n                    Начать запись\n                  </button>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={stopRecording}\n                    className=\"rounded-lg bg-red-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-red-500\"\n                  >\n                    Остановить запись\n                  </button>\n                )}\n              </div>\n            </div>\n\n            {/* Записанный файл */}\n            {recordedBlob && !isRecording && recordedAudioUrl && (\n              <div className=\"rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-700\">\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between gap-3\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"rounded-lg bg-green-100 p-2 text-green-600\">\n                        ✓\n                      </div>\n                      <div>\n                        <div className=\"font-medium\">Запись завершена</div>\n                        <div className=\"text-xs text-gray-500\">\n                          {(recordedBlob.size / 1024).toFixed(2)} КБ\n                        </div>\n                      </div>\n                    </div>\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        setRecordedBlob(null);\n                        if (recordedAudioUrl) {\n                          URL.revokeObjectURL(recordedAudioUrl);\n                        }\n                        setRecordedAudioUrl(null);\n                      }}\n                      className=\"text-gray-400 transition hover:text-red-500\"\n                      disabled={isUploading}\n                    >\n                      ✕\n                    </button>\n                  </div>\n                  {/* Аудио плеер */}\n                  <div className=\"flex items-center gap-2 rounded-lg bg-white p-2\">\n                    <audio\n                      ref={audioPlayerRef}\n                      src={recordedAudioUrl}\n                      controls\n                      className=\"flex-1\"\n                      style={{ height: \"32px\" }}\n                    />\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n\n        <div className=\"flex flex-col gap-3 border-t border-gray-200 px-6 py-4 text-sm text-gray-500 sm:flex-row sm:items-center sm:justify-between sm:gap-4\">\n          <div className=\"flex flex-1 items-center gap-4\">\n            <button\n              type=\"button\"\n              onClick={closeModal}\n              className=\"rounded-lg border border-gray-200 px-5 py-2 text-sm font-semibold text-gray-700 transition hover:bg-gray-50\"\n              disabled={isUploading || isRecording || isWaiting}\n            >\n              Отмена\n            </button>\n            {(isUploading || isWaiting || progress > 0) && (\n              <div className=\"relative h-1 flex-1 overflow-hidden rounded-full bg-gray-200\">\n                <div\n                  className=\"absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-purple-500 via-purple-600 to-purple-500 transition-[width] duration-100 ease-out\"\n                  style={{ width: `${progress}%` }}\n                  aria-hidden=\"true\"\n                />\n              </div>\n            )}\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleCloneVoice}\n            disabled={\n              isUploading ||\n              isRecording ||\n              isWaiting ||\n              !voiceName.trim() ||\n              (!selectedFile && !recordedBlob)\n            }\n            className=\"rounded-lg bg-purple-600 px-6 py-2 text-sm font-semibold text-white transition hover:bg-purple-500 disabled:cursor-not-allowed disabled:bg-gray-300 sm:ml-auto\"\n          >\n            {isUploading\n              ? \"Клонируем...\"\n              : isWaiting\n                ? \"Ожидаем...\"\n                : \"Клонировать голос\"}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1688, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/EditorSidebar.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport Image from \"next/image\";\nimport { supabase } from \"@/lib/supabaseClient\";\nimport { AvatarUploadModal } from \"@/app/avatars/components/AvatarUploadModal\";\nimport { VoiceCreateModal } from \"@/app/voices/components/VoiceCreateModal\";\nimport type {\n  AspectRatio,\n  AvatarOption,\n  Scene,\n  VoiceOption,\n} from \"./types\";\n\ntype EditorSidebarProps = {\n  aspectRatio: AspectRatio;\n  onAspectRatioChange: (ratio: AspectRatio) => void;\n  videoTitle: string;\n  onVideoTitleChange: (value: string) => void;\n  avatars: AvatarOption[];\n  isLoadingAvatars: boolean;\n  voices: VoiceOption[];\n  isLoadingVoices: boolean;\n  scenes: Scene[];\n  activeSceneId: string;\n  onSelectScene: (sceneId: string) => void;\n  onAddScene: (afterSceneId?: string) => void;\n  onDeleteScene: (sceneId: string) => void;\n  onSceneVoiceChange: (sceneId: string, voiceId: string | null) => void;\n  onSceneScriptChange: (sceneId: string, script: string) => void;\n  onSceneAvatarChange: (sceneId: string, avatarId: string | null) => void;\n  onRefreshAvatars?: () => void | Promise<void>;\n  onRefreshVoices?: () => void | Promise<void>;\n  onApplyCreatedAvatar?: (sceneId: string, avatarId: string) => void;\n};\n\ntype ManagedAudio = HTMLAudioElement & {\n  __handlers?: {\n    onPlay: ((this: GlobalEventHandlers, ev: Event) => any) | null;\n    onPause: ((this: GlobalEventHandlers, ev: Event) => any) | null;\n    onEnded: ((this: GlobalEventHandlers, ev: Event) => any) | null;\n    onError: ((this: GlobalEventHandlers, ev: Event) => any) | null;\n  };\n};\n\nconst ratioOptions: { label: string; value: AspectRatio }[] = [\n  { label: \"16:9\", value: \"16:9\" },\n  { label: \"9:16\", value: \"9:16\" },\n];\n\nexport function EditorSidebar({\n  aspectRatio,\n  onAspectRatioChange,\n  videoTitle,\n  onVideoTitleChange,\n  avatars,\n  isLoadingAvatars,\n  voices,\n  isLoadingVoices,\n  scenes,\n  activeSceneId,\n  onSelectScene,\n  onAddScene,\n  onDeleteScene,\n  onSceneVoiceChange,\n  onSceneScriptChange,\n  onSceneAvatarChange,\n  onRefreshAvatars,\n  onRefreshVoices,\n  onApplyCreatedAvatar,\n}: EditorSidebarProps) {\n  const [openAvatarModalForSceneId, setOpenAvatarModalForSceneId] = useState<string | null>(null);\n  const [openVoiceModalForSceneId, setOpenVoiceModalForSceneId] = useState<string | null>(null);\n  const [isAvatarCreateModalOpen, setIsAvatarCreateModalOpen] = useState(false);\n  const [isVoiceCreateModalOpen, setIsVoiceCreateModalOpen] = useState(false);\n  const [pendingSceneIdForAvatar, setPendingSceneIdForAvatar] = useState<string | null>(null);\n  const [pendingSceneIdForVoice, setPendingSceneIdForVoice] = useState<string | null>(null);\n  const [playingSceneId, setPlayingSceneId] = useState<string | null>(null);\n  const [loadingSceneId, setLoadingSceneId] = useState<string | null>(null);\n  const audioRefs = useRef<Record<string, HTMLAudioElement>>({});\n  // Сохраняем последний отправленный текст для каждого слайда\n  const lastSentTexts = useRef<Record<string, string>>({});\n  const sceneScriptsSnapshot = useRef<Record<string, string>>({});\n  // Refs для textarea элементов\n  const textareaRefs = useRef<Record<string, HTMLTextAreaElement>>({});\n\n  // Очистка аудио при размонтировании компонента\n  useEffect(() => {\n    return () => {\n      Object.values(audioRefs.current).forEach((audio) => {\n        const managed = audio as ManagedAudio;\n        audio.pause();\n        audio.onplay = null;\n        audio.onpause = null;\n        audio.onended = null;\n        audio.onerror = null;\n        managed.__handlers = undefined;\n        audio.removeAttribute(\"src\");\n        audio.src = \"\";\n      });\n      audioRefs.current = {};\n    };\n  }, []);\n\n  const stopAudioForScene = (\n    sceneId: string,\n    { resetTime = true }: { resetTime?: boolean } = {},\n  ) => {\n    const audio = audioRefs.current[sceneId];\n    if (!audio) {\n      return;\n    }\n    audio.pause();\n    if (resetTime) {\n      audio.currentTime = 0;\n    }\n    setPlayingSceneId((current) => (current === sceneId ? null : current));\n  };\n\n  // Останавливает воспроизведение на всех слайдах, кроме указанного\n  const stopOtherScenesAudio = (currentSceneId: string) => {\n    Object.keys(audioRefs.current).forEach((sceneId) => {\n      if (sceneId !== currentSceneId) {\n        stopAudioForScene(sceneId);\n      }\n    });\n  };\n\n  useEffect(() => {\n    const snapshot: Record<string, string> = {};\n    scenes.forEach((scene) => {\n      snapshot[scene.id] = scene.script;\n    });\n\n    const prevSnapshot = sceneScriptsSnapshot.current;\n    if (playingSceneId) {\n      const prevScript = prevSnapshot[playingSceneId];\n      const currentScript = snapshot[playingSceneId];\n      const sceneRemoved = prevScript !== undefined && currentScript === undefined;\n      const scriptChanged =\n        prevScript !== undefined && currentScript !== undefined && prevScript !== currentScript;\n      if (sceneRemoved || scriptChanged) {\n        stopAudioForScene(playingSceneId);\n      }\n    }\n\n    sceneScriptsSnapshot.current = snapshot;\n  }, [scenes, playingSceneId]);\n\n  // Автоматически изменяет высоту textarea в зависимости от содержимого\n  const adjustTextareaHeight = (textarea: HTMLTextAreaElement) => {\n    textarea.style.height = \"auto\";\n    textarea.style.height = `${textarea.scrollHeight}px`;\n  };\n\n  // Синхронизация высоты textarea при изменении содержимого\n  useEffect(() => {\n    scenes.forEach((scene) => {\n      const textarea = textareaRefs.current[scene.id];\n      if (textarea) {\n        adjustTextareaHeight(textarea);\n      }\n    });\n  }, [scenes]);\n\n  const getOrCreateAudioElement = (sceneId: string) => {\n    let audio = audioRefs.current[sceneId] as ManagedAudio | undefined;\n    if (audio) {\n      return audio;\n    }\n\n    audio = new Audio() as ManagedAudio;\n\n    const handlePlay = () => {\n      setPlayingSceneId(sceneId);\n      setLoadingSceneId(null);\n    };\n\n    const handlePause = () => {\n      setPlayingSceneId((current) => (current === sceneId ? null : current));\n    };\n\n    const handleEnded = () => {\n      setPlayingSceneId((current) => (current === sceneId ? null : current));\n    };\n\n    const handleError = (event: Event | string) => {\n      if (typeof event === \"string\") {\n        console.error(\"Ошибка загрузки аудио:\", event);\n        setLoadingSceneId(null);\n        setPlayingSceneId((current) => (current === sceneId ? null : current));\n        return;\n      }\n\n      const audioElement = event.currentTarget as HTMLAudioElement;\n      const hasSrcAttr = audioElement.getAttribute(\"src\");\n      if (!hasSrcAttr || hasSrcAttr === \"\") {\n        return;\n      }\n      console.error(\"Ошибка загрузки аудио:\", event);\n      setLoadingSceneId(null);\n      setPlayingSceneId((current) => (current === sceneId ? null : current));\n      if (audioElement.error) {\n        console.error(\"Код ошибки:\", audioElement.error.code);\n        console.error(\"Сообщение:\", audioElement.error.message);\n      }\n    };\n\n    audio.onplay = handlePlay;\n    audio.onpause = handlePause;\n    audio.onended = handleEnded;\n    audio.onerror = handleError;\n    audio.__handlers = {\n      onPlay: handlePlay,\n      onPause: handlePause,\n      onEnded: handleEnded,\n      onError: handleError,\n    };\n\n    audioRefs.current[sceneId] = audio;\n    return audio;\n  };\n\n  const playSceneAudio = async (sceneId: string, audioUrl: string) => {\n    stopOtherScenesAudio(sceneId);\n    stopAudioForScene(sceneId);\n    const audio = getOrCreateAudioElement(sceneId);\n    const currentSrc = audio.getAttribute(\"src\");\n    if (currentSrc !== audioUrl) {\n      audio.setAttribute(\"src\", audioUrl);\n      audio.src = audioUrl;\n    }\n    try {\n      await audio.play();\n      setPlayingSceneId(sceneId);\n      setLoadingSceneId(null);\n    } catch (error) {\n      if (error instanceof DOMException && error.name === \"AbortError\") {\n        console.warn(\"Воспроизведение прервано из-за смены источника\");\n        return;\n      }\n      throw error;\n    }\n  };\n\n  const handlePlayClick = async (sceneId: string, sceneIndex: number) => {\n    const scene = scenes.find((s) => s.id === sceneId);\n    if (!scene || !scene.avatarId || !scene.script || scene.script.trim() === \"\") {\n      return;\n    }\n\n    // Находим выбранный голос и получаем его voice_id из таблицы\n    const selectedVoice = voices.find((voice) => voice.id === scene.voiceId);\n    if (!selectedVoice || !selectedVoice.voice_id) {\n      alert(\"У выбранного голоса отсутствует voice_id\");\n      return;\n    }\n\n    // Извлекаем номер слайда из title (например, \"Слайд 1\" -> 1)\n    const slideNumberMatch = scene.title.match(/\\d+/);\n    const slideNumber = slideNumberMatch ? parseInt(slideNumberMatch[0], 10) : sceneIndex + 1;\n\n    const currentText = scene.script.trim();\n    const lastSentText = lastSentTexts.current[sceneId];\n\n    // Получаем UUID залогиненного пользователя\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n    const userUuid = user?.id;\n    if (!userUuid) {\n      alert(\"Не удалось определить пользователя, авторизуйтесь повторно.\");\n      return;\n    }\n\n    // Проксируем аудио через собственный API, чтобы не светить прямую ссылку\n    const baseAudioUrl = `/api/tts-audio?user=${encodeURIComponent(userUuid)}&slide=${slideNumber}&voice=${encodeURIComponent(selectedVoice.voice_id)}`;\n\n    // Определяем, изменился ли текст\n    const textChanged = lastSentText !== currentText;\n\n    // Если текст не изменился и уже есть загруженный аудио-файл для этого слайда,\n    // просто управляем воспроизведением/паузой без повторной отправки вебхука\n    const existingAudio = audioRefs.current[sceneId];\n    const existingSrc = existingAudio?.getAttribute(\"src\") ?? \"\";\n    if (!textChanged && existingAudio && existingSrc.startsWith(baseAudioUrl)) {\n      if (!existingAudio.paused) {\n        stopAudioForScene(sceneId, { resetTime: false });\n      } else {\n        // Перед воспроизведением этого слайда останавливаем все остальные\n        stopOtherScenesAudio(sceneId);\n        await existingAudio.play();\n        setPlayingSceneId(sceneId);\n      }\n      return;\n    }\n\n    try {\n      if (!textChanged) {\n        setLoadingSceneId(sceneId);\n        await playSceneAudio(sceneId, baseAudioUrl);\n        return;\n      }\n\n      setLoadingSceneId(sceneId);\n\n      // Отправляем вебхук и ждем, пока n8n вернет success === true\n      const response = await fetch(\"https://rueleven.ru/webhook/d08c47c0-82c3-4b50-a7e0-e1b525c5498b\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          voice_id: selectedVoice.voice_id, // voice_id из таблицы voices\n          slide_number: slideNumber, // Номер слайда\n          text: currentText,\n          uuid: userUuid,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n\n      // Ожидаем подтверждение от n8n, что файл готов: [{ \"success\": true }] или { \"success\": true }\n      let json: unknown;\n      try {\n        json = await response.json();\n      } catch {\n        throw new Error(\"Некорректный JSON ответ от вебхука\");\n      }\n\n      let success = false;\n      if (Array.isArray(json) && json.length > 0 && typeof json[0] === \"object\" && json[0] !== null) {\n        success = Boolean((json[0] as { success?: unknown }).success);\n      } else if (json && typeof json === \"object\") {\n        success = Boolean((json as { success?: unknown }).success);\n      }\n\n      if (!success) {\n        console.error(\"Неожиданный ответ вебхука, ожидали success=true:\", json);\n        throw new Error(\"Вебхук не вернул success=true, аудио может быть не готово\");\n      }\n\n      console.log(\"Вебхук успешно завершил генерацию для слайда:\", slideNumber);\n\n      // Сохраняем отправленный текст (используется для определения, изменился ли текст)\n      lastSentTexts.current[sceneId] = currentText;\n\n      // Если текст изменился, добавляем cache-buster к URL, чтобы браузер не брал старое аудио из кеша\n      const audioUrl = textChanged ? `${baseAudioUrl}&bust=${Date.now()}` : baseAudioUrl;\n\n      console.log(\"Воспроизведение аудио по URL:\", audioUrl);\n\n      await playSceneAudio(sceneId, audioUrl);\n      console.log(\"Воспроизведение начато\");\n    } catch (error) {\n      setLoadingSceneId(null);\n      console.error(\"Ошибка при отправке вебхука или воспроизведении:\", error);\n      alert(error instanceof Error ? error.message : \"Не удалось отправить вебхук или воспроизвести аудио\");\n    }\n  };\n\n  return (\n    <>\n      <aside className=\"flex h-full min-h-0 flex-col overflow-hidden rounded-3xl border border-gray-100 bg-white shadow-sm ring-1 ring-black/5\">\n        <div className=\"flex-shrink-0 space-y-6 border-b border-gray-100 p-6\">\n          <div className=\"space-y-3\">\n            <p className=\"text-sm uppercase tracking-[0.2em] text-gray-500\">\n              Настройка слайдов\n            </p>\n            <div className=\"flex items-center gap-3\">\n              {ratioOptions.map(({ label, value }) => {\n                const isActive = aspectRatio === value;\n                return (\n                  <button\n                    key={value}\n                    type=\"button\"\n                    onClick={() => onAspectRatioChange(value)}\n                    className={`flex h-12 flex-1 items-center justify-center rounded-2xl border text-sm font-semibold transition ${\n                      isActive\n                        ? \"border-gray-900 bg-gray-900 text-white\"\n                        : \"border-gray-200 text-gray-600 hover:border-gray-300 hover:text-gray-900\"\n                    }`}\n                  >\n                    {label}\n                  </button>\n                );\n              })}\n            </div>\n          </div>\n\n          <label className=\"block space-y-2\">\n            <span className=\"text-sm text-gray-600\">Название видео</span>\n            <input\n              type=\"text\"\n              value={videoTitle}\n              onChange={(event) => onVideoTitleChange(event.target.value)}\n              placeholder=\"Придумайте название видео\"\n              className=\"w-full rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm text-gray-900 outline-none placeholder:text-gray-400 focus:border-gray-900 focus:ring-1 focus:ring-gray-900\"\n            />\n          </label>\n        </div>\n\n        <div className=\"flex-1 min-h-0 space-y-2 overflow-y-auto p-4 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 [&::-webkit-scrollbar-thumb]:rounded-full\">\n          {scenes.map((scene, index) => {\n            const isActive = scene.id === activeSceneId;\n            const selectedAvatar = avatars.find((avatar) => avatar.id === scene.avatarId);\n            const selectedVoice = voices.find((voice) => voice.id === scene.voiceId);\n\n            return (\n              <div key={scene.id} className=\"space-y-2\">\n                <div\n                  className={`rounded-2xl p-4 transition ${\n                    isActive\n                      ? \"bg-gray-50\"\n                      : \"bg-white hover:bg-gray-50/50\"\n                  }`}\n                  onClick={() => onSelectScene(scene.id)}\n                >\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-gray-200 text-sm font-semibold text-gray-700\">\n                        {index + 1}\n                      </div>\n                      <button\n                        type=\"button\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          setOpenAvatarModalForSceneId(scene.id);\n                        }}\n                        className=\"flex items-center gap-1 rounded-xl bg-gray-100 px-3 py-2 transition hover:bg-gray-200\"\n                      >\n                        {selectedAvatar ? (\n                          <>\n                            <div className=\"relative h-8 w-8 flex-shrink-0 overflow-hidden rounded-full\">\n                              <Image\n                                src={selectedAvatar.photo}\n                                alt={selectedAvatar.name}\n                                fill\n                                className=\"object-cover\"\n                                unoptimized\n                              />\n                            </div>\n                            <span className=\"text-left text-sm font-medium text-gray-900 whitespace-nowrap\">\n                              Аватар\n                            </span>\n                          </>\n                        ) : (\n                          <>\n                            <div className=\"flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full border-2 border-dashed border-gray-300 bg-white\">\n                              <span className=\"text-sm text-gray-400\">＋</span>\n                            </div>\n                            <span className=\"text-left text-sm text-gray-500 whitespace-nowrap\">\n                              Аватар\n                            </span>\n                          </>\n                        )}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          setOpenVoiceModalForSceneId(scene.id);\n                        }}\n                        className=\"flex items-center gap-1 rounded-xl bg-gray-100 px-3 py-2 transition hover:bg-gray-200\"\n                      >\n                        {selectedVoice ? (\n                          <>\n                            <div className=\"flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full border-2 border-dashed border-gray-300 bg-white\">\n                              <svg\n                                xmlns=\"http://www.w3.org/2000/svg\"\n                                viewBox=\"0 0 24 24\"\n                                fill=\"none\"\n                                stroke=\"currentColor\"\n                                strokeWidth={2}\n                                className=\"h-4 w-4 text-gray-400\"\n                              >\n                                <path d=\"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z\" />\n                                <path d=\"M19 10v2a7 7 0 0 1-14 0v-2\" />\n                                <line x1=\"12\" y1=\"19\" x2=\"12\" y2=\"23\" />\n                                <line x1=\"8\" y1=\"23\" x2=\"16\" y2=\"23\" />\n                              </svg>\n                            </div>\n                            <span className=\"text-left text-sm font-medium text-gray-900 whitespace-nowrap\">\n                              {selectedVoice.name}\n                            </span>\n                          </>\n                        ) : (\n                          <>\n                            <div className=\"flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full border-2 border-dashed border-gray-300 bg-white\">\n                              <span className=\"text-sm text-gray-400\">＋</span>\n                            </div>\n                            <span className=\"text-left text-sm text-gray-500 whitespace-nowrap\">\n                              Голос\n                            </span>\n                          </>\n                        )}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handlePlayClick(scene.id, index);\n                        }}\n                        disabled={\n                          !scene.avatarId ||\n                          !scene.voiceId ||\n                          !scene.script ||\n                          scene.script.trim() === \"\" ||\n                          loadingSceneId === scene.id\n                        }\n                        className=\"ml-auto flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-xl bg-gray-100 text-gray-900 transition hover:bg-gray-200 disabled:bg-gray-50 disabled:text-gray-300\"\n                        aria-label={playingSceneId === scene.id ? \"Поставить на паузу\" : \"Воспроизвести голос\"}\n                      >\n                        {loadingSceneId === scene.id ? (\n                          <svg\n                            className=\"h-4 w-4 animate-spin text-gray-600\"\n                            xmlns=\"http://www.w3.org/2000/svg\"\n                            fill=\"none\"\n                            viewBox=\"0 0 24 24\"\n                          >\n                            <circle\n                              className=\"opacity-25\"\n                              cx=\"12\"\n                              cy=\"12\"\n                              r=\"10\"\n                              stroke=\"currentColor\"\n                              strokeWidth=\"4\"\n                            />\n                            <path\n                              className=\"opacity-75\"\n                              fill=\"currentColor\"\n                              d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                            />\n                          </svg>\n                        ) : playingSceneId === scene.id ? (\n                          <svg\n                            xmlns=\"http://www.w3.org/2000/svg\"\n                            viewBox=\"0 0 24 24\"\n                            fill=\"currentColor\"\n                            className=\"h-4 w-4\"\n                          >\n                            <path d=\"M6 4h4v16H6V4zm8 0h4v16h-4V4z\" />\n                          </svg>\n                        ) : (\n                          <svg\n                            xmlns=\"http://www.w3.org/2000/svg\"\n                            viewBox=\"0 0 24 24\"\n                            fill=\"currentColor\"\n                            className=\"h-4 w-4\"\n                          >\n                            <path d=\"M8 5v14l11-7z\" />\n                          </svg>\n                        )}\n                      </button>\n                      {scenes.length > 1 && (\n                        <button\n                          type=\"button\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            onDeleteScene(scene.id);\n                          }}\n                          className=\"flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-xl bg-red-50 text-red-600 transition hover:bg-red-100\"\n                          aria-label=\"Удалить слайд\"\n                        >\n                          <svg\n                            xmlns=\"http://www.w3.org/2000/svg\"\n                            viewBox=\"0 0 24 24\"\n                            fill=\"none\"\n                            stroke=\"currentColor\"\n                            strokeWidth={2}\n                            className=\"h-4 w-4\"\n                          >\n                            <path d=\"M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2\" />\n                          </svg>\n                        </button>\n                      )}\n                    </div>\n\n                    <textarea\n                      ref={(el) => {\n                        if (el) {\n                          textareaRefs.current[scene.id] = el;\n                          adjustTextareaHeight(el);\n                        }\n                      }}\n                      value={scene.script}\n                      onChange={(event) => {\n                        onSceneScriptChange(scene.id, event.target.value);\n                        adjustTextareaHeight(event.target);\n                      }}\n                      onClick={(e) => e.stopPropagation()}\n                      placeholder=\"Напишите текст\"\n                      className=\"w-full resize-none overflow-hidden rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 outline-none placeholder:text-gray-400 focus:border-gray-900 focus:ring-1 focus:ring-gray-900\"\n                      style={{ height: \"auto\", minHeight: \"60px\" }}\n                    />\n                  </div>\n\n                  <button\n                    type=\"button\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      onAddScene(scene.id);\n                    }}\n                    className=\"flex w-full items-center justify-center gap-2 rounded-xl bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-200\"\n                  >\n                    <span className=\"text-sm\">＋</span>\n                    Слайд\n                  </button>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </aside>\n\n      {openAvatarModalForSceneId && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\"\n          onClick={() => setOpenAvatarModalForSceneId(null)}\n        >\n          <div\n            className=\"w-full max-w-2xl rounded-3xl border border-gray-100 bg-white p-6 shadow-xl\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"mb-4 flex items-center justify-between\">\n              <h2 className=\"text-xl font-semibold text-gray-900\">\n                Выберите аватар\n              </h2>\n              <button\n                type=\"button\"\n                onClick={() => setOpenAvatarModalForSceneId(null)}\n                className=\"rounded-lg p-2 text-gray-400 transition hover:bg-gray-100 hover:text-gray-900\"\n                aria-label=\"Закрыть\"\n              >\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  strokeWidth={2}\n                  className=\"h-5 w-5\"\n                >\n                  <path d=\"M18 6L6 18M6 6l12 12\" />\n                </svg>\n              </button>\n            </div>\n            {isLoadingAvatars ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <p className=\"text-gray-500\">Загрузка аватаров...</p>\n              </div>\n            ) : avatars.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center gap-4 py-12\">\n                <p className=\"text-gray-500\">Нет доступных аватаров</p>\n                <button\n                  type=\"button\"\n                  onClick={() => {\n                    if (openAvatarModalForSceneId) {\n                      setPendingSceneIdForAvatar(openAvatarModalForSceneId);\n                    }\n                    setOpenAvatarModalForSceneId(null);\n                    setIsAvatarCreateModalOpen(true);\n                  }}\n                  className=\"rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700\"\n                >\n                  Создать аватар\n                </button>\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4\">\n                {avatars.map((avatar) => {\n                  const scene = scenes.find((s) => s.id === openAvatarModalForSceneId);\n                  const isSelected = scene?.avatarId === avatar.id;\n                  return (\n                    <button\n                      key={avatar.id}\n                      type=\"button\"\n                      onClick={() => {\n                        if (openAvatarModalForSceneId) {\n                          onSceneAvatarChange(\n                            openAvatarModalForSceneId,\n                            isSelected ? null : avatar.id,\n                          );\n                        }\n                        setOpenAvatarModalForSceneId(null);\n                      }}\n                      className={`group relative aspect-[3/4] overflow-hidden rounded-2xl border transition ${\n                        isSelected\n                          ? \"border-gray-900 ring ring-gray-900\"\n                          : \"border-gray-200 hover:border-gray-300\"\n                      }`}\n                    >\n                      <Image\n                        src={avatar.photo}\n                        alt={avatar.name}\n                        fill\n                        className=\"object-cover\"\n                        unoptimized\n                      />\n                      <div className=\"absolute inset-0 bg-black/0 transition group-hover:bg-black/20\" />\n                      <div className=\"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3\">\n                        <p className=\"text-sm font-semibold text-white\">\n                          {avatar.name}\n                        </p>\n                      </div>\n                    </button>\n                  );\n                })}\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {openVoiceModalForSceneId && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\"\n          onClick={() => setOpenVoiceModalForSceneId(null)}\n        >\n          <div\n            className=\"w-full max-w-2xl rounded-3xl border border-gray-100 bg-white p-6 shadow-xl\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"mb-4 flex items-center justify-between\">\n              <h2 className=\"text-xl font-semibold text-gray-900\">\n                Выберите голос\n              </h2>\n              <button\n                type=\"button\"\n                onClick={() => setOpenVoiceModalForSceneId(null)}\n                className=\"rounded-lg p-2 text-gray-400 transition hover:bg-gray-100 hover:text-gray-900\"\n                aria-label=\"Закрыть\"\n              >\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  strokeWidth={2}\n                  className=\"h-5 w-5\"\n                >\n                  <path d=\"M18 6L6 18M6 6l12 12\" />\n                </svg>\n              </button>\n            </div>\n            {isLoadingVoices ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <p className=\"text-gray-500\">Загрузка голосов...</p>\n              </div>\n            ) : voices.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center gap-4 py-12\">\n                <p className=\"text-gray-500\">Нет доступных голосов</p>\n                <button\n                  type=\"button\"\n                  onClick={() => {\n                    if (openVoiceModalForSceneId) {\n                      setPendingSceneIdForVoice(openVoiceModalForSceneId);\n                    }\n                    setOpenVoiceModalForSceneId(null);\n                    setIsVoiceCreateModalOpen(true);\n                  }}\n                  className=\"rounded-xl bg-purple-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-purple-700\"\n                >\n                  Создать голос\n                </button>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                {voices.map((voice) => {\n                  const scene = scenes.find((s) => s.id === openVoiceModalForSceneId);\n                  const isSelected = scene?.voiceId === voice.id;\n                  return (\n                    <button\n                      key={voice.id}\n                      type=\"button\"\n                      onClick={() => {\n                        if (openVoiceModalForSceneId) {\n                          onSceneVoiceChange(\n                            openVoiceModalForSceneId,\n                            isSelected ? null : voice.id,\n                          );\n                        }\n                        setOpenVoiceModalForSceneId(null);\n                      }}\n                      className={`w-full rounded-xl border p-4 text-left transition ${\n                        isSelected\n                          ? \"border-gray-900 bg-gray-50 ring ring-gray-900\"\n                          : \"border-gray-200 hover:border-gray-300\"\n                      }`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-gray-100\">\n                          <svg\n                            xmlns=\"http://www.w3.org/2000/svg\"\n                            viewBox=\"0 0 24 24\"\n                            fill=\"none\"\n                            stroke=\"currentColor\"\n                            strokeWidth={2}\n                            className=\"h-5 w-5 text-gray-600\"\n                          >\n                            <path d=\"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z\" />\n                            <path d=\"M19 10v2a7 7 0 0 1-14 0v-2\" />\n                            <line x1=\"12\" y1=\"19\" x2=\"12\" y2=\"23\" />\n                            <line x1=\"8\" y1=\"23\" x2=\"16\" y2=\"23\" />\n                          </svg>\n                        </div>\n                        <div className=\"flex-1\">\n                          <p className=\"text-sm font-semibold text-gray-900\">\n                            {voice.name}\n                          </p>\n                          {voice.description && (\n                            <p className=\"text-xs text-gray-500\">\n                              {voice.description}\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                    </button>\n                  );\n                })}\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {/* Модальное окно создания аватара */}\n      <AvatarUploadModal\n        isOpen={isAvatarCreateModalOpen}\n        onClose={() => {\n          setIsAvatarCreateModalOpen(false);\n          setPendingSceneIdForAvatar(null);\n        }}\n        onAvatarUploaded={async () => {\n          // Обновляем список аватаров\n          await onRefreshAvatars?.();\n          \n          // Получаем последний созданный аватар и применяем его\n          if (pendingSceneIdForAvatar) {\n            const {\n              data: { user },\n            } = await supabase.auth.getUser();\n            \n            if (user) {\n              // Ждем немного, чтобы аватар успел обработаться\n              await new Promise(resolve => setTimeout(resolve, 2000));\n              \n              const { data: avatarsData } = await supabase\n                .from(\"photo_avatars\")\n                .select(\"id\")\n                .eq(\"uid\", user.id)\n                .eq(\"status\", \"done\")\n                .order(\"created_at\", { ascending: false })\n                .limit(1);\n              \n              if (avatarsData && avatarsData.length > 0 && avatarsData[0].id) {\n                const avatarId = avatarsData[0].id;\n                // Используем специальную функцию для применения созданного аватара\n                if (onApplyCreatedAvatar) {\n                  onApplyCreatedAvatar(pendingSceneIdForAvatar, avatarId);\n                } else {\n                  onSceneAvatarChange(pendingSceneIdForAvatar, avatarId);\n                }\n              }\n            }\n          }\n          \n          setIsAvatarCreateModalOpen(false);\n          setPendingSceneIdForAvatar(null);\n        }}\n      />\n\n      {/* Модальное окно создания голоса */}\n      <VoiceCreateModal\n        isOpen={isVoiceCreateModalOpen}\n        onClose={() => {\n          setIsVoiceCreateModalOpen(false);\n          setPendingSceneIdForVoice(null);\n        }}\n        onVoiceCreated={async () => {\n          // Обновляем список голосов\n          await onRefreshVoices?.();\n          \n          // Получаем последний созданный голос и применяем его\n          if (pendingSceneIdForVoice) {\n            const {\n              data: { user },\n            } = await supabase.auth.getUser();\n            \n            if (user) {\n              const { data: voicesData } = await supabase\n                .from(\"voices\")\n                .select(\"id\")\n                .eq(\"uid\", user.id)\n                .order(\"created_at\", { ascending: false })\n                .limit(1);\n              \n              if (voicesData && voicesData.length > 0 && voicesData[0].id) {\n                onSceneVoiceChange(pendingSceneIdForVoice, voicesData[0].id);\n              }\n            }\n          }\n          \n          setIsVoiceCreateModalOpen(false);\n          setPendingSceneIdForVoice(null);\n        }}\n      />\n    </>\n  );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2908, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/Timeline.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport Image from \"next/image\";\nimport type { Scene, AvatarOption, AspectRatio, CanvasElement } from \"./types\";\n\nconst CANVAS_SIZES: Record<AspectRatio, { width: number; height: number }> = {\n  \"16:9\": { width: 1920, height: 1080 },\n  \"9:16\": { width: 1080, height: 1920 },\n};\n\ntype CanvasThumbnailProps = {\n  scene: Scene;\n  avatars: AvatarOption[];\n  aspectRatio: AspectRatio;\n};\n\nfunction CanvasThumbnail({ scene, avatars, aspectRatio }: CanvasThumbnailProps) {\n  const canvasSize = CANVAS_SIZES[aspectRatio];\n\n  const avatar = scene.avatarId\n    ? avatars.find((a) => a.id === scene.avatarId)\n    : null;\n\n  return (\n    <div className=\"absolute inset-0 bg-gray-50 overflow-hidden\">\n      {/* Аватар */}\n      {avatar && scene.avatarPosition && scene.avatarSize && (\n        <div\n          className=\"absolute\"\n          style={{\n            left: `${(scene.avatarPosition.x / canvasSize.width) * 100}%`,\n            top: `${(scene.avatarPosition.y / canvasSize.height) * 100}%`,\n            width: `${(scene.avatarSize.width / canvasSize.width) * 100}%`,\n            height: `${(scene.avatarSize.height / canvasSize.height) * 100}%`,\n            transform: \"translate(-50%, -50%)\",\n          }}\n        >\n          <img\n            src={avatar.photo}\n            alt={avatar.name}\n            className=\"w-full h-full object-cover rounded\"\n          />\n        </div>\n      )}\n\n      {/* Элементы */}\n      {scene.elements.map((element) => {\n        const leftPercent = (element.x / canvasSize.width) * 100;\n        const topPercent = (element.y / canvasSize.height) * 100;\n        const widthPercent = (element.width / canvasSize.width) * 100;\n        const heightPercent = (element.height / canvasSize.height) * 100;\n\n        return (\n          <div\n            key={element.id}\n            className=\"absolute rounded border border-gray-300 overflow-hidden\"\n            style={{\n              left: `${leftPercent}%`,\n              top: `${topPercent}%`,\n              width: `${widthPercent}%`,\n              height: `${heightPercent}%`,\n              transform: \"translate(-50%, -50%)\",\n              backgroundColor: element.imageUrl ? \"transparent\" : \"#e5e7eb\",\n            }}\n          >\n            {element.imageUrl ? (\n              <img\n                src={element.imageUrl}\n                alt={element.label}\n                className=\"w-full h-full object-cover\"\n              />\n            ) : (\n              <div className=\"w-full h-full bg-gray-200\" />\n            )}\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n\ntype TimelineProps = {\n  scenes: Scene[];\n  activeSceneId: string;\n  onSelectScene: (sceneId: string) => void;\n  onAddScene: (afterSceneId?: string) => void;\n  avatars: AvatarOption[];\n  aspectRatio: AspectRatio;\n};\n\nexport function Timeline({\n  scenes,\n  activeSceneId,\n  onSelectScene,\n  onAddScene,\n  avatars,\n  aspectRatio,\n}: TimelineProps) {\n  const sceneRefs = useRef<Record<string, HTMLButtonElement | null>>({});\n  const scrollContainerRef = useRef<HTMLDivElement | null>(null);\n  const [hoveredWarningId, setHoveredWarningId] = useState<string | null>(null);\n  const [tooltipPosition, setTooltipPosition] = useState<{ x: number; y: number } | null>(null);\n  const prevScenesLengthRef = useRef<number>(scenes.length);\n\n  useEffect(() => {\n    const activeButton = sceneRefs.current[activeSceneId];\n    if (activeButton) {\n      activeButton.scrollIntoView({ behavior: \"smooth\", block: \"nearest\", inline: \"nearest\" });\n    }\n  }, [activeSceneId]);\n\n  useEffect(() => {\n    // Автоматическая прокрутка к концу при добавлении нового слайда\n    if (scenes.length > prevScenesLengthRef.current && scrollContainerRef.current) {\n      const container = scrollContainerRef.current;\n      setTimeout(() => {\n        container.scrollTo({\n          left: container.scrollWidth,\n          behavior: \"smooth\",\n        });\n      }, 100);\n    }\n    prevScenesLengthRef.current = scenes.length;\n  }, [scenes.length]);\n\n  // Проверяем, есть ли хотя бы один слайд с текстом\n  const hasAnyText = scenes.some((scene) => scene.script && scene.script.trim() !== \"\");\n  const tooltipText = hasAnyText \n    ? \"Слайд будет сгенерирован без озвучки\"\n    : \"Напишите текст хотя бы для одного слайда\";\n\n  return (\n    <>\n      {hoveredWarningId && tooltipPosition && (\n        <div \n          className=\"fixed z-[9999] px-3 py-2 rounded-lg border border-gray-200 bg-white shadow-lg text-xs text-gray-700 whitespace-nowrap\"\n          style={{\n            left: `${tooltipPosition.x}px`,\n            top: `${tooltipPosition.y - 8}px`,\n            transform: 'translate(-50%, -100%)',\n          }}\n          onMouseEnter={() => setHoveredWarningId(hoveredWarningId)}\n          onMouseLeave={() => {\n            setHoveredWarningId(null);\n            setTooltipPosition(null);\n          }}\n        >\n          {tooltipText}\n          <div className=\"absolute top-full left-1/2 -translate-x-1/2 -mt-px\">\n            <div className=\"border-4 border-transparent border-t-gray-200\"></div>\n            <div className=\"absolute top-0 left-1/2 -translate-x-1/2 -mt-[3px]\">\n              <div className=\"border-4 border-transparent border-t-white\"></div>\n            </div>\n          </div>\n        </div>\n      )}\n    <div className=\"flex h-full flex-col rounded-3xl border border-gray-100 bg-white p-4 shadow-sm ring-1 ring-black/5\">\n        <div \n          ref={scrollContainerRef}\n          className=\"flex w-full flex-1 flex-col gap-2 overflow-x-auto overflow-y-visible pb-2 [&::-webkit-scrollbar]:h-2 [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 [&::-webkit-scrollbar-thumb]:rounded-full min-h-0\"\n        >\n          {/* Контейнер для предупреждений \"Нет текста\" */}\n          <div className=\"flex flex-nowrap items-center gap-1\">\n            {scenes.map((scene, index) => {\n              const hasNoText = !scene.script || scene.script.trim() === \"\";\n              const isLast = index === scenes.length - 1;\n              return (\n                <div key={`warning-${scene.id}`} className=\"flex flex-shrink-0 items-center\">\n                  <div className=\"h-[28px] w-[180px] flex items-center justify-center relative group\">\n                    {hasNoText && (\n                      <div \n                        className=\"flex items-center justify-center gap-1.5 px-2 py-1 bg-red-50 border border-red-200 rounded-lg cursor-help\"\n                        onMouseEnter={(e) => {\n                          const rect = e.currentTarget.getBoundingClientRect();\n                          setTooltipPosition({\n                            x: rect.left + rect.width / 2,\n                            y: rect.top,\n                          });\n                          setHoveredWarningId(scene.id);\n                        }}\n                        onMouseLeave={() => {\n                          setHoveredWarningId(null);\n                          setTooltipPosition(null);\n                        }}\n                      >\n                        <svg\n                          xmlns=\"http://www.w3.org/2000/svg\"\n                          viewBox=\"0 0 24 24\"\n                          className=\"h-4 w-4 text-red-600 flex-shrink-0\"\n                        >\n                          <path\n                            d=\"M12 2L1 21h22L12 2z\"\n                            fill=\"currentColor\"\n                          />\n                          <path\n                            d=\"M11 10h2v4h-2v-4zm0 6h2v2h-2v-2z\"\n                            fill=\"white\"\n                          />\n                        </svg>\n                        <span className=\"text-xs font-medium text-red-700 whitespace-nowrap\">Нет текста</span>\n                      </div>\n                    )}\n                  </div>\n                  {!isLast && <div className=\"w-[1px]\" />}\n                  {isLast && <div className=\"w-[80px]\" />}\n                </div>\n              );\n            })}\n      </div>\n          {/* Контейнер для карточек слайдов */}\n          <div className=\"flex flex-nowrap items-center gap-1\">\n        {scenes.map((scene, index) => {\n          const isActive = scene.id === activeSceneId;\n          const isLast = index === scenes.length - 1;\n          return (\n              <div key={scene.id} className=\"flex items-center flex-shrink-0 relative\">\n                <div className=\"flex items-center relative\">\n              <button\n                ref={(el) => {\n                  sceneRefs.current[scene.id] = el;\n                }}\n                type=\"button\"\n                onClick={() => onSelectScene(scene.id)}\n                className={`relative min-w-[180px] min-h-[120px] w-[180px] h-[120px] rounded-2xl border overflow-hidden transition ${\n                  isActive\n                    ? \"border-gray-900\"\n                    : \"border-gray-200 hover:border-gray-300\"\n                }`}\n              >\n                <CanvasThumbnail\n                  scene={scene}\n                  avatars={avatars}\n                  aspectRatio={aspectRatio}\n                />\n                {/* Номер слайда */}\n                <div className=\"absolute top-2 left-2 flex h-6 w-6 items-center justify-center rounded-full bg-black/70 text-xs font-semibold text-white\">\n                  {index + 1}\n                </div>\n              </button>\n                  {/* Стрелка на стыке карточек */}\n                  {!isLast && (\n                    <div className=\"absolute right-[-14px] top-1/2 -translate-y-1/2 z-10 flex h-6 w-6 items-center justify-center rounded-full bg-gray-100\">\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        viewBox=\"0 0 24 24\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        strokeWidth={2}\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        className=\"h-3 w-3 text-gray-600\"\n                      >\n                        <path d=\"M9 18l6-6-6-6\" />\n                      </svg>\n                    </div>\n                  )}\n              {isLast && (\n                <button\n                  type=\"button\"\n                  onClick={() => onAddScene(scene.id)}\n                      className=\"flex h-[120px] w-[80px] flex-shrink-0 items-center justify-center rounded-2xl border border-gray-200 bg-gray-100 text-gray-700 transition hover:bg-gray-200 active:scale-95 ml-1\"\n                  aria-label=\"Добавить слайд\"\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    viewBox=\"0 0 24 24\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                        strokeWidth={2.5}\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        className=\"h-8 w-8\"\n                  >\n                    <path d=\"M12 5v14M5 12h14\" />\n                  </svg>\n                </button>\n              )}\n                </div>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n    </div>\n    </>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3325, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/useImageAspectRatio.ts"],"sourcesContent":["import { useEffect, useState } from \"react\";\r\n\r\n/**\r\n * Хук для определения соотношения сторон изображения в рантайме\r\n * @param imageSrc - URL изображения\r\n * @returns Соотношение сторон (width / height) или null, если еще не загружено\r\n */\r\nexport function useImageAspectRatio(imageSrc: string | null): number | null {\r\n  const [aspectRatio, setAspectRatio] = useState<number | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (!imageSrc) {\r\n      setAspectRatio(null);\r\n      return;\r\n    }\r\n\r\n    const img = new Image();\r\n    \r\n    img.onload = () => {\r\n      const ratio = img.naturalWidth / img.naturalHeight;\r\n      setAspectRatio(ratio);\r\n    };\r\n\r\n    img.onerror = () => {\r\n      setAspectRatio(null);\r\n    };\r\n\r\n    img.src = imageSrc;\r\n\r\n    return () => {\r\n      img.onload = null;\r\n      img.onerror = null;\r\n    };\r\n  }, [imageSrc]);\r\n\r\n  return aspectRatio;\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,SAAS,oBAAoB,QAAuB;IACzD,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAgB;IAE9D,IAAA,kNAAS,EAAC;QACR,IAAI,CAAC,UAAU;YACb,eAAe;YACf;QACF;QAEA,MAAM,MAAM,IAAI;QAEhB,IAAI,MAAM,GAAG;YACX,MAAM,QAAQ,IAAI,YAAY,GAAG,IAAI,aAAa;YAClD,eAAe;QACjB;QAEA,IAAI,OAAO,GAAG;YACZ,eAAe;QACjB;QAEA,IAAI,GAAG,GAAG;QAEV,OAAO;YACL,IAAI,MAAM,GAAG;YACb,IAAI,OAAO,GAAG;QAChB;IACF,GAAG;QAAC;KAAS;IAEb,OAAO;AACT"}},
    {"offset": {"line": 3360, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/AvatarCanvas.tsx"],"sourcesContent":["\"use client\";\n\nimport Image from \"next/image\";\nimport type { AvatarOption } from \"./types\";\nimport { useImageAspectRatio } from \"./useImageAspectRatio\";\n\ntype AvatarCanvasProps = {\n  avatar: AvatarOption | null;\n  position: { x: number; y: number }; // позиция центра в пикселях канвы\n  size: { width: number; height: number }; // размер в пикселях канвы\n  canvasSize: { width: number; height: number }; // размеры канвы в пикселях\n  onRemove: () => void;\n  onPointerDown: (event: React.PointerEvent<HTMLDivElement>) => void;\n  onResizeStart: (\n    event: React.PointerEvent<HTMLDivElement>,\n    corner: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\",\n  ) => void;\n};\n\nexport function AvatarCanvas({\n  avatar,\n  position,\n  size,\n  canvasSize,\n  onRemove,\n  onPointerDown,\n  onResizeStart,\n}: AvatarCanvasProps) {\n  if (!avatar) return null;\n\n  // Определяем соотношение сторон изображения\n  const imageAspectRatio = useImageAspectRatio(avatar.photo);\n\n  // Конвертируем пиксели канвы в проценты для отображения\n  const leftPercent = (position.x / canvasSize.width) * 100;\n  const topPercent = (position.y / canvasSize.height) * 100;\n  const widthPercent = (size.width / canvasSize.width) * 100;\n\n  const resizeHandles: Array<{\n    corner: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\";\n    cursor: string;\n    position: string;\n  }> = [\n    { corner: \"top-left\", cursor: \"cursor-nwse-resize\", position: \"top-0 left-0\" },\n    { corner: \"top-right\", cursor: \"cursor-nesw-resize\", position: \"top-0 right-0\" },\n    { corner: \"bottom-left\", cursor: \"cursor-nesw-resize\", position: \"bottom-0 left-0\" },\n    { corner: \"bottom-right\", cursor: \"cursor-nwse-resize\", position: \"bottom-0 right-0\" },\n  ];\n\n  return (\n    <div\n      className=\"group absolute cursor-grab active:cursor-grabbing\"\n      style={{\n        left: `${leftPercent}%`,\n        top: `${topPercent}%`,\n        width: `${widthPercent}%`,\n        aspectRatio: imageAspectRatio ? `${imageAspectRatio} / 1` : undefined,\n        transform: \"translate(-50%, -50%)\",\n      }}\n      onPointerDown={onPointerDown}\n      role=\"button\"\n      tabIndex={0}\n    >\n      {/* Фото аватара */}\n      <img\n        src={avatar.photo}\n        alt={avatar.name}\n        className=\"w-full h-full object-cover rounded-2xl\"\n      />\n      \n      {/* Маркеры масштабирования по углам */}\n      {resizeHandles.map(({ corner, cursor, position }) => (\n        <div\n          key={corner}\n          className={`absolute h-5 w-5 rounded-full bg-white border-2 border-gray-600 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity hover:border-gray-900 hover:scale-125 ${cursor} ${position}`}\n          style={{\n            transform: corner === \"top-left\" \n              ? \"translate(-50%, -50%)\" \n              : corner === \"top-right\"\n              ? \"translate(50%, -50%)\"\n              : corner === \"bottom-left\"\n              ? \"translate(-50%, 50%)\"\n              : \"translate(50%, 50%)\",\n          }}\n          onPointerDown={(e) => {\n            e.stopPropagation();\n            onResizeStart(e, corner);\n          }}\n          role=\"button\"\n          tabIndex={0}\n        />\n      ))}\n\n      {/* Кнопка удаления - красная и масштабируемая */}\n      <button\n        type=\"button\"\n        onClick={(e) => {\n          e.stopPropagation();\n          onRemove();\n        }}\n        className=\"absolute right-0 top-0 flex items-center justify-center rounded-full bg-red-500 text-white opacity-0 transition-opacity hover:bg-red-600 group-hover:opacity-100 z-10\"\n        style={{\n          width: `${Math.min(40, Math.max(24, Math.min(size.width, size.height) * 0.08))}px`,\n          height: `${Math.min(40, Math.max(24, Math.min(size.width, size.height) * 0.08))}px`,\n          transform: 'translate(50%, -50%)',\n        }}\n        aria-label=\"Удалить аватар\"\n      >\n        <svg\n          xmlns=\"http://www.w3.org/2000/svg\"\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth={2.5}\n          className=\"w-full h-full p-1\"\n        >\n          <path d=\"M18 6L6 18M6 6l12 12\" />\n        </svg>\n      </button>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AAIA;AAJA;;;AAmBO,SAAS,aAAa,EAC3B,MAAM,EACN,QAAQ,EACR,IAAI,EACJ,UAAU,EACV,QAAQ,EACR,aAAa,EACb,aAAa,EACK;IAClB,IAAI,CAAC,QAAQ,OAAO;IAEpB,4CAA4C;IAC5C,MAAM,mBAAmB,IAAA,qLAAmB,EAAC,OAAO,KAAK;IAEzD,wDAAwD;IACxD,MAAM,cAAc,AAAC,SAAS,CAAC,GAAG,WAAW,KAAK,GAAI;IACtD,MAAM,aAAa,AAAC,SAAS,CAAC,GAAG,WAAW,MAAM,GAAI;IACtD,MAAM,eAAe,AAAC,KAAK,KAAK,GAAG,WAAW,KAAK,GAAI;IAEvD,MAAM,gBAID;QACH;YAAE,QAAQ;YAAY,QAAQ;YAAsB,UAAU;QAAe;QAC7E;YAAE,QAAQ;YAAa,QAAQ;YAAsB,UAAU;QAAgB;QAC/E;YAAE,QAAQ;YAAe,QAAQ;YAAsB,UAAU;QAAkB;QACnF;YAAE,QAAQ;YAAgB,QAAQ;YAAsB,UAAU;QAAmB;KACtF;IAED,qBACE,8OAAC;QACC,WAAU;QACV,OAAO;YACL,MAAM,GAAG,YAAY,CAAC,CAAC;YACvB,KAAK,GAAG,WAAW,CAAC,CAAC;YACrB,OAAO,GAAG,aAAa,CAAC,CAAC;YACzB,aAAa,mBAAmB,GAAG,iBAAiB,IAAI,CAAC,GAAG;YAC5D,WAAW;QACb;QACA,eAAe;QACf,MAAK;QACL,UAAU;;0BAGV,8OAAC;gBACC,KAAK,OAAO,KAAK;gBACjB,KAAK,OAAO,IAAI;gBAChB,WAAU;;;;;;YAIX,cAAc,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,iBAC9C,8OAAC;oBAEC,WAAW,CAAC,qKAAqK,EAAE,OAAO,CAAC,EAAE,UAAU;oBACvM,OAAO;wBACL,WAAW,WAAW,aAClB,0BACA,WAAW,cACX,yBACA,WAAW,gBACX,yBACA;oBACN;oBACA,eAAe,CAAC;wBACd,EAAE,eAAe;wBACjB,cAAc,GAAG;oBACnB;oBACA,MAAK;oBACL,UAAU;mBAhBL;;;;;0BAqBT,8OAAC;gBACC,MAAK;gBACL,SAAS,CAAC;oBACR,EAAE,eAAe;oBACjB;gBACF;gBACA,WAAU;gBACV,OAAO;oBACL,OAAO,GAAG,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,KAAK,KAAK,EAAE,KAAK,MAAM,IAAI,OAAO,EAAE,CAAC;oBAClF,QAAQ,GAAG,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,KAAK,KAAK,EAAE,KAAK,MAAM,IAAI,OAAO,EAAE,CAAC;oBACnF,WAAW;gBACb;gBACA,cAAW;0BAEX,cAAA,8OAAC;oBACC,OAAM;oBACN,SAAQ;oBACR,MAAK;oBACL,QAAO;oBACP,aAAa;oBACb,WAAU;8BAEV,cAAA,8OAAC;wBAAK,GAAE;;;;;;;;;;;;;;;;;;;;;;AAKlB"}},
    {"offset": {"line": 3485, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/MediaCanvas.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport type { CanvasElement } from \"./types\";\r\nimport { useImageAspectRatio } from \"./useImageAspectRatio\";\r\n\r\ntype MediaCanvasProps = {\r\n  element: CanvasElement;\r\n  canvasSize: { width: number; height: number };\r\n  onRemove: () => void;\r\n  onPointerDown: (event: React.PointerEvent<HTMLDivElement>) => void;\r\n  onResizeStart: (\r\n    event: React.PointerEvent<HTMLDivElement>,\r\n    corner: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\",\r\n  ) => void;\r\n};\r\n\r\nexport function MediaCanvas({\r\n  element,\r\n  canvasSize,\r\n  onRemove,\r\n  onPointerDown,\r\n  onResizeStart,\r\n}: MediaCanvasProps) {\r\n  if (!element.imageUrl) return null;\r\n\r\n  // Определяем соотношение сторон изображения\r\n  const imageAspectRatio = useImageAspectRatio(element.imageUrl);\r\n\r\n  // Конвертируем пиксели канвы в проценты для отображения\r\n  const leftPercent = (element.x / canvasSize.width) * 100;\r\n  const topPercent = (element.y / canvasSize.height) * 100;\r\n  const widthPercent = (element.width / canvasSize.width) * 100;\r\n\r\n  const resizeHandles: Array<{\r\n    corner: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\";\r\n    cursor: string;\r\n    position: string;\r\n  }> = [\r\n    { corner: \"top-left\", cursor: \"cursor-nwse-resize\", position: \"top-0 left-0\" },\r\n    { corner: \"top-right\", cursor: \"cursor-nesw-resize\", position: \"top-0 right-0\" },\r\n    { corner: \"bottom-left\", cursor: \"cursor-nesw-resize\", position: \"bottom-0 left-0\" },\r\n    { corner: \"bottom-right\", cursor: \"cursor-nwse-resize\", position: \"bottom-0 right-0\" },\r\n  ];\r\n\r\n  return (\r\n    <div\r\n      className=\"group absolute cursor-grab active:cursor-grabbing\"\r\n      style={{\r\n        left: `${leftPercent}%`,\r\n        top: `${topPercent}%`,\r\n        width: `${widthPercent}%`,\r\n        aspectRatio: imageAspectRatio ? `${imageAspectRatio} / 1` : undefined,\r\n        transform: \"translate(-50%, -50%)\",\r\n      }}\r\n      onPointerDown={onPointerDown}\r\n      role=\"button\"\r\n      tabIndex={0}\r\n    >\r\n      {/* Изображение медиа */}\r\n      <img\r\n        src={element.imageUrl}\r\n        alt={element.label}\r\n        className=\"w-full h-full object-cover rounded-2xl\"\r\n      />\r\n      \r\n      {/* Маркеры масштабирования по углам */}\r\n      {resizeHandles.map(({ corner, cursor, position }) => (\r\n        <div\r\n          key={corner}\r\n          className={`absolute h-5 w-5 rounded-full bg-white border-2 border-gray-600 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity hover:border-gray-900 hover:scale-125 ${cursor} ${position}`}\r\n          style={{\r\n            transform: corner === \"top-left\" \r\n              ? \"translate(-50%, -50%)\" \r\n              : corner === \"top-right\"\r\n              ? \"translate(50%, -50%)\"\r\n              : corner === \"bottom-left\"\r\n              ? \"translate(-50%, 50%)\"\r\n              : \"translate(50%, 50%)\",\r\n          }}\r\n          onPointerDown={(e) => {\r\n            e.stopPropagation();\r\n            onResizeStart(e, corner);\r\n          }}\r\n          role=\"button\"\r\n          tabIndex={0}\r\n        />\r\n      ))}\r\n\r\n      {/* Кнопка удаления */}\r\n      <button\r\n        type=\"button\"\r\n        onClick={(e) => {\r\n          e.stopPropagation();\r\n          onRemove();\r\n        }}\r\n        className=\"absolute right-0 top-0 flex items-center justify-center rounded-full bg-red-500 text-white opacity-0 transition-opacity hover:bg-red-600 group-hover:opacity-100 z-10\"\r\n        style={{\r\n          width: `${Math.min(40, Math.max(24, Math.min(element.width, element.height) * 0.08))}px`,\r\n          height: `${Math.min(40, Math.max(24, Math.min(element.width, element.height) * 0.08))}px`,\r\n          transform: 'translate(50%, -50%)',\r\n        }}\r\n        aria-label=\"Удалить медиа\"\r\n      >\r\n        <svg\r\n          xmlns=\"http://www.w3.org/2000/svg\"\r\n          viewBox=\"0 0 24 24\"\r\n          fill=\"none\"\r\n          stroke=\"currentColor\"\r\n          strokeWidth={2.5}\r\n          className=\"w-full h-full p-1\"\r\n        >\r\n          <path d=\"M18 6L6 18M6 6l12 12\" />\r\n        </svg>\r\n      </button>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;AAGA;AAHA;;;AAgBO,SAAS,YAAY,EAC1B,OAAO,EACP,UAAU,EACV,QAAQ,EACR,aAAa,EACb,aAAa,EACI;IACjB,IAAI,CAAC,QAAQ,QAAQ,EAAE,OAAO;IAE9B,4CAA4C;IAC5C,MAAM,mBAAmB,IAAA,qLAAmB,EAAC,QAAQ,QAAQ;IAE7D,wDAAwD;IACxD,MAAM,cAAc,AAAC,QAAQ,CAAC,GAAG,WAAW,KAAK,GAAI;IACrD,MAAM,aAAa,AAAC,QAAQ,CAAC,GAAG,WAAW,MAAM,GAAI;IACrD,MAAM,eAAe,AAAC,QAAQ,KAAK,GAAG,WAAW,KAAK,GAAI;IAE1D,MAAM,gBAID;QACH;YAAE,QAAQ;YAAY,QAAQ;YAAsB,UAAU;QAAe;QAC7E;YAAE,QAAQ;YAAa,QAAQ;YAAsB,UAAU;QAAgB;QAC/E;YAAE,QAAQ;YAAe,QAAQ;YAAsB,UAAU;QAAkB;QACnF;YAAE,QAAQ;YAAgB,QAAQ;YAAsB,UAAU;QAAmB;KACtF;IAED,qBACE,8OAAC;QACC,WAAU;QACV,OAAO;YACL,MAAM,GAAG,YAAY,CAAC,CAAC;YACvB,KAAK,GAAG,WAAW,CAAC,CAAC;YACrB,OAAO,GAAG,aAAa,CAAC,CAAC;YACzB,aAAa,mBAAmB,GAAG,iBAAiB,IAAI,CAAC,GAAG;YAC5D,WAAW;QACb;QACA,eAAe;QACf,MAAK;QACL,UAAU;;0BAGV,8OAAC;gBACC,KAAK,QAAQ,QAAQ;gBACrB,KAAK,QAAQ,KAAK;gBAClB,WAAU;;;;;;YAIX,cAAc,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,iBAC9C,8OAAC;oBAEC,WAAW,CAAC,qKAAqK,EAAE,OAAO,CAAC,EAAE,UAAU;oBACvM,OAAO;wBACL,WAAW,WAAW,aAClB,0BACA,WAAW,cACX,yBACA,WAAW,gBACX,yBACA;oBACN;oBACA,eAAe,CAAC;wBACd,EAAE,eAAe;wBACjB,cAAc,GAAG;oBACnB;oBACA,MAAK;oBACL,UAAU;mBAhBL;;;;;0BAqBT,8OAAC;gBACC,MAAK;gBACL,SAAS,CAAC;oBACR,EAAE,eAAe;oBACjB;gBACF;gBACA,WAAU;gBACV,OAAO;oBACL,OAAO,GAAG,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,QAAQ,KAAK,EAAE,QAAQ,MAAM,IAAI,OAAO,EAAE,CAAC;oBACxF,QAAQ,GAAG,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,QAAQ,KAAK,EAAE,QAAQ,MAAM,IAAI,OAAO,EAAE,CAAC;oBACzF,WAAW;gBACb;gBACA,cAAW;0BAEX,cAAA,8OAAC;oBACC,OAAM;oBACN,SAAQ;oBACR,MAAK;oBACL,QAAO;oBACP,aAAa;oBACb,WAAU;8BAEV,cAAA,8OAAC;wBAAK,GAAE;;;;;;;;;;;;;;;;;;;;;;AAKlB"}},
    {"offset": {"line": 3610, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/MediaCanvasWrapper.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useCallback } from \"react\";\r\nimport type { CanvasElement } from \"./types\";\r\nimport { MediaCanvas } from \"./MediaCanvas\";\r\nimport { useImageAspectRatio } from \"./useImageAspectRatio\";\r\n\r\ntype MediaCanvasWrapperProps = {\r\n  element: CanvasElement;\r\n  canvasSize: { width: number; height: number };\r\n  onRemove: () => void;\r\n  onPointerDown: (event: React.PointerEvent<HTMLDivElement>) => void;\r\n  onResizeStart: (\r\n    event: React.PointerEvent<HTMLDivElement>,\r\n    corner: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\",\r\n    imageAspectRatio: number,\r\n  ) => void;\r\n  screenToCanvas: (screenPx: number, dimension: \"width\" | \"height\") => number;\r\n  onElementSizeChange: (elementId: string, size: { width: number; height: number }) => void;\r\n};\r\n\r\nexport function MediaCanvasWrapper({\r\n  element,\r\n  canvasSize,\r\n  onRemove,\r\n  onPointerDown,\r\n  onResizeStart,\r\n  screenToCanvas,\r\n  onElementSizeChange,\r\n}: MediaCanvasWrapperProps) {\r\n  const imageAspectRatio = useImageAspectRatio(element.imageUrl ?? null);\r\n\r\n  const handleResizeStart = useCallback(\r\n    (\r\n      event: React.PointerEvent<HTMLDivElement>,\r\n      corner: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\",\r\n    ) => {\r\n      if (!imageAspectRatio) return;\r\n      \r\n      event.preventDefault();\r\n      event.stopPropagation();\r\n\r\n      const startX = event.clientX;\r\n      const startY = event.clientY;\r\n      const initialWidth = element.width;\r\n      const initialHeight = initialWidth / imageAspectRatio;\r\n      const initialX = element.x;\r\n      const initialY = element.y;\r\n\r\n      const centerX = initialX;\r\n      const centerY = initialY;\r\n      const halfWidth = initialWidth / 2;\r\n      const halfHeight = initialHeight / 2;\r\n      \r\n      let initialCornerX: number, initialCornerY: number;\r\n      if (corner === \"top-left\") {\r\n        initialCornerX = centerX - halfWidth;\r\n        initialCornerY = centerY - halfHeight;\r\n      } else if (corner === \"top-right\") {\r\n        initialCornerX = centerX + halfWidth;\r\n        initialCornerY = centerY - halfHeight;\r\n      } else if (corner === \"bottom-left\") {\r\n        initialCornerX = centerX - halfWidth;\r\n        initialCornerY = centerY + halfHeight;\r\n      } else {\r\n        initialCornerX = centerX + halfWidth;\r\n        initialCornerY = centerY + halfHeight;\r\n      }\r\n\r\n      const initialDistance = Math.sqrt(\r\n        Math.pow(initialCornerX - centerX, 2) + Math.pow(initialCornerY - centerY, 2),\r\n      );\r\n\r\n      let rafId: number | null = null;\r\n\r\n      const handlePointerMove = (moveEvent: PointerEvent) => {\r\n        if (rafId !== null) {\r\n          cancelAnimationFrame(rafId);\r\n        }\r\n\r\n        rafId = requestAnimationFrame(() => {\r\n          const deltaXScreen = moveEvent.clientX - startX;\r\n          const deltaYScreen = moveEvent.clientY - startY;\r\n\r\n          const deltaX = screenToCanvas(deltaXScreen, \"width\");\r\n          const deltaY = screenToCanvas(deltaYScreen, \"height\");\r\n\r\n          const newCornerX = initialCornerX + deltaX;\r\n          const newCornerY = initialCornerY + deltaY;\r\n\r\n          const newDistance = Math.sqrt(\r\n            Math.pow(newCornerX - centerX, 2) + Math.pow(newCornerY - centerY, 2),\r\n          );\r\n\r\n          const scale = newDistance / initialDistance;\r\n          \r\n          let newWidth = initialWidth * scale;\r\n          let newHeight = newWidth / imageAspectRatio;\r\n\r\n          const minSizePx = Math.min(canvasSize.width, canvasSize.height) * 0.05;\r\n          const maxWidthPx = canvasSize.width; // Максимальная ширина = 100% ширины канвы\r\n          const maxHeightPx = canvasSize.height; // Максимальная высота = 100% высоты канвы\r\n          \r\n          if (newWidth > maxWidthPx) {\r\n            newWidth = maxWidthPx;\r\n            newHeight = newWidth / imageAspectRatio;\r\n          }\r\n          if (newWidth < minSizePx) {\r\n            newWidth = minSizePx;\r\n            newHeight = newWidth / imageAspectRatio;\r\n          }\r\n          \r\n          if (newHeight > maxHeightPx) {\r\n            newHeight = maxHeightPx;\r\n            newWidth = newHeight * imageAspectRatio;\r\n          }\r\n          if (newHeight < minSizePx) {\r\n            newHeight = minSizePx;\r\n            newWidth = newHeight * imageAspectRatio;\r\n          }\r\n\r\n          onElementSizeChange(element.id, { width: newWidth, height: newHeight });\r\n          rafId = null;\r\n        });\r\n      };\r\n\r\n      const handlePointerUp = () => {\r\n        if (rafId !== null) {\r\n          cancelAnimationFrame(rafId);\r\n          rafId = null;\r\n        }\r\n        window.removeEventListener(\"pointermove\", handlePointerMove);\r\n        window.removeEventListener(\"pointerup\", handlePointerUp);\r\n      };\r\n\r\n      window.addEventListener(\"pointermove\", handlePointerMove);\r\n      window.addEventListener(\"pointerup\", handlePointerUp);\r\n    },\r\n    [element, imageAspectRatio, screenToCanvas, canvasSize, onElementSizeChange],\r\n  );\r\n\r\n  if (!imageAspectRatio) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <MediaCanvas\r\n      element={element}\r\n      canvasSize={canvasSize}\r\n      onRemove={onRemove}\r\n      onPointerDown={onPointerDown}\r\n      onResizeStart={handleResizeStart}\r\n    />\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3732, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/LayersPanel.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useMemo } from \"react\";\nimport type { CanvasElement, AvatarOption } from \"./types\";\n\ntype LayerItem = {\n  id: string;\n  type: \"avatar\" | \"media\";\n  label: string;\n  thumbnail?: string;\n  zIndex: number;\n};\n\ntype LayersPanelProps = {\n  isOpen: boolean;\n  onClose: () => void;\n  elements: CanvasElement[];\n  avatar: AvatarOption | null;\n  avatarZIndex?: number;\n  avatarLocked?: boolean;\n  onReorderLayers: (newOrder: string[]) => void;\n  onToggleAvatarLock: () => void;\n  panelRef?: React.RefObject<HTMLDivElement | null>;\n};\n\nexport function LayersPanel({\n  isOpen,\n  onClose,\n  elements,\n  avatar,\n  avatarZIndex,\n  avatarLocked,\n  onReorderLayers,\n  onToggleAvatarLock,\n  panelRef,\n}: LayersPanelProps) {\n  const [draggedId, setDraggedId] = useState<string | null>(null);\n  const [dragOverId, setDragOverId] = useState<string | null>(null);\n\n  // Создаем список слоев: элементы и аватар отсортированные по zIndex (больший zIndex = выше = первый в списке)\n  const layers: LayerItem[] = useMemo(() => {\n    const allLayers: LayerItem[] = [\n      ...elements.map((el) => ({\n        id: el.id,\n        type: \"media\" as const,\n        label: el.label,\n        thumbnail: el.imageUrl,\n        zIndex: el.zIndex ?? 0,\n      })),\n      ...(avatar\n        ? [\n            {\n              id: \"avatar\",\n              type: \"avatar\" as const,\n              label: avatar.name,\n              thumbnail: avatar.photo,\n              zIndex: avatarZIndex ?? 9999,\n            },\n          ]\n        : []),\n    ];\n    return allLayers.sort((a, b) => b.zIndex - a.zIndex); // Больший zIndex = первый в списке\n  }, [elements, avatar, avatarZIndex]);\n\n  const handleDragStart = (e: React.DragEvent, id: string) => {\n    // Аватар не перетаскивается, если заблокирован\n    if (id === \"avatar\" && avatarLocked) {\n      e.preventDefault();\n      return;\n    }\n    setDraggedId(id);\n    e.dataTransfer.effectAllowed = \"move\";\n    e.dataTransfer.setData(\"text/plain\", id);\n  };\n\n  const handleDragOver = (e: React.DragEvent, id: string) => {\n    // Нельзя перетаскивать на заблокированный аватар или перетаскивать заблокированный аватар\n    if ((id === \"avatar\" && avatarLocked) || (draggedId === \"avatar\" && avatarLocked)) {\n      return;\n    }\n    e.preventDefault();\n    e.stopPropagation();\n    if (draggedId && draggedId !== id) {\n      setDragOverId(id);\n    }\n  };\n\n  const handleDragLeave = () => {\n    setDragOverId(null);\n  };\n\n  const handleDrop = (e: React.DragEvent, targetId: string) => {\n    e.preventDefault();\n    e.stopPropagation();\n    \n    // Нельзя перетаскивать на заблокированный аватар или перетаскивать заблокированный аватар\n    if ((targetId === \"avatar\" && avatarLocked) || !draggedId || draggedId === targetId || (draggedId === \"avatar\" && avatarLocked)) {\n      setDraggedId(null);\n      setDragOverId(null);\n      return;\n    }\n\n    // Используем актуальный список layers\n    const currentLayers = [\n      ...elements.map((el) => ({\n        id: el.id,\n        type: \"media\" as const,\n        label: el.label,\n        thumbnail: el.imageUrl,\n        zIndex: el.zIndex ?? 0,\n      })),\n      ...(avatar\n        ? [\n            {\n              id: \"avatar\",\n              type: \"avatar\" as const,\n              label: avatar.name,\n              thumbnail: avatar.photo,\n              zIndex: avatarZIndex ?? 9999,\n            },\n          ]\n        : []),\n    ].sort((a, b) => b.zIndex - a.zIndex);\n\n    const draggedIndex = currentLayers.findIndex((l) => l.id === draggedId);\n    const targetIndex = currentLayers.findIndex((l) => l.id === targetId);\n\n    if (draggedIndex === -1 || targetIndex === -1) {\n      setDraggedId(null);\n      setDragOverId(null);\n      return;\n    }\n\n    // Создаем новый порядок слоев\n    const newLayers = [...currentLayers];\n    const [draggedLayer] = newLayers.splice(draggedIndex, 1);\n    newLayers.splice(targetIndex, 0, draggedLayer);\n\n    // Обновляем zIndex: первый в списке (index 0) = больший zIndex = выше на канве\n    const newOrder = newLayers.map((l) => l.id);\n    onReorderLayers(newOrder);\n\n    setDraggedId(null);\n    setDragOverId(null);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedId(null);\n    setDragOverId(null);\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div\n      ref={panelRef}\n      className=\"absolute right-0 top-full z-50 mt-2 w-[416px] rounded-xl border border-gray-200 bg-white shadow-lg\"\n    >\n      <div className=\"p-4\">\n        <div className=\"mb-4\">\n          <h2 className=\"text-lg font-semibold text-gray-900\">Слои</h2>\n        </div>\n\n        <div className=\"space-y-2\">\n          {layers.length === 0 ? (\n            <p className=\"py-8 text-center text-sm text-gray-500\">\n              Нет элементов на канве\n            </p>\n          ) : (\n            layers.map((layer, index) => {\n              const isAvatar = layer.type === \"avatar\";\n              const isLocked = isAvatar && avatarLocked;\n              return (\n              <div\n                key={layer.id}\n                draggable={!isLocked}\n                onDragStart={(e) => handleDragStart(e, layer.id)}\n                onDragOver={(e) => handleDragOver(e, layer.id)}\n                onDragLeave={handleDragLeave}\n                onDrop={(e) => handleDrop(e, layer.id)}\n                onDragEnd={handleDragEnd}\n                className={`flex items-center gap-3 rounded-xl border-2 p-3 transition ${\n                  draggedId === layer.id\n                    ? \"cursor-move opacity-50\"\n                    : dragOverId === layer.id && !isLocked\n                    ? \"cursor-move border-blue-500 bg-blue-50\"\n                    : isLocked\n                    ? \"cursor-default border-gray-200 bg-gray-50\"\n                    : \"cursor-move border-gray-200 hover:border-gray-300\"\n                }`}\n              >\n                <div className=\"flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg bg-gray-100 text-xs font-semibold text-gray-600\">\n                  {index + 1}\n                </div>\n                {layer.thumbnail ? (\n                  <div className=\"relative h-10 w-10 flex-shrink-0 overflow-hidden rounded-lg\">\n                    <img\n                      src={layer.thumbnail}\n                      alt={layer.label}\n                      className=\"h-full w-full object-cover\"\n                    />\n                  </div>\n                ) : (\n                  <div className=\"flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg bg-gray-200\">\n                    <span className=\"text-xs text-gray-500\">\n                      {layer.type === \"avatar\" ? \"👤\" : \"📄\"}\n                    </span>\n                  </div>\n                )}\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium text-gray-900 truncate\">{layer.label}</p>\n                  <p className=\"text-xs text-gray-500 truncate\">\n                    {layer.type === \"avatar\" ? \"Аватар\" : \"Медиа\"}\n                  </p>\n                </div>\n                 {isAvatar ? (\n                   <button\n                     type=\"button\"\n                     onClick={(e) => {\n                       e.stopPropagation();\n                       onToggleAvatarLock();\n                     }}\n                     className={`flex-shrink-0 rounded-lg px-3 py-1.5 text-xs font-medium transition ${\n                       avatarLocked\n                         ? \"bg-red-100 text-red-600 hover:bg-red-200\"\n                         : \"bg-green-100 text-green-600 hover:bg-green-200\"\n                     }`}\n                     aria-label={avatarLocked ? \"Разблокировать аватар\" : \"Заблокировать аватар\"}\n                   >\n                     {avatarLocked ? \"Заблокирован\" : \"Разблокирован\"}\n                   </button>\n                 ) : (\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    viewBox=\"0 0 24 24\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth={2}\n                    className=\"h-5 w-5 flex-shrink-0 text-gray-400\"\n                  >\n                    <path d=\"M8 9h8M8 15h8\" />\n                  </svg>\n                )}\n              </div>\n            );\n            })\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4011, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/CanvasArea.tsx"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useRef, useState, useMemo, useEffect } from \"react\";\nimport type { AspectRatio, CanvasElement, AvatarOption, MediaAsset } from \"./types\";\nimport { AvatarCanvas } from \"./AvatarCanvas\";\nimport { MediaCanvasWrapper } from \"./MediaCanvasWrapper\";\nimport { LayersPanel } from \"./LayersPanel\";\nimport { useImageAspectRatio } from \"./useImageAspectRatio\";\n\n// Размеры канвы в пикселях\nconst CANVAS_SIZES: Record<AspectRatio, { width: number; height: number }> = {\n  \"16:9\": { width: 1920, height: 1080 },\n  \"9:16\": { width: 1080, height: 1920 },\n};\n\ntype CanvasAreaProps = {\n  aspectRatio: AspectRatio;\n  elements: CanvasElement[];\n  mediaAssets: MediaAsset[];\n  avatar: AvatarOption | null;\n  avatarPosition: { x: number; y: number };\n  avatarSize: { width: number; height: number };\n  avatarZIndex?: number;\n  avatarLocked?: boolean;\n  onElementPositionChange: (\n    elementId: string,\n    coords: { x: number; y: number },\n  ) => void;\n  onElementSizeChange: (\n    elementId: string,\n    size: { width: number; height: number },\n  ) => void;\n  onRemoveElement: (elementId: string) => void;\n  onReorderLayers: (newOrder: string[]) => void;\n  onAvatarPositionChange: (coords: { x: number; y: number }) => void;\n  onAvatarSizeChange: (size: { width: number; height: number }) => void;\n  onAlignAvatars?: () => void;\n  onAddMediaAsset: (imageUrl?: string, fileName?: string) => void;\n  onUseMediaAsset: (assetId: string) => void;\n  onUseMediaAssetAtPosition?: (assetId: string, x: number, y: number) => void;\n  onRemoveMediaAsset: (assetId: string) => void;\n  onRemoveAvatar: () => void;\n  onToggleAvatarLock: () => void;\n};\n\nexport function CanvasArea({\n  aspectRatio,\n  elements,\n  mediaAssets,\n  avatar,\n  avatarPosition,\n  avatarSize,\n  avatarZIndex,\n  avatarLocked,\n  onElementPositionChange,\n  onElementSizeChange,\n  onRemoveElement,\n  onReorderLayers,\n  onAvatarPositionChange,\n  onAvatarSizeChange,\n  onAlignAvatars,\n  onAddMediaAsset,\n  onUseMediaAsset,\n  onUseMediaAssetAtPosition,\n  onRemoveMediaAsset,\n  onRemoveAvatar,\n  onToggleAvatarLock,\n}: CanvasAreaProps) {\n  const canvasRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const layersButtonRef = useRef<HTMLButtonElement>(null);\n  const layersPanelRef = useRef<HTMLDivElement>(null);\n  const mediaButtonRef = useRef<HTMLButtonElement>(null);\n  const mediaPanelRef = useRef<HTMLDivElement>(null);\n  const layersCloseTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const mediaCloseTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const [isLayersPanelOpen, setIsLayersPanelOpen] = useState(false);\n  const [isMediaPanelOpen, setIsMediaPanelOpen] = useState(false);\n  const [draggedMediaAssetId, setDraggedMediaAssetId] = useState<string | null>(null);\n  const [isDraggingOverCanvas, setIsDraggingOverCanvas] = useState(false);\n\n  const mediaUsageOnScene = useMemo(() => {\n    return elements.reduce<Record<string, number>>((acc, element) => {\n      if (element.type === \"media\" && element.assetId) {\n        acc[element.assetId] = (acc[element.assetId] || 0) + 1;\n      }\n      return acc;\n    }, {});\n  }, [elements]);\n\n  // Закрытие меню слоев при клике вне его\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        isLayersPanelOpen &&\n        layersButtonRef.current &&\n        layersPanelRef.current &&\n        !layersButtonRef.current.contains(event.target as Node) &&\n        !layersPanelRef.current.contains(event.target as Node)\n      ) {\n        setIsLayersPanelOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, [isLayersPanelOpen]);\n\n  // Закрытие меню медиа при клике вне его\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        isMediaPanelOpen &&\n        mediaButtonRef.current &&\n        mediaPanelRef.current &&\n        !mediaButtonRef.current.contains(event.target as Node) &&\n        !mediaPanelRef.current.contains(event.target as Node)\n      ) {\n        setIsMediaPanelOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => {\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, [isMediaPanelOpen]);\n\n  // Обработчики для автоматического закрытия меню слоев\n  const handleLayersMouseEnter = () => {\n    if (layersCloseTimeoutRef.current) {\n      clearTimeout(layersCloseTimeoutRef.current);\n      layersCloseTimeoutRef.current = null;\n    }\n  };\n\n  const handleLayersMouseLeave = () => {\n    layersCloseTimeoutRef.current = setTimeout(() => {\n      setIsLayersPanelOpen(false);\n    }, 500);\n  };\n\n  // Обработчики для автоматического закрытия меню медиа\n  const handleMediaMouseEnter = () => {\n    if (mediaCloseTimeoutRef.current) {\n      clearTimeout(mediaCloseTimeoutRef.current);\n      mediaCloseTimeoutRef.current = null;\n    }\n  };\n\n  const handleMediaMouseLeave = () => {\n    mediaCloseTimeoutRef.current = setTimeout(() => {\n      setIsMediaPanelOpen(false);\n    }, 500);\n  };\n\n  // Очистка таймеров при размонтировании\n  useEffect(() => {\n    return () => {\n      if (layersCloseTimeoutRef.current) {\n        clearTimeout(layersCloseTimeoutRef.current);\n      }\n      if (mediaCloseTimeoutRef.current) {\n        clearTimeout(mediaCloseTimeoutRef.current);\n      }\n    };\n  }, []);\n  const [draggingElementId, setDraggingElementId] = useState<string | null>(null);\n  const [dragCoords, setDragCoords] = useState<{ x: number; y: number } | null>(null);\n  const [draggingAvatar, setDraggingAvatar] = useState(false);\n  const [avatarDragCoords, setAvatarDragCoords] = useState<{ x: number; y: number } | null>(null);\n  const [snapPoint, setSnapPoint] = useState<{ x: number | null; y: number | null; type: string } | null>(null);\n\n  const canvasSize = CANVAS_SIZES[aspectRatio];\n  \n  // Получаем пропорции изображения аватара для правильного масштабирования\n  const avatarImageAspectRatio = useImageAspectRatio(avatar?.photo ?? null);\n  \n  // Получаем пропорции изображений медиа элементов\n  const mediaImageAspectRatios = useMemo(() => {\n    const ratios: Record<string, number | null> = {};\n    elements.forEach((element) => {\n      if (element.imageUrl) {\n        ratios[element.id] = null; // Будет установлено через хук\n      }\n    });\n    return ratios;\n  }, [elements]);\n\n  // Определяем линии привязки\n  const snapLines = useMemo(() => {\n    const snapDistance = 160; // Расстояние от углов\n    return {\n      vertical: [snapDistance, canvasSize.width - snapDistance, canvasSize.width / 2],\n      horizontal: [snapDistance, canvasSize.height - snapDistance, canvasSize.height / 2],\n    };\n  }, [canvasSize]);\n\n  // Определяем точки привязки (пересечения линий)\n  const snapPoints = useMemo(() => {\n    const snapDistance = 160;\n    return [\n      { x: snapDistance, y: snapDistance, type: 'top-left' },\n      { x: canvasSize.width - snapDistance, y: snapDistance, type: 'top-right' },\n      { x: snapDistance, y: canvasSize.height - snapDistance, type: 'bottom-left' },\n      { x: canvasSize.width - snapDistance, y: canvasSize.height - snapDistance, type: 'bottom-right' },\n      { x: canvasSize.width / 2, y: canvasSize.height / 2, type: 'center' },\n    ];\n  }, [canvasSize]);\n\n  // Проверка привязки к линиям и точкам\n  const checkSnap = useCallback((x: number, y: number, threshold: number = 20) => {\n    let snapX: number | null = null;\n    let snapY: number | null = null;\n    let snapType = '';\n\n    // Проверяем привязку к вертикальным линиям\n    for (const lineX of snapLines.vertical) {\n      if (Math.abs(x - lineX) <= threshold) {\n        snapX = lineX;\n        break;\n      }\n    }\n\n    // Проверяем привязку к горизонтальным линиям\n    for (const lineY of snapLines.horizontal) {\n      if (Math.abs(y - lineY) <= threshold) {\n        snapY = lineY;\n        break;\n      }\n    }\n\n    // Проверяем привязку к точкам (пересечениям линий)\n    for (const point of snapPoints) {\n      const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));\n      if (distance <= threshold) {\n        // Если попали в точку, используем координаты точки\n        snapX = point.x;\n        snapY = point.y;\n        snapType = point.type;\n        break;\n      }\n    }\n\n    // Если есть привязка хотя бы по одной оси\n    if (snapX !== null || snapY !== null) {\n      return {\n        x: snapX,\n        y: snapY,\n        type: snapType || (snapX !== null && snapY !== null ? 'intersection' : snapX !== null ? 'vertical' : 'horizontal'),\n      };\n    }\n\n    return null;\n  }, [snapLines, snapPoints]);\n\n  // Конвертирует пиксели канвы в пиксели экрана\n  const canvasToScreen = useCallback((canvasPx: number, dimension: \"width\" | \"height\") => {\n    const canvas = canvasRef.current;\n    if (!canvas) return 0;\n    const rect = canvas.getBoundingClientRect();\n    const screenSize = dimension === \"width\" ? rect.width : rect.height;\n    const canvasSizePx = dimension === \"width\" ? canvasSize.width : canvasSize.height;\n    return (canvasPx / canvasSizePx) * screenSize;\n  }, [canvasSize]);\n\n  // Конвертирует пиксели экрана в пиксели канвы\n  const screenToCanvas = useCallback((screenPx: number, dimension: \"width\" | \"height\") => {\n    const canvas = canvasRef.current;\n    if (!canvas) return 0;\n    const rect = canvas.getBoundingClientRect();\n    const screenSize = dimension === \"width\" ? rect.width : rect.height;\n    const canvasSizePx = dimension === \"width\" ? canvasSize.width : canvasSize.height;\n    return (screenPx / screenSize) * canvasSizePx;\n  }, [canvasSize]);\n\n  const handlePointerDown = useCallback(\n    (event: React.PointerEvent<HTMLDivElement>, element: CanvasElement) => {\n      event.preventDefault();\n      const canvas = canvasRef.current;\n      if (!canvas) return;\n\n      setDraggingElementId(element.id);\n      const canvasRect = canvas.getBoundingClientRect();\n      \n      // Вычисляем позицию мыши относительно канвы\n      const mouseXRelative = event.clientX - canvasRect.left;\n      const mouseYRelative = event.clientY - canvasRect.top;\n      \n      // Конвертируем в пиксели канвы\n      const mouseXCanvas = screenToCanvas(mouseXRelative, \"width\");\n      const mouseYCanvas = screenToCanvas(mouseYRelative, \"height\");\n      \n      // Вычисляем смещение мыши относительно центра элемента\n      const offsetX = mouseXCanvas - element.x;\n      const offsetY = mouseYCanvas - element.y;\n      \n      const startX = event.clientX;\n      const startY = event.clientY;\n      const initialX = element.x;\n      const initialY = element.y;\n\n      const handlePointerMove = (moveEvent: PointerEvent) => {\n        const deltaXScreen = moveEvent.clientX - startX;\n        const deltaYScreen = moveEvent.clientY - startY;\n\n        // Конвертируем смещение экрана в пиксели канвы\n        const deltaX = screenToCanvas(deltaXScreen, \"width\");\n        const deltaY = screenToCanvas(deltaYScreen, \"height\");\n\n        // Вычисляем новую позицию центра элемента с учетом смещения мыши\n        let nextX = initialX + deltaX;\n        let nextY = initialY + deltaY;\n\n        // Ограничиваем позицию так, чтобы элемент не выходил за границы канвы\n        const halfWidth = element.width / 2;\n        const halfHeight = element.height / 2;\n\n        nextX = Math.min(\n          canvasSize.width - halfWidth,\n          Math.max(halfWidth, nextX),\n        );\n        nextY = Math.min(\n          canvasSize.height - halfHeight,\n          Math.max(halfHeight, nextY),\n        );\n\n        setDragCoords({ x: Math.round(nextX), y: Math.round(nextY) });\n        onElementPositionChange(element.id, { x: nextX, y: nextY });\n      };\n\n      const handlePointerUp = () => {\n        setDraggingElementId(null);\n        setDragCoords(null);\n        window.removeEventListener(\"pointermove\", handlePointerMove);\n        window.removeEventListener(\"pointerup\", handlePointerUp);\n      };\n\n      window.addEventListener(\"pointermove\", handlePointerMove);\n      window.addEventListener(\"pointerup\", handlePointerUp);\n    },\n    [onElementPositionChange, screenToCanvas, canvasSize],\n  );\n\n  const handleAvatarPointerDown = useCallback(\n    (event: React.PointerEvent<HTMLDivElement>) => {\n      event.preventDefault();\n      const canvas = canvasRef.current;\n      if (!canvas) return;\n\n      setDraggingAvatar(true);\n      const startX = event.clientX;\n      const startY = event.clientY;\n      \n      // Начальная позиция центра аватара в пикселях канвы\n      const initialX = Math.max(0, Math.min(canvasSize.width, avatarPosition.x));\n      const initialY = Math.max(0, Math.min(canvasSize.height, avatarPosition.y));\n\n      let rafId: number | null = null;\n\n      const handlePointerMove = (moveEvent: PointerEvent) => {\n        if (rafId !== null) {\n          cancelAnimationFrame(rafId);\n        }\n\n        rafId = requestAnimationFrame(() => {\n          const deltaXScreen = moveEvent.clientX - startX;\n          const deltaYScreen = moveEvent.clientY - startY;\n\n          // Конвертируем смещение экрана в пиксели канвы\n          const deltaX = screenToCanvas(deltaXScreen, \"width\");\n          const deltaY = screenToCanvas(deltaYScreen, \"height\");\n\n          // Вычисляем новую позицию центра аватара\n          let nextX = initialX + deltaX;\n          let nextY = initialY + deltaY;\n\n          // Проверяем привязку к линиям и точкам\n          const snap = checkSnap(nextX, nextY);\n          if (snap) {\n            // Фиксируем координаты только если есть привязка по соответствующей оси\n            if (snap.x !== null) {\n              nextX = snap.x;\n            }\n            if (snap.y !== null) {\n              nextY = snap.y;\n            }\n            setSnapPoint(snap);\n          } else {\n            setSnapPoint(null);\n          }\n\n          // Ограничиваем позицию так, чтобы центр аватара не выходил за границы канвы\n          nextX = Math.max(0, Math.min(canvasSize.width, nextX));\n          nextY = Math.max(0, Math.min(canvasSize.height, nextY));\n\n          setAvatarDragCoords({ x: Math.round(nextX), y: Math.round(nextY) });\n          onAvatarPositionChange({ x: nextX, y: nextY });\n          rafId = null;\n        });\n      };\n\n      const handlePointerUp = () => {\n        setDraggingAvatar(false);\n        setAvatarDragCoords(null);\n        setSnapPoint(null);\n        if (rafId !== null) {\n          cancelAnimationFrame(rafId);\n          rafId = null;\n        }\n        window.removeEventListener(\"pointermove\", handlePointerMove);\n        window.removeEventListener(\"pointerup\", handlePointerUp);\n      };\n\n      window.addEventListener(\"pointermove\", handlePointerMove);\n      window.addEventListener(\"pointerup\", handlePointerUp);\n    },\n    [avatarPosition, onAvatarPositionChange, screenToCanvas, canvasSize, checkSnap],\n  );\n\n  const handleAvatarResizeStart = useCallback(\n    (\n      event: React.PointerEvent<HTMLDivElement>,\n      corner: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\",\n    ) => {\n      event.preventDefault();\n      event.stopPropagation();\n      const canvas = canvasRef.current;\n      if (!canvas) return;\n\n      const startX = event.clientX;\n      const startY = event.clientY;\n      const initialWidth = avatarSize.width;\n      // Высота вычисляется автоматически на основе ширины и пропорций изображения\n      const initialHeight = avatarImageAspectRatio \n        ? initialWidth / avatarImageAspectRatio \n        : avatarSize.height;\n      const initialX = avatarPosition.x;\n      const initialY = avatarPosition.y;\n\n      // Вычисляем начальную позицию угла в пикселях канвы\n      const centerX = initialX;\n      const centerY = initialY;\n      const halfWidth = initialWidth / 2;\n      const halfHeight = initialHeight / 2;\n      \n      let initialCornerX: number, initialCornerY: number;\n      if (corner === \"top-left\") {\n        initialCornerX = centerX - halfWidth;\n        initialCornerY = centerY - halfHeight;\n      } else if (corner === \"top-right\") {\n        initialCornerX = centerX + halfWidth;\n        initialCornerY = centerY - halfHeight;\n      } else if (corner === \"bottom-left\") {\n        initialCornerX = centerX - halfWidth;\n        initialCornerY = centerY + halfHeight;\n      } else {\n        // bottom-right\n        initialCornerX = centerX + halfWidth;\n        initialCornerY = centerY + halfHeight;\n      }\n\n      // Начальное расстояние от центра до угла (для расчета масштаба)\n      const initialDistance = Math.sqrt(\n        Math.pow(initialCornerX - centerX, 2) + Math.pow(initialCornerY - centerY, 2),\n      );\n\n      let rafId: number | null = null;\n\n      const handlePointerMove = (moveEvent: PointerEvent) => {\n        if (rafId !== null) {\n          cancelAnimationFrame(rafId);\n        }\n\n        rafId = requestAnimationFrame(() => {\n          const deltaXScreen = moveEvent.clientX - startX;\n          const deltaYScreen = moveEvent.clientY - startY;\n\n          // Конвертируем смещение экрана в пиксели канвы\n          const deltaX = screenToCanvas(deltaXScreen, \"width\");\n          const deltaY = screenToCanvas(deltaYScreen, \"height\");\n\n          // Вычисляем новую позицию угла в пикселях канвы\n          const newCornerX = initialCornerX + deltaX;\n          const newCornerY = initialCornerY + deltaY;\n\n          // Вычисляем новое расстояние от центра до угла\n          const newDistance = Math.sqrt(\n            Math.pow(newCornerX - centerX, 2) + Math.pow(newCornerY - centerY, 2),\n          );\n\n          // Масштабируем на основе изменения расстояния\n          const scale = newDistance / initialDistance;\n          \n          // Вычисляем новую ширину\n          let newWidth = initialWidth * scale;\n          \n          // Вычисляем высоту автоматически на основе ширины и пропорций изображения\n          let newHeight = avatarImageAspectRatio \n            ? newWidth / avatarImageAspectRatio \n            : initialHeight * scale;\n\n          // Ограничиваем минимальный и максимальный размер в пикселях\n          const minSizePx = Math.min(canvasSize.width, canvasSize.height) * 0.05; // минимум 5% от меньшей стороны\n          const maxSizePx = Math.min(canvasSize.width, canvasSize.height) * 0.95; // максимум 95% от меньшей стороны\n          \n          // Ограничиваем ширину\n          if (newWidth > maxSizePx) {\n            newWidth = maxSizePx;\n            newHeight = avatarImageAspectRatio ? newWidth / avatarImageAspectRatio : newHeight;\n          }\n          if (newWidth < minSizePx) {\n            newWidth = minSizePx;\n            newHeight = avatarImageAspectRatio ? newWidth / avatarImageAspectRatio : newHeight;\n          }\n          \n          // Ограничиваем высоту (если она слишком большая)\n          if (newHeight > maxSizePx) {\n            newHeight = maxSizePx;\n            newWidth = avatarImageAspectRatio ? newHeight * avatarImageAspectRatio : newWidth;\n          }\n          if (newHeight < minSizePx) {\n            newHeight = minSizePx;\n            newWidth = avatarImageAspectRatio ? newHeight * avatarImageAspectRatio : newWidth;\n          }\n\n          onAvatarSizeChange({ width: newWidth, height: newHeight });\n          rafId = null;\n        });\n      };\n\n      const handlePointerUp = () => {\n        if (rafId !== null) {\n          cancelAnimationFrame(rafId);\n          rafId = null;\n        }\n        window.removeEventListener(\"pointermove\", handlePointerMove);\n        window.removeEventListener(\"pointerup\", handlePointerUp);\n      };\n\n      window.addEventListener(\"pointermove\", handlePointerMove);\n      window.addEventListener(\"pointerup\", handlePointerUp);\n    },\n    [avatarPosition, avatarSize, onAvatarSizeChange, screenToCanvas, canvasSize, avatarImageAspectRatio],\n  );\n\n  return (\n    <div className=\"flex h-full flex-col rounded-3xl border border-gray-100 bg-white p-4 shadow-sm ring-1 ring-black/5\">\n      <div className=\"mb-3 flex flex-shrink-0 items-center justify-between\">\n        <div>\n          <p className=\"text-sm font-semibold text-gray-900\">Редактор</p>\n          <p className=\"text-xs text-gray-500\">\n            Соотношение сторон {aspectRatio}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <>\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              accept=\"image/*\"\n              multiple\n              className=\"hidden\"\n              onChange={(e) => {\n                const files = e.target.files;\n                if (files && files.length > 0) {\n                  Array.from(files).forEach((file) => {\n                    const imageUrl = URL.createObjectURL(file);\n                    const fileName = file.name;\n                    onAddMediaAsset(imageUrl, fileName);\n                  });\n                }\n                // Сброс input для возможности повторной загрузки того же файла\n                if (e.target) {\n                  e.target.value = \"\";\n                }\n              }}\n            />\n            <div className=\"relative\">\n              <button\n                ref={mediaButtonRef}\n                type=\"button\"\n                onClick={() => {\n                  if (mediaCloseTimeoutRef.current) {\n                    clearTimeout(mediaCloseTimeoutRef.current);\n                    mediaCloseTimeoutRef.current = null;\n                  }\n                  setIsMediaPanelOpen(!isMediaPanelOpen);\n                }}\n                onMouseEnter={handleMediaMouseEnter}\n                onMouseLeave={handleMediaMouseLeave}\n                className=\"flex h-9 min-w-[100px] items-center justify-center gap-2 rounded-2xl border border-gray-200 px-4 text-xs font-semibold text-gray-900 transition hover:bg-gray-50\"\n              >\n                <span className=\"text-base leading-none\">＋</span> Медиа\n              </button>\n              {isMediaPanelOpen && (\n                <div\n                  ref={mediaPanelRef}\n                  onMouseEnter={handleMediaMouseEnter}\n                  onMouseLeave={handleMediaMouseLeave}\n                  className=\"absolute right-0 top-full z-50 mt-2 w-[416px] rounded-xl border border-gray-200 bg-white shadow-lg\"\n                >\n                  <div className=\"p-4\">\n                    <div className=\"mb-4\">\n                      <h2 className=\"text-lg font-semibold text-gray-900\">Медиа</h2>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          fileInputRef.current?.click();\n                          setIsMediaPanelOpen(false);\n                        }}\n                        className=\"flex w-full items-center gap-3 rounded-xl border-2 border-dashed border-gray-300 p-3 transition hover:border-gray-400 hover:bg-gray-50\"\n                      >\n                        <div className=\"flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg bg-gray-100\">\n                          <span className=\"text-xl\">＋</span>\n                        </div>\n                        <div className=\"flex-1 text-left\">\n                          <p className=\"text-sm font-medium text-gray-900\">Добавить медиа</p>\n                          <p className=\"text-xs text-gray-500\">Загрузить изображение</p>\n                        </div>\n                      </button>\n                      {mediaAssets.length === 0 ? (\n                        <p className=\"py-8 text-center text-sm text-gray-500\">\n                          Нет добавленных медиа\n                        </p>\n                      ) : (\n                        <div className=\"max-h-[420px] overflow-y-auto space-y-2 pr-1 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 [&::-webkit-scrollbar-thumb]:rounded-full\">\n                          {mediaAssets.map((asset, index) => {\n                            const usageCount = mediaUsageOnScene[asset.id] ?? 0;\n                            return (\n                              <div\n                                key={asset.id}\n                                draggable\n                                onDragStart={(e) => {\n                                  setDraggedMediaAssetId(asset.id);\n                                  e.dataTransfer.effectAllowed = \"copy\";\n                                  e.dataTransfer.setData(\"text/plain\", asset.id);\n                                }}\n                                onDragEnd={() => {\n                                  setDraggedMediaAssetId(null);\n                                  setIsDraggingOverCanvas(false);\n                                }}\n                                className=\"flex items-center gap-3 rounded-xl border-2 border-gray-200 p-3 transition hover:border-gray-300 cursor-move\"\n                              >\n                                <div className=\"flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg bg-gray-100 text-xs font-semibold text-gray-600\">\n                                  {index + 1}\n                                </div>\n                                <div className=\"relative h-10 w-10 flex-shrink-0 overflow-hidden rounded-lg bg-gray-100\">\n                                  {asset.imageUrl ? (\n                                    <img\n                                      src={asset.imageUrl}\n                                      alt={asset.label}\n                                      className=\"h-full w-full object-cover\"\n                                    />\n                                  ) : (\n                                    <div className=\"flex h-full w-full items-center justify-center text-xs text-gray-500\">\n                                      📄\n                                    </div>\n                                  )}\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <p className=\"text-sm font-medium text-gray-900 truncate\">{asset.label}</p>\n                                  {usageCount > 0 ? (\n                                    <p className=\"text-xs text-gray-500\">\n                                      На слайде: {usageCount}\n                                    </p>\n                                  ) : (\n                                    <p className=\"text-xs text-gray-500\">Не используется</p>\n                                  )}\n                                </div>\n                                <div className=\"flex flex-col gap-1\">\n                                  <button\n                                    type=\"button\"\n                                    draggable={false}\n                                    onDragStart={(e) => e.stopPropagation()}\n                                    onClick={() => {\n                                      onUseMediaAsset(asset.id);\n                                      setIsMediaPanelOpen(false);\n                                    }}\n                                    className=\"rounded-lg px-3 py-1.5 text-xs font-medium text-gray-900 border border-gray-200 hover:bg-gray-50 transition\"\n                                  >\n                                    На слайд\n                                  </button>\n                                  <button\n                                    type=\"button\"\n                                    draggable={false}\n                                    onDragStart={(e) => e.stopPropagation()}\n                                    onClick={() => {\n                                      onRemoveMediaAsset(asset.id);\n                                    }}\n                                    className=\"rounded-lg px-3 py-1.5 text-xs font-medium text-red-600 transition hover:bg-red-50\"\n                                    aria-label=\"Удалить медиа из библиотеки\"\n                                  >\n                                    Удалить\n                                  </button>\n                                </div>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          </>\n          <div className=\"flex items-center gap-2\">\n          <div className=\"relative\">\n            <button\n              ref={layersButtonRef}\n              type=\"button\"\n              onClick={() => {\n                if (layersCloseTimeoutRef.current) {\n                  clearTimeout(layersCloseTimeoutRef.current);\n                  layersCloseTimeoutRef.current = null;\n                }\n                setIsLayersPanelOpen(!isLayersPanelOpen);\n              }}\n              onMouseEnter={handleLayersMouseEnter}\n              onMouseLeave={handleLayersMouseLeave}\n              className=\"flex h-9 min-w-[100px] items-center justify-center gap-2 rounded-2xl border border-gray-200 px-4 text-xs font-semibold text-gray-900 transition hover:bg-gray-50\"\n            >\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              strokeWidth={2}\n              className=\"h-4 w-4 flex-shrink-0\"\n            >\n              <path d=\"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5\" />\n            </svg>\n            Слои\n          </button>\n          {isLayersPanelOpen && (\n            <div\n              onMouseEnter={handleLayersMouseEnter}\n              onMouseLeave={handleLayersMouseLeave}\n            >\n              <LayersPanel\n                isOpen={isLayersPanelOpen}\n                onClose={() => setIsLayersPanelOpen(false)}\n                elements={elements}\n                avatar={avatar}\n                avatarZIndex={avatarZIndex}\n                avatarLocked={avatarLocked}\n                onReorderLayers={onReorderLayers}\n                onToggleAvatarLock={onToggleAvatarLock}\n                panelRef={layersPanelRef}\n              />\n            </div>\n              )}\n            </div>\n            {onAlignAvatars && (\n              <button\n                type=\"button\"\n                onClick={onAlignAvatars}\n                className=\"flex h-9 items-center justify-center gap-1.5 rounded-2xl border border-gray-200 px-4 text-xs font-semibold text-gray-900 transition hover:bg-gray-50\"\n                title=\"Выровнять аватар по первому слайду\"\n              >\n                <svg\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  viewBox=\"0 0 24 24\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  strokeWidth={2}\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  className=\"h-4 w-4\"\n                >\n                  <path d=\"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3\" />\n                </svg>\n                Выровнять аватар\n              </button>\n          )}\n        </div>\n        </div>\n      </div>\n\n      <div className=\"relative flex-1 min-h-0 overflow-hidden\">\n        <div className=\"flex h-full w-full items-center justify-center p-2\">\n          <div\n            ref={canvasRef}\n            onDragOver={(e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              if (draggedMediaAssetId) {\n                setIsDraggingOverCanvas(true);\n                e.dataTransfer.dropEffect = \"copy\";\n              }\n            }}\n            onDragLeave={(e) => {\n              // Проверяем, что мы действительно покинули канву, а не перешли на дочерний элемент\n              const rect = canvasRef.current?.getBoundingClientRect();\n              if (rect) {\n                const x = e.clientX;\n                const y = e.clientY;\n                if (\n                  x < rect.left ||\n                  x > rect.right ||\n                  y < rect.top ||\n                  y > rect.bottom\n                ) {\n                  setIsDraggingOverCanvas(false);\n                }\n              }\n            }}\n            onDrop={(e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              setIsDraggingOverCanvas(false);\n              \n              if (!draggedMediaAssetId || !onUseMediaAssetAtPosition) return;\n              \n              const canvas = canvasRef.current;\n              if (!canvas) return;\n              \n              const rect = canvas.getBoundingClientRect();\n              const x = e.clientX - rect.left;\n              const y = e.clientY - rect.top;\n              \n              // Конвертируем координаты экрана в координаты канвы\n              const canvasX = screenToCanvas(x, \"width\");\n              const canvasY = screenToCanvas(y, \"height\");\n              \n              onUseMediaAssetAtPosition(draggedMediaAssetId, canvasX, canvasY);\n              setDraggedMediaAssetId(null);\n            }}\n            className={`relative overflow-visible rounded-2xl bg-gray-50 border-2 border-dashed transition ${\n              isDraggingOverCanvas ? \"border-blue-400 bg-blue-50\" : \"border-gray-300\"\n            }`}\n            style={{ \n              aspectRatio: aspectRatio === \"16:9\" ? \"16 / 9\" : \"9 / 16\",\n              width: aspectRatio === \"16:9\" ? \"100%\" : \"auto\",\n              height: aspectRatio === \"9:16\" ? \"100%\" : \"auto\",\n              maxWidth: \"100%\",\n              maxHeight: \"100%\",\n            }}\n          >\n            {/* Направляющие линии при привязке */}\n            {snapPoint && (\n              <>\n                {/* Вертикальная линия - показываем только если есть привязка по X */}\n                {snapPoint.x !== null && (\n                  <div\n                    className=\"absolute z-40 pointer-events-none\"\n                    style={{\n                      left: `${(snapPoint.x / canvasSize.width) * 100}%`,\n                      top: 0,\n                      width: '1px',\n                      height: '100%',\n                      backgroundColor: '#3b82f6',\n                      opacity: 0.5,\n                    }}\n                  />\n                )}\n                {/* Горизонтальная линия - показываем только если есть привязка по Y */}\n                {snapPoint.y !== null && (\n                  <div\n                    className=\"absolute z-40 pointer-events-none\"\n                    style={{\n                      left: 0,\n                      top: `${(snapPoint.y / canvasSize.height) * 100}%`,\n                      width: '100%',\n                      height: '1px',\n                      backgroundColor: '#3b82f6',\n                      opacity: 0.5,\n                    }}\n                  />\n                )}\n              </>\n            )}\n\n            {/* Отображение координат при перетаскивании элемента */}\n            {draggingElementId && dragCoords && (\n              <div\n                className=\"absolute z-50 rounded-lg bg-black/80 px-3 py-1.5 text-xs font-mono text-white pointer-events-none whitespace-nowrap\"\n                style={{\n                  left: `${(dragCoords.x / canvasSize.width) * 100}%`,\n                  top: `${(dragCoords.y / canvasSize.height) * 100}%`,\n                  transform: \"translate(-50%, calc(50% + 30px))\",\n                }}\n              >\n                X: {dragCoords.x} Y: {dragCoords.y}\n              </div>\n            )}\n            \n            {/* Отображение координат при перетаскивании аватара */}\n            {draggingAvatar && avatarDragCoords && (\n              <div\n                className=\"absolute z-50 rounded-lg bg-black/80 px-3 py-1.5 text-xs font-mono text-white pointer-events-none whitespace-nowrap\"\n                style={{\n                  left: `${(avatarDragCoords.x / canvasSize.width) * 100}%`,\n                  top: `${(avatarDragCoords.y / canvasSize.height) * 100}%`,\n                  transform: \"translate(-50%, calc(50% + 30px))\",\n                }}\n              >\n                X: {avatarDragCoords.x} Y: {avatarDragCoords.y}\n              </div>\n            )}\n            {/* Отображаем все элементы отсортированные по zIndex (меньший zIndex = ниже, больший = выше) */}\n            {[\n              ...elements.map((el) => ({ type: \"element\" as const, data: el, zIndex: el.zIndex ?? 0 })),\n              ...(avatar ? [{ type: \"avatar\" as const, data: avatar, zIndex: avatarZIndex ?? 9999 }] : []),\n            ]\n              .sort((a, b) => a.zIndex - b.zIndex)\n              .map((item) => {\n                if (item.type === \"avatar\") {\n                  return (\n                    <AvatarCanvas\n                      key=\"avatar\"\n                      avatar={item.data}\n                      position={avatarPosition}\n                      size={avatarSize}\n                      canvasSize={canvasSize}\n                      onRemove={onRemoveAvatar}\n                      onPointerDown={handleAvatarPointerDown}\n                      onResizeStart={handleAvatarResizeStart}\n                    />\n                  );\n                }\n\n                const element = item.data;\n                if (element.imageUrl) {\n                  return (\n                    <MediaCanvasWrapper\n                      key={element.id}\n                      element={element}\n                      canvasSize={canvasSize}\n                      onRemove={() => onRemoveElement(element.id)}\n                      onPointerDown={(event) => handlePointerDown(event, element)}\n                      onResizeStart={() => {}}\n                      screenToCanvas={screenToCanvas}\n                      onElementSizeChange={onElementSizeChange}\n                    />\n                  );\n                }\n\n                // Плейсхолдер для элементов без изображения\n                const leftPercent = (element.x / canvasSize.width) * 100;\n                const topPercent = (element.y / canvasSize.height) * 100;\n                const widthPercent = (element.width / canvasSize.width) * 100;\n                const heightPercent = (element.height / canvasSize.height) * 100;\n\n                return (\n                  <div\n                    key={element.id}\n                    role=\"button\"\n                    tabIndex={0}\n                    onPointerDown={(event) => handlePointerDown(event, element)}\n                    className=\"absolute cursor-grab rounded-2xl border-2 border-gray-300 bg-white text-center text-xs font-semibold text-gray-900 shadow-md transition hover:border-gray-900 active:cursor-grabbing overflow-hidden\"\n                    style={{\n                      left: `${leftPercent}%`,\n                      top: `${topPercent}%`,\n                      width: `${widthPercent}%`,\n                      height: `${heightPercent}%`,\n                      transform: \"translate(-50%, -50%)\",\n                      background: \"#f3f4f6\",\n                    }}\n                  >\n                    <div className=\"flex h-full w-full flex-col items-center justify-center px-2\">\n                      <span className=\"text-sm text-gray-900\">{element.label}</span>\n                      <span className=\"text-[10px] text-gray-500\">Медиа</span>\n                    </div>\n                  </div>\n                );\n              })}\n\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5199, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/components/MaterialEditor.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation\";\nimport { supabase } from \"@/lib/supabaseClient\";\nimport Image from \"next/image\";\n\nimport { EditorSidebar } from \"./EditorSidebar\";\nimport { Timeline } from \"./Timeline\";\nimport { CanvasArea } from \"./CanvasArea\";\nimport { CreateVideoTemp } from \"./servers/CreateVideoTemp\";\nimport type {\n  AspectRatio,\n  AvatarOption,\n  Scene,\n  VoiceOption,\n  CanvasElement,\n  MediaAsset,\n} from \"./types\";\n\nconst createScene = (index: number): Scene => ({\n  id: crypto.randomUUID(),\n  title: `Слайд ${index}`,\n  script: \"\",\n  avatarId: null,\n  voiceId: null,\n  elements: [],\n});\n\nexport function MaterialEditor() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const initialScenes = useMemo(() => [createScene(1)], []);\n  const [aspectRatio, setAspectRatio] = useState<AspectRatio>(\"16:9\");\n  const [videoTitle, setVideoTitle] = useState(\"Новое видео\");\n  const [scenes, setScenes] = useState<Scene[]>(initialScenes);\n  const [activeSceneId, setActiveSceneId] = useState<string>(\n    initialScenes[0].id,\n  );\n  const [avatars, setAvatars] = useState<AvatarOption[]>([]);\n  const [voices, setVoices] = useState<VoiceOption[]>([]);\n  const [mediaAssets, setMediaAssets] = useState<MediaAsset[]>([]);\n  const [isLoadingAvatars, setIsLoadingAvatars] = useState(true);\n  const [isLoadingVoices, setIsLoadingVoices] = useState(true);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [initialParamsApplied, setInitialParamsApplied] = useState(false);\n\n  // Функция для обновления списка аватаров\n  const refreshAvatars = async () => {\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return;\n\n    const { data, error } = await supabase\n      .from(\"photo_avatars\")\n      .select(\"*\")\n      .eq(\"uid\", user.id)\n      .eq(\"status\", \"done\")\n      .order(\"created_at\", { ascending: false });\n\n    if (error) {\n      console.error(\"[MaterialEditor] Ошибка загрузки аватаров:\", error);\n    } else {\n      setAvatars(\n        (data ?? []).map((avatar) => ({\n          id: avatar.id ?? \"\",\n          name: avatar.name,\n          photo: avatar.photo,\n          image_key: avatar.image_key,\n          hey_gen_id: avatar.hey_gen_id,\n          group_id: avatar.group_id,\n        })),\n      );\n    }\n  };\n\n  // Функция для обновления списка голосов\n  const refreshVoices = async () => {\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return;\n\n    const { data, error } = await supabase\n      .from(\"voices\")\n      .select(\"*\")\n      .eq(\"uid\", user.id)\n      .order(\"created_at\", { ascending: false });\n\n    if (error) {\n      console.error(\"[MaterialEditor] Ошибка загрузки голосов:\", error);\n    } else {\n      setVoices(\n        (data ?? [])\n          .filter((voice) => voice.url && voice.name)\n          .map((voice) => ({\n            id: voice.id ?? \"\",\n            name: voice.name,\n            url: voice.url,\n            description: voice.description,\n            voice_id: voice.voice_id ?? null,\n          })),\n      );\n    }\n  };\n\n  const activeScene = scenes.find((scene) => scene.id === activeSceneId);\n\n  useEffect(() => {\n    const fetchAvatars = async () => {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n\n      if (!user) return;\n\n      const { data, error } = await supabase\n        .from(\"photo_avatars\")\n        .select(\"*\")\n        .eq(\"uid\", user.id)\n        .eq(\"status\", \"done\")\n        .order(\"created_at\", { ascending: false });\n\n      if (error) {\n        console.error(\"[MaterialEditor] Ошибка загрузки аватаров:\", error);\n      } else {\n        setAvatars(\n          (data ?? []).map((avatar) => ({\n            id: avatar.id ?? \"\",\n            name: avatar.name,\n            photo: avatar.photo,\n            image_key: avatar.image_key,\n            hey_gen_id: avatar.hey_gen_id,\n            group_id: avatar.group_id,\n          })),\n        );\n      }\n      setIsLoadingAvatars(false);\n    };\n\n    fetchAvatars();\n  }, []);\n\n  useEffect(() => {\n    const fetchVoices = async () => {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n\n      if (!user) return;\n\n      const { data, error } = await supabase\n        .from(\"voices\")\n        .select(\"*\")\n        .eq(\"uid\", user.id)\n        .order(\"created_at\", { ascending: false });\n\n      if (error) {\n        console.error(\"[MaterialEditor] Ошибка загрузки голосов:\", error);\n      } else {\n        setVoices(\n          (data ?? [])\n            .filter((voice) => voice.url && voice.name)\n            .map((voice) => ({\n              id: voice.id ?? \"\",\n              name: voice.name,\n              url: voice.url,\n              description: voice.description,\n              voice_id: voice.voice_id ?? null,\n            })),\n        );\n      }\n      setIsLoadingVoices(false);\n    };\n\n    fetchVoices();\n  }, []);\n\n  // Применяем параметры из URL после загрузки аватаров и голосов\n  useEffect(() => {\n    if (\n      !isLoadingAvatars &&\n      !isLoadingVoices &&\n      !initialParamsApplied &&\n      avatars.length > 0 &&\n      voices.length > 0\n    ) {\n      const avatarId = searchParams.get(\"avatarId\");\n      const voiceId = searchParams.get(\"voiceId\");\n\n      if (avatarId || voiceId) {\n        setScenes((prev) => {\n          const firstScene = prev[0];\n          if (!firstScene) return prev;\n\n          const updatedScene: Scene = {\n            ...firstScene,\n            avatarId: avatarId && avatars.some((a) => a.id === avatarId) ? avatarId : firstScene.avatarId,\n            voiceId: voiceId && voices.some((v) => v.id === voiceId) ? voiceId : firstScene.voiceId,\n          };\n\n          return [updatedScene, ...prev.slice(1)];\n        });\n        setInitialParamsApplied(true);\n      } else {\n        setInitialParamsApplied(true);\n      }\n    }\n  }, [\n    isLoadingAvatars,\n    isLoadingVoices,\n    initialParamsApplied,\n    avatars,\n    voices,\n    searchParams,\n  ]);\n\n  const handleSceneUpdate = (sceneId: string, updater: (scene: Scene) => Scene) =>\n    setScenes((prev) =>\n      prev.map((scene) => (scene.id === sceneId ? updater(scene) : scene)),\n    );\n\n  // Константы размеров канвы в пикселях\n  const CANVAS_SIZES: Record<AspectRatio, { width: number; height: number }> = {\n    \"16:9\": { width: 1920, height: 1080 },\n    \"9:16\": { width: 1080, height: 1920 },\n  };\n\n  // Рассчитывает начальный размер аватара в пикселях (35% от высоты канвы)\n  const getInitialAvatarSize = (ratio: AspectRatio): { width: number; height: number } => {\n    const canvasSize = CANVAS_SIZES[ratio];\n    \n    // Высота аватара = 35% от высоты канвы в пикселях\n    const avatarHeightPercent = 0.35;\n    const height = canvasSize.height * avatarHeightPercent;\n    \n    // Типичное соотношение сторон аватара (ширина к высоте)\n    const avatarAspectRatio = 3 / 4;\n    \n    // Ширина рассчитывается на основе соотношения сторон аватара\n    const width = height * avatarAspectRatio;\n    \n    return { width, height };\n  };\n\n  // Конвертирует координаты из одного соотношения сторон в другое\n  const convertCoordinates = (\n    coords: { x: number; y: number },\n    fromRatio: AspectRatio,\n    toRatio: AspectRatio,\n  ): { x: number; y: number } => {\n    if (fromRatio === toRatio) return coords;\n\n    const fromSize = CANVAS_SIZES[fromRatio];\n    const toSize = CANVAS_SIZES[toRatio];\n\n    // Конвертируем в проценты относительно исходной канвы\n    const xPercent = coords.x / fromSize.width;\n    const yPercent = coords.y / fromSize.height;\n\n    // Применяем проценты к новой канве\n    return {\n      x: xPercent * toSize.width,\n      y: yPercent * toSize.height,\n    };\n  };\n\n  // Конвертирует размеры из одного соотношения сторон в другое\n  const convertSize = (\n    size: { width: number; height: number },\n    fromRatio: AspectRatio,\n    toRatio: AspectRatio,\n  ): { width: number; height: number } => {\n    if (fromRatio === toRatio) return size;\n\n    const fromSize = CANVAS_SIZES[fromRatio];\n    const toSize = CANVAS_SIZES[toRatio];\n\n    // Конвертируем в проценты относительно исходной канвы\n    const widthPercent = size.width / fromSize.width;\n    const heightPercent = size.height / fromSize.height;\n\n    // Применяем проценты к новой канве\n    return {\n      width: widthPercent * toSize.width,\n      height: heightPercent * toSize.height,\n    };\n  };\n\n  const handleAddScene = (afterSceneId?: string) => {\n    const newSceneId = crypto.randomUUID();\n    setScenes((prev) => {\n      const newIndex = afterSceneId\n        ? prev.findIndex((s) => s.id === afterSceneId) + 1\n        : prev.length;\n      // Берем данные из активного слайда для копирования настроек (кроме текста)\n      const activeScene = prev.find((s) => s.id === activeSceneId);\n      const previousScene = afterSceneId\n        ? prev.find((s) => s.id === afterSceneId)\n        : prev[prev.length - 1];\n      \n      const newScene: Scene = {\n        id: newSceneId,\n        title: `Слайд ${newIndex + 1}`,\n        script: \"\", // Текст не переносится в новый слайд\n        avatarId: activeScene?.avatarId ?? previousScene?.avatarId ?? null,\n        voiceId: activeScene?.voiceId ?? previousScene?.voiceId ?? null,\n        elements: [], // Медиа не переносится в новый слайд, только аватар\n        avatarPosition: activeScene?.avatarPosition ?? previousScene?.avatarPosition,\n        avatarSize: activeScene?.avatarSize ?? previousScene?.avatarSize,\n        avatarZIndex: activeScene?.avatarZIndex ?? previousScene?.avatarZIndex,\n      };\n      \n      if (afterSceneId) {\n        const index = prev.findIndex((s) => s.id === afterSceneId);\n        const updated = [...prev];\n        updated.splice(index + 1, 0, newScene);\n        return updated.map((scene, idx) => ({\n          ...scene,\n          title: `Слайд ${idx + 1}`,\n        }));\n      }\n      \n      return [...prev, newScene].map((scene, idx) => ({\n        ...scene,\n        title: `Слайд ${idx + 1}`,\n      }));\n    });\n    \n    setActiveSceneId(newSceneId);\n  };\n\n  const handleDeleteScene = (sceneId: string) => {\n    setScenes((prev) => {\n      const filtered = prev.filter((scene) => scene.id !== sceneId);\n      if (filtered.length === 0) {\n        const newScene = createScene(1);\n        setActiveSceneId(newScene.id);\n        return [newScene];\n      }\n      if (activeSceneId === sceneId) {\n        const currentIndex = prev.findIndex((scene) => scene.id === sceneId);\n        const newActiveIndex = Math.max(0, currentIndex - 1);\n        setActiveSceneId(filtered[newActiveIndex]?.id ?? filtered[0].id);\n      }\n      return filtered.map((scene, index) => ({\n        ...scene,\n        title: `Слайд ${index + 1}`,\n      }));\n    });\n  };\n\n  const handleScriptChange = (value: string) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({ ...scene, script: value }));\n  };\n\n  const handleVoiceChange = (voiceId: string | null) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({ ...scene, voiceId }));\n  };\n\n  const handleAvatarChange = (avatarId: string | null) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => {\n      if (avatarId && !scene.avatarPosition) {\n        // При первом добавлении аватара устанавливаем начальную позицию и размер\n        const initialSize = getInitialAvatarSize(aspectRatio);\n        const canvasSize = CANVAS_SIZES[aspectRatio];\n        // Аватар по умолчанию имеет большой zIndex (выше всех элементов)\n        const maxZIndex = Math.max(...scene.elements.map((el) => el.zIndex ?? 0), 0);\n        return {\n          ...scene,\n          avatarId,\n          avatarPosition: { x: canvasSize.width / 2, y: canvasSize.height / 2 }, // центр канвы\n          avatarSize: initialSize,\n          avatarZIndex: maxZIndex + 1,\n        };\n      }\n      return { ...scene, avatarId };\n    });\n  };\n\n  const handleRemoveAvatar = () => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({\n      ...scene,\n      avatarId: null,\n      avatarPosition: undefined,\n      avatarSize: undefined,\n    }));\n  };\n\n  const handleAvatarPositionChange = (coords: { x: number; y: number }) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({\n      ...scene,\n      avatarPosition: coords,\n    }));\n  };\n\n  const handleAvatarSizeChange = (size: { width: number; height: number }) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({\n      ...scene,\n      avatarSize: size,\n    }));\n  };\n\n  const addAssetToScene = (sceneId: string, asset: MediaAsset) => {\n    const canvasSize = CANVAS_SIZES[aspectRatio];\n    handleSceneUpdate(sceneId, (scene) => {\n      const mediaIndex = scene.elements.filter((element) => element.type === \"media\").length + 1;\n      const elementWidth = canvasSize.width * 0.28;\n      const elementHeight = canvasSize.height * 0.34;\n      const maxElementZIndex = scene.elements.reduce((max, el) => Math.max(max, el.zIndex ?? 0), 0);\n      const maxZIndex = Math.max(maxElementZIndex, scene.avatarZIndex ?? 0);\n\n      const newElement: CanvasElement = {\n        id: `media-${scene.id}-${mediaIndex}-${Date.now()}`,\n        type: \"media\",\n        label: asset.label,\n        color: \"#1fb6ff\",\n        width: elementWidth,\n        height: elementHeight,\n        x: canvasSize.width / 2,\n        y: canvasSize.height / 2,\n        imageUrl: asset.imageUrl,\n        assetId: asset.id,\n        zIndex: maxZIndex + 1,\n      };\n\n      return {\n        ...scene,\n        elements: [...scene.elements, newElement],\n      };\n    });\n  };\n\n  const handleAddMediaAsset = (imageUrl?: string, fileName?: string) => {\n    if (!activeScene) return;\n    if (!imageUrl) return;\n\n    const newAsset: MediaAsset = {\n      id: `asset-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,\n      label: fileName || `Медиа ${mediaAssets.length + 1}`,\n      imageUrl,\n      createdAt: Date.now(),\n    };\n\n    setMediaAssets((prev) => [...prev, newAsset]);\n    addAssetToScene(activeScene.id, newAsset);\n  };\n\n  const handleAddExistingAssetToScene = (assetId: string) => {\n    if (!activeScene) return;\n    const asset = mediaAssets.find((item) => item.id === assetId);\n    if (!asset) return;\n    addAssetToScene(activeScene.id, asset);\n  };\n\n  const addAssetToSceneAtPosition = (sceneId: string, asset: MediaAsset, x: number, y: number) => {\n    const canvasSize = CANVAS_SIZES[aspectRatio];\n    handleSceneUpdate(sceneId, (scene) => {\n      const mediaIndex = scene.elements.filter((element) => element.type === \"media\").length + 1;\n      const elementWidth = canvasSize.width * 0.28;\n      const elementHeight = canvasSize.height * 0.34;\n      const maxElementZIndex = scene.elements.reduce((max, el) => Math.max(max, el.zIndex ?? 0), 0);\n      const maxZIndex = Math.max(maxElementZIndex, scene.avatarZIndex ?? 0);\n\n      const newElement: CanvasElement = {\n        id: `media-${scene.id}-${mediaIndex}-${Date.now()}`,\n        type: \"media\",\n        label: asset.label,\n        color: \"#1fb6ff\",\n        width: elementWidth,\n        height: elementHeight,\n        x: Math.max(0, Math.min(canvasSize.width, x)),\n        y: Math.max(0, Math.min(canvasSize.height, y)),\n        imageUrl: asset.imageUrl,\n        assetId: asset.id,\n        zIndex: maxZIndex + 1,\n      };\n\n      return {\n        ...scene,\n        elements: [...scene.elements, newElement],\n      };\n    });\n  };\n\n  const handleRemoveMediaAsset = (assetId: string) => {\n    setMediaAssets((prev) => {\n      const assetToRemove = prev.find((asset) => asset.id === assetId);\n      if (assetToRemove?.imageUrl?.startsWith(\"blob:\")) {\n        URL.revokeObjectURL(assetToRemove.imageUrl);\n      }\n      return prev.filter((asset) => asset.id !== assetId);\n    });\n\n    setScenes((prevScenes) =>\n      prevScenes.map((scene) => ({\n        ...scene,\n        elements: scene.elements.filter((element) => element.assetId !== assetId),\n      })),\n    );\n  };\n\n  const handleElementPositionChange = (elementId: string, coords: { x: number; y: number }) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({\n      ...scene,\n      elements: scene.elements.map((element) =>\n        element.id === elementId ? { ...element, ...coords } : element,\n      ),\n    }));\n  };\n\n  const handleElementSizeChange = (elementId: string, size: { width: number; height: number }) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({\n      ...scene,\n      elements: scene.elements.map((element) =>\n        element.id === elementId ? { ...element, ...size } : element,\n      ),\n    }));\n  };\n\n  const handleRemoveElement = (elementId: string) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({\n      ...scene,\n      elements: scene.elements.filter((element) => element.id !== elementId),\n    }));\n  };\n\n  const handleReorderLayers = (newOrder: string[]) => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => {\n      // Первый в списке (index 0) = больший zIndex = выше на канве\n      // Обновляем zIndex для всех элементов и аватара\n      const updatedElements = scene.elements.map((element) => {\n        const index = newOrder.indexOf(element.id);\n        // Первый элемент (index 0) получает zIndex = newOrder.length, последний получает 1\n        const zIndex = index !== -1 ? newOrder.length - index : element.zIndex ?? 0;\n        return {\n          ...element,\n          zIndex,\n        };\n      });\n      \n      // Обновляем zIndex для аватара\n      const avatarIndex = newOrder.indexOf(\"avatar\");\n      const avatarZIndex = avatarIndex !== -1 ? newOrder.length - avatarIndex : scene.avatarZIndex ?? 9999;\n      \n      return {\n        ...scene,\n        elements: updatedElements,\n        avatarZIndex,\n      };\n    });\n  };\n\n  const handleToggleAvatarLock = () => {\n    if (!activeScene) return;\n    handleSceneUpdate(activeScene.id, (scene) => ({\n      ...scene,\n      avatarLocked: !scene.avatarLocked,\n    }));\n  };\n\n  // Функция для выравнивания аватаров по первому слайду\n  const handleAlignAvatars = () => {\n    if (scenes.length === 0) return;\n    \n    const firstScene = scenes[0];\n    if (!firstScene.avatarId || !firstScene.avatarPosition || !firstScene.avatarSize) {\n      alert(\"В первом слайде должен быть аватар с заданными позицией и размером\");\n      return;\n    }\n\n    const referencePosition = firstScene.avatarPosition;\n    const referenceSize = firstScene.avatarSize;\n\n    // Применяем координаты и размер из первого слайда ко всем остальным\n    setScenes((prev) =>\n      prev.map((scene, index) => {\n        if (index === 0) return scene; // Первый слайд не трогаем\n        if (!scene.avatarId) return scene; // Пропускаем слайды без аватара\n        \n        return {\n          ...scene,\n          avatarPosition: referencePosition,\n          avatarSize: referenceSize,\n        };\n      }),\n    );\n  };\n\n  // Функция для получения оригинальных размеров изображения\n  const getImageDimensions = (imageUrl: string): Promise<{ width: number; height: number }> => {\n    return new Promise((resolve, reject) => {\n      // Используем window.Image чтобы избежать конфликта с импортом Image из Next.js\n      const img = document.createElement(\"img\");\n      \n      // Устанавливаем таймаут для загрузки\n      const timeout = setTimeout(() => {\n        img.onload = null;\n        img.onerror = null;\n        reject(new Error(`Таймаут загрузки изображения: ${imageUrl}`));\n      }, 15000); // 15 секунд таймаут\n      \n      img.onload = () => {\n        clearTimeout(timeout);\n        const width = img.naturalWidth || img.width;\n        const height = img.naturalHeight || img.height;\n        \n        if (width > 0 && height > 0) {\n          console.log(`Размеры изображения получены: ${imageUrl} - ${width}x${height}`);\n          resolve({ width, height });\n        } else {\n          reject(new Error(`Неверные размеры изображения: ${imageUrl}`));\n        }\n      };\n      \n      img.onerror = (error) => {\n        clearTimeout(timeout);\n        console.error(`Ошибка загрузки изображения: ${imageUrl}`, error);\n        reject(new Error(`Не удалось загрузить изображение: ${imageUrl}`));\n      };\n      \n      // Устанавливаем src после настройки обработчиков\n      img.src = imageUrl;\n    });\n  };\n\n  // Функция для подготовки данных слайда для вебхука\n  const prepareSlideData = async (scene: Scene, slideNumber: number) => {\n    const canvasSize = CANVAS_SIZES[aspectRatio];\n    const slideData: any = {\n      slide_number: slideNumber,\n      canvas_size: {\n        width: canvasSize.width,\n        height: canvasSize.height,\n      },\n      aspect_ratio: aspectRatio,\n      script: scene.script,\n      voice_id: scene.voiceId ? voices.find((v) => v.id === scene.voiceId)?.voice_id ?? null : null,\n      elements: [],\n    };\n\n    // Обрабатываем аватар\n    if (scene.avatarId && scene.avatarPosition && scene.avatarSize) {\n      const avatar = avatars.find((a) => a.id === scene.avatarId);\n      if (avatar && avatar.photo) {\n        console.log(`Загрузка размеров аватара для слайда ${slideNumber}: ${avatar.photo}`);\n        try {\n          const originalDimensions = await getImageDimensions(avatar.photo);\n          console.log(`Размеры аватара получены для слайда ${slideNumber}:`, originalDimensions);\n          slideData.elements.push({\n            type: \"avatar\",\n            id: scene.avatarId,\n            position: {\n              x: scene.avatarPosition.x,\n              y: scene.avatarPosition.y,\n            },\n            original_resolution: {\n              width: originalDimensions.width,\n              height: originalDimensions.height,\n            },\n            canvas_resolution: {\n              width: scene.avatarSize.width,\n              height: scene.avatarSize.height,\n            },\n            z_index: scene.avatarZIndex ?? 0,\n            image_url: avatar.photo,\n            hey_gen_id: avatar.hey_gen_id,\n          });\n        } catch (error) {\n          console.error(`Ошибка при получении размеров аватара для слайда ${slideNumber}:`, error);\n          console.error(`URL аватара: ${avatar.photo}`);\n          // Добавляем аватар без оригинальных размеров\n          slideData.elements.push({\n            type: \"avatar\",\n            id: scene.avatarId,\n            position: {\n              x: scene.avatarPosition.x,\n              y: scene.avatarPosition.y,\n            },\n            original_resolution: null,\n            canvas_resolution: {\n              width: scene.avatarSize.width,\n              height: scene.avatarSize.height,\n            },\n            z_index: scene.avatarZIndex ?? 0,\n            image_url: avatar.photo,\n            hey_gen_id: avatar.hey_gen_id,\n          });\n        }\n      }\n    }\n\n    // Обрабатываем медиа элементы\n    for (const element of scene.elements) {\n      if (element.type === \"media\" && element.imageUrl) {\n        console.log(`Загрузка размеров медиа для слайда ${slideNumber}: ${element.imageUrl}`);\n        try {\n          const originalDimensions = await getImageDimensions(element.imageUrl);\n          console.log(`Размеры медиа получены для слайда ${slideNumber}:`, originalDimensions);\n          slideData.elements.push({\n            type: \"media\",\n            id: element.id,\n            label: element.label,\n            position: {\n              x: element.x,\n              y: element.y,\n            },\n            original_resolution: {\n              width: originalDimensions.width,\n              height: originalDimensions.height,\n            },\n            canvas_resolution: {\n              width: element.width,\n              height: element.height,\n            },\n            z_index: element.zIndex ?? 0,\n            image_url: element.imageUrl,\n            crop: element.crop || null,\n          });\n        } catch (error) {\n          console.error(`Ошибка при получении размеров медиа для слайда ${slideNumber}:`, error);\n          console.error(`URL медиа: ${element.imageUrl}`);\n          // Добавляем медиа без оригинальных размеров\n          slideData.elements.push({\n            type: \"media\",\n            id: element.id,\n            label: element.label,\n            position: {\n              x: element.x,\n              y: element.y,\n            },\n            original_resolution: null,\n            canvas_resolution: {\n              width: element.width,\n              height: element.height,\n            },\n            z_index: element.zIndex ?? 0,\n            image_url: element.imageUrl,\n            crop: element.crop || null,\n          });\n        }\n      }\n    }\n\n    // Сортируем элементы по z_index (от меньшего к большему для правильного порядка слоев)\n    slideData.elements.sort((a: any, b: any) => a.z_index - b.z_index);\n\n    return slideData;\n  };\n\n  // Функция для отправки вебхука с данными всех слайдов\n  const handleGenerate = async () => {\n    if (isGenerating) return;\n    \n    setIsGenerating(true);\n    try {\n      // Получаем UUID залогиненного пользователя\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n      const userUuid = user?.id;\n      if (!userUuid) {\n        alert(\"Не удалось определить пользователя, авторизуйтесь повторно.\");\n        setIsGenerating(false);\n        return;\n      }\n\n      const slidesData = [];\n      \n      // Подготавливаем данные для каждого слайда\n      for (let i = 0; i < scenes.length; i++) {\n        const scene = scenes[i];\n        const slideNumberMatch = scene.title.match(/\\d+/);\n        const slideNumber = slideNumberMatch ? parseInt(slideNumberMatch[0], 10) : i + 1;\n        \n        const slideData = await prepareSlideData(scene, slideNumber);\n        slidesData.push(slideData);\n      }\n\n      // Сохраняем данные в таблицу video_temp\n      const saveResult = await CreateVideoTemp(videoTitle, slidesData, userUuid);\n      if (!saveResult.success) {\n        console.error(\"[MaterialEditor] Ошибка при сохранении в video_temp:\", saveResult.error);\n        // Не прерываем процесс, просто логируем ошибку\n      } else {\n        console.log(\"[MaterialEditor] Данные успешно сохранены в video_temp, ID:\", saveResult.id);\n      }\n\n      // Отправляем вебхук\n      const response = await fetch(\"https://rueleven.ru/webhook-test/2c6c697f-78cd-4eb2-bf01-2f00827b965d\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          video_title: videoTitle,\n          aspect_ratio: aspectRatio,\n          slides: slidesData,\n          uuid: userUuid,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Ошибка HTTP: ${response.status}`);\n      }\n\n      console.log(\"Вебхук успешно отправлен:\", slidesData);\n      alert(\"Генерация начата! Данные отправлены на сервер.\");\n    } catch (error) {\n      console.error(\"Ошибка при отправке вебхука:\", error);\n      alert(\"Произошла ошибка при отправке данных. Проверьте консоль для подробностей.\");\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  // Проверяем, можно ли сгенерировать (для активного слайда)\n  const canGenerate = useMemo(() => {\n    if (!activeScene) return false;\n    // Проверяем, есть ли текст хотя бы на одном слайде\n    const hasTextOnAnySlide = scenes.some(scene => scene.script && scene.script.trim().length > 0);\n    return !!(\n      videoTitle.trim() &&\n      activeScene.avatarId &&\n      activeScene.voiceId &&\n      (activeScene.script.trim() || hasTextOnAnySlide)\n    );\n  }, [activeScene, videoTitle, scenes]);\n\n  return (\n    <section className=\"flex h-screen w-full flex-col gap-4 px-4 pb-6 pt-4 sm:px-6 lg:gap-6 lg:pb-8\">\n      <div className=\"flex items-center justify-between gap-4 pb-2\">\n        <button\n          type=\"button\"\n          onClick={async () => {\n            // Получаем UUID залогиненного пользователя\n            const {\n              data: { user },\n            } = await supabase.auth.getUser();\n            const userUuid = user?.id || null;\n\n            // Отправляем вебхук для каждого слайда перед переходом назад\n            for (let i = 0; i < scenes.length; i++) {\n              const scene = scenes[i];\n              if (!scene.voiceId) continue;\n\n              // Находим выбранный голос и получаем его voice_id из таблицы\n              const selectedVoice = voices.find((voice) => voice.id === scene.voiceId);\n              if (!selectedVoice || !selectedVoice.voice_id) continue;\n\n              // Извлекаем номер слайда из title (например, \"Слайд 1\" -> 1)\n              const slideNumberMatch = scene.title.match(/\\d+/);\n              const slideNumber = slideNumberMatch ? parseInt(slideNumberMatch[0], 10) : i + 1;\n\n              try {\n                await fetch(\"https://rueleven.ru/webhook/8c42bae1-807d-40fa-b795-42897b4ec5b2\", {\n                  method: \"POST\",\n                  headers: {\n                    \"Content-Type\": \"application/json\",\n                  },\n                  body: JSON.stringify({\n                    slide_number: slideNumber,\n                    voice_id: selectedVoice.voice_id,\n                    uuid: userUuid,\n                  }),\n                });\n                console.log(`Вебхук отправлен для слайда ${slideNumber}`);\n              } catch (error) {\n                console.error(`Ошибка при отправке вебхука для слайда ${slideNumber}:`, error);\n              }\n            }\n\n            router.push(\"/material\");\n          }}\n          className=\"flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-900 transition hover:bg-gray-50\"\n        >\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth={2}\n            className=\"h-5 w-5\"\n          >\n            <path d=\"M19 12H5M12 19l-7-7 7-7\" />\n          </svg>\n          Назад\n        </button>\n        <button\n          type=\"button\"\n          onClick={handleGenerate}\n          disabled={!canGenerate || isGenerating}\n          className={`flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold text-white transition ${\n            canGenerate && !isGenerating\n              ? \"bg-green-600 hover:bg-green-500\"\n              : \"bg-gray-300 cursor-not-allowed\"\n          }`}\n        >\n          {isGenerating ? (\n            <>\n              <svg\n                className=\"animate-spin h-5 w-5\"\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n              >\n                <circle\n                  className=\"opacity-25\"\n                  cx=\"12\"\n                  cy=\"12\"\n                  r=\"10\"\n                  stroke=\"currentColor\"\n                  strokeWidth=\"4\"\n                ></circle>\n                <path\n                  className=\"opacity-75\"\n                  fill=\"currentColor\"\n                  d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n                ></path>\n              </svg>\n              Генерация...\n            </>\n          ) : (\n            <>\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                strokeWidth={2}\n                className=\"h-5 w-5\"\n              >\n                <path d=\"M5 12h14M12 5l7 7-7 7\" />\n              </svg>\n              Сгенерировать\n            </>\n          )}\n        </button>\n      </div>\n      <div className=\"flex h-full min-h-0 flex-1 flex-col gap-4 lg:grid lg:grid-cols-[629px_minmax(0,1fr)] lg:items-stretch lg:gap-6\">\n        <div className=\"flex min-h-0 flex-1 flex-col lg:min-h-0 lg:h-full\">\n          <EditorSidebar\n            aspectRatio={aspectRatio}\n            onAspectRatioChange={(newRatio) => {\n              // Конвертируем координаты всех элементов и аватара при изменении соотношения сторон\n              const oldRatio = aspectRatio;\n              setScenes((prevScenes) =>\n                prevScenes.map((scene) => {\n                  const updatedScene = { ...scene };\n\n                  // Конвертируем позицию и размер аватара\n                  if (updatedScene.avatarPosition && updatedScene.avatarSize) {\n                    updatedScene.avatarPosition = convertCoordinates(\n                      updatedScene.avatarPosition,\n                      oldRatio,\n                      newRatio,\n                    );\n                    updatedScene.avatarSize = convertSize(\n                      updatedScene.avatarSize,\n                      oldRatio,\n                      newRatio,\n                    );\n                  }\n\n                  // Конвертируем координаты всех элементов\n                  updatedScene.elements = updatedScene.elements.map((element) => {\n                    const newPosition = convertCoordinates(\n                      { x: element.x, y: element.y },\n                      oldRatio,\n                      newRatio,\n                    );\n                    const newSize = convertSize(\n                      { width: element.width, height: element.height },\n                      oldRatio,\n                      newRatio,\n                    );\n                    return {\n                      ...element,\n                      x: newPosition.x,\n                      y: newPosition.y,\n                      width: newSize.width,\n                      height: newSize.height,\n                    };\n                  });\n\n                  return updatedScene;\n                }),\n              );\n              setAspectRatio(newRatio);\n            }}\n            videoTitle={videoTitle}\n            onVideoTitleChange={setVideoTitle}\n            avatars={avatars}\n            isLoadingAvatars={isLoadingAvatars}\n            voices={voices}\n            isLoadingVoices={isLoadingVoices}\n            scenes={scenes}\n            activeSceneId={activeSceneId}\n            onSelectScene={setActiveSceneId}\n            onAddScene={handleAddScene}\n            onDeleteScene={handleDeleteScene}\n            onSceneVoiceChange={(sceneId, voiceId) => {\n              handleSceneUpdate(sceneId, (scene) => ({ ...scene, voiceId }));\n            }}\n            onSceneScriptChange={(sceneId, script) => {\n              handleSceneUpdate(sceneId, (scene) => ({ ...scene, script }));\n            }}\n            onSceneAvatarChange={(sceneId, avatarId) => {\n              const scene = scenes.find((s) => s.id === sceneId);\n              if (!scene) return;\n              \n              if (avatarId && !scene.avatarPosition) {\n                // При первом добавлении аватара устанавливаем начальную позицию и размер\n                const initialSize = getInitialAvatarSize(aspectRatio);\n                const canvasSize = CANVAS_SIZES[aspectRatio];\n                const maxZIndex = Math.max(...scene.elements.map((el) => el.zIndex ?? 0), 0);\n                handleSceneUpdate(sceneId, (s) => ({\n                  ...s,\n                  avatarId,\n                  avatarPosition: { x: canvasSize.width / 2, y: canvasSize.height / 2 },\n                  avatarSize: initialSize,\n                  avatarZIndex: maxZIndex + 1,\n                }));\n              } else {\n                handleSceneUpdate(sceneId, (s) => ({ ...s, avatarId }));\n              }\n            }}\n            onRefreshAvatars={refreshAvatars}\n            onRefreshVoices={refreshVoices}\n            onApplyCreatedAvatar={(sceneId, avatarId) => {\n              const scene = scenes.find((s) => s.id === sceneId);\n              if (!scene) return;\n              \n              // При применении созданного аватара устанавливаем начальную позицию и размер\n              const initialSize = getInitialAvatarSize(aspectRatio);\n              const canvasSize = CANVAS_SIZES[aspectRatio];\n              const maxZIndex = Math.max(...scene.elements.map((el) => el.zIndex ?? 0), 0);\n              handleSceneUpdate(sceneId, (s) => ({\n                ...s,\n                avatarId,\n                avatarPosition: { x: canvasSize.width / 2, y: canvasSize.height / 2 },\n                avatarSize: initialSize,\n                avatarZIndex: maxZIndex + 1,\n              }));\n            }}\n          />\n        </div>\n\n        <div className=\"flex min-h-0 flex-1 flex-col gap-4\">\n          <div className=\"flex-1 min-h-0\">\n            <CanvasArea\n              aspectRatio={aspectRatio}\n              elements={activeScene?.elements ?? []}\n              avatar={\n                activeScene?.avatarId\n                  ? avatars.find((a) => a.id === activeScene.avatarId) ?? null\n                  : null\n              }\n              avatarPosition={\n                activeScene?.avatarPosition ?? {\n                  x: CANVAS_SIZES[aspectRatio].width / 2,\n                  y: CANVAS_SIZES[aspectRatio].height / 2,\n                }\n              }\n              avatarSize={activeScene?.avatarSize ?? getInitialAvatarSize(aspectRatio)}\n              avatarZIndex={activeScene?.avatarZIndex}\n              avatarLocked={activeScene?.avatarLocked}\n              onElementPositionChange={handleElementPositionChange}\n              onElementSizeChange={handleElementSizeChange}\n              onRemoveElement={handleRemoveElement}\n              onReorderLayers={handleReorderLayers}\n              onAvatarPositionChange={handleAvatarPositionChange}\n              onAvatarSizeChange={handleAvatarSizeChange}\n              onAlignAvatars={handleAlignAvatars}\n              onAddMediaAsset={handleAddMediaAsset}\n              mediaAssets={mediaAssets}\n              onUseMediaAsset={handleAddExistingAssetToScene}\n              onUseMediaAssetAtPosition={(assetId, x, y) => {\n                if (!activeScene) return;\n                const asset = mediaAssets.find((item) => item.id === assetId);\n                if (!asset) return;\n                addAssetToSceneAtPosition(activeScene.id, asset, x, y);\n              }}\n              onRemoveMediaAsset={handleRemoveMediaAsset}\n              onRemoveAvatar={handleRemoveAvatar}\n              onToggleAvatarLock={handleToggleAvatarLock}\n            />\n          </div>\n          <div className=\"min-h-[220px] lg:min-h-[240px]\">\n            <Timeline\n              scenes={scenes}\n              activeSceneId={activeSceneId}\n              onSelectScene={setActiveSceneId}\n              onAddScene={handleAddScene}\n              avatars={avatars}\n              aspectRatio={aspectRatio}\n            />\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6288, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/material/editor/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, Suspense } from \"react\";\nimport { useRouter } from \"next/navigation\";\n\nimport { supabase } from \"@/lib/supabaseClient\";\nimport { MaterialEditor } from \"./components/MaterialEditor\";\n\nfunction MaterialEditorWrapper() {\n  const router = useRouter();\n\n  useEffect(() => {\n    const checkAuth = async () => {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n      if (!user) {\n        router.push(\"/login\");\n      }\n    };\n\n    checkAuth();\n  }, [router]);\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <MaterialEditor />\n    </div>\n  );\n}\n\nexport default function MaterialEditorPage() {\n  return (\n    <Suspense fallback={<div className=\"flex min-h-screen items-center justify-center\">Загрузка...</div>}>\n      <MaterialEditorWrapper />\n    </Suspense>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAEA;AACA;AANA;;;;;;AAQA,SAAS;IACP,MAAM,SAAS,IAAA,+IAAS;IAExB,IAAA,kNAAS,EAAC;QACR,MAAM,YAAY;YAChB,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,iIAAQ,CAAC,IAAI,CAAC,OAAO;YAC/B,IAAI,CAAC,MAAM;gBACT,OAAO,IAAI,CAAC;YACd;QACF;QAEA;IACF,GAAG;QAAC;KAAO;IAEX,qBACE,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC,4KAAc;;;;;;;;;;AAGrB;AAEe,SAAS;IACtB,qBACE,8OAAC,iNAAQ;QAAC,wBAAU,8OAAC;YAAI,WAAU;sBAAgD;;;;;;kBACjF,cAAA,8OAAC;;;;;;;;;;AAGP"}}]
}
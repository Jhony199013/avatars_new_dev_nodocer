{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///G:/apps/Dev/avatars_new/front/app/api/tts-generate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\n\r\nconst WEBHOOK_URL = \"https://rueleven.ru/webhook/d08c47c0-82c3-4b50-a7e0-e1b525c5498b\";\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { voice_id, slide_number, text, uuid } = body;\r\n\r\n    if (!voice_id || !slide_number || !text || !uuid) {\r\n      return NextResponse.json(\r\n        { error: \"Требуются параметры voice_id, slide_number, text и uuid\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    // Отправляем вебхук и ждем, пока n8n вернет success === true\r\n    const response = await fetch(WEBHOOK_URL, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        voice_id,\r\n        slide_number,\r\n        text,\r\n        uuid,\r\n      }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`);\r\n    }\r\n\r\n    // Ожидаем подтверждение от n8n, что файл готов: [{ \"success\": true }] или { \"success\": true }\r\n    let json: unknown;\r\n    try {\r\n      json = await response.json();\r\n    } catch {\r\n      throw new Error(\"Некорректный JSON ответ от вебхука\");\r\n    }\r\n\r\n    let success = false;\r\n    if (Array.isArray(json) && json.length > 0 && typeof json[0] === \"object\" && json[0] !== null) {\r\n      success = Boolean((json[0] as { success?: unknown }).success);\r\n    } else if (json && typeof json === \"object\") {\r\n      success = Boolean((json as { success?: unknown }).success);\r\n    }\r\n\r\n    if (!success) {\r\n      console.error(\"Неожиданный ответ вебхука, ожидали success=true:\", json);\r\n      return NextResponse.json(\r\n        { error: \"Вебхук не вернул success=true, аудио может быть не готово\" },\r\n        { status: 500 },\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error) {\r\n    console.error(\"Ошибка при отправке вебхука:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        error: error instanceof Error ? error.message : \"Не удалось отправить вебхук\",\r\n      },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,cAAc;AAEb,MAAM,UAAU;AAChB,MAAM,UAAU;AAEhB,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,QAAQ,EAAE,YAAY,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG;QAE/C,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,QAAQ,CAAC,MAAM;YAChD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0D,GACnE;gBAAE,QAAQ;YAAI;QAElB;QAEA,6DAA6D;QAC7D,MAAM,WAAW,MAAM,MAAM,aAAa;YACxC,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB;gBACA;gBACA;gBACA;YACF;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,SAAS,MAAM,EAAE;QAC1D;QAEA,8FAA8F;QAC9F,IAAI;QACJ,IAAI;YACF,OAAO,MAAM,SAAS,IAAI;QAC5B,EAAE,OAAM;YACN,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,UAAU;QACd,IAAI,MAAM,OAAO,CAAC,SAAS,KAAK,MAAM,GAAG,KAAK,OAAO,IAAI,CAAC,EAAE,KAAK,YAAY,IAAI,CAAC,EAAE,KAAK,MAAM;YAC7F,UAAU,QAAQ,AAAC,IAAI,CAAC,EAAE,CAA2B,OAAO;QAC9D,OAAO,IAAI,QAAQ,OAAO,SAAS,UAAU;YAC3C,UAAU,QAAQ,AAAC,KAA+B,OAAO;QAC3D;QAEA,IAAI,CAAC,SAAS;YACZ,QAAQ,KAAK,CAAC,oDAAoD;YAClE,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4D,GACrE;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAClD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}